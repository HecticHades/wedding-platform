// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

generator jsonTypes {
  provider = "node node_modules/prisma-json-types-generator"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// Auth.js / NextAuth models
// ============================================

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  hashedPassword String?
  name           String?
  emailVerified  DateTime?
  image          String?
  role           String    @default("couple") // "admin" or "couple"
  tenantId       String?   @unique
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  tenant         Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  accounts       Account[]
  sessions       Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// Core platform models
// ============================================

model Tenant {
  id           String    @id @default(cuid())
  subdomain    String    @unique
  customDomain String?   @unique
  name         String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  wedding      Wedding?
  user         User?
}

model Wedding {
  id           String    @id @default(cuid())
  tenantId     String    @unique
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  partner1Name String
  partner2Name String
  weddingDate  DateTime?
  rsvpCode     String?   @unique

  // Template and theme settings
  templateId      String  @default("classic")
  /// [ThemeSettings]
  themeSettings   Json    @default("{}")
  /// [ContentSection[]]
  contentSections Json    @default("[]")
  /// [PaymentSettings]
  paymentSettings Json    @default("{}")

  // Photo sharing settings
  photoSharingEnabled Boolean @default(false)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  guests             Guest[]
  events             Event[]
  giftItems          GiftItem[]
  externalRegistries ExternalRegistry[]
  guestPhotos        GuestPhoto[]
  broadcastMessages  BroadcastMessage[]
  tables             Table[]

  @@index([tenantId])
}

// RSVP status enum for EventGuest responses
enum RsvpStatus {
  PENDING
  ATTENDING
  DECLINED
  MAYBE
}

// Photo moderation status for guest uploads
enum PhotoStatus {
  PENDING    // Awaiting couple review
  APPROVED   // Visible in gallery
  REJECTED   // Hidden from gallery
}

// Broadcast message status for guest messaging
enum MessageStatus {
  PENDING    // Scheduled but not yet sent
  SENT       // Successfully delivered to Resend
  CANCELLED  // Cancelled before sending
  FAILED     // Failed to send
}

model Guest {
  id        String   @id @default(cuid())
  weddingId String
  wedding   Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  name      String
  email     String?
  phone     String?

  // Household/party grouping
  partyName    String?           // e.g., "The Smith Family"
  partySize    Int      @default(1)
  allowPlusOne Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  eventInvitations EventGuest[]
  seatAssignment   SeatAssignment?

  @@index([weddingId])
  @@index([weddingId, email])
}

model Event {
  id        String   @id @default(cuid())
  weddingId String
  wedding   Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  name        String
  description String?
  dateTime    DateTime
  endTime     DateTime?
  location    String?          // Venue name
  address     String?          // Full address
  dressCode   String?
  isPublic    Boolean  @default(true)
  order       Int      @default(0)  // Custom display ordering
  /// [MealOption[]]
  mealOptions Json     @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  guestInvitations EventGuest[]

  @@index([weddingId])
  @@index([weddingId, dateTime])
}

model EventGuest {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  guestId   String
  guest     Guest    @relation(fields: [guestId], references: [id], onDelete: Cascade)

  invitedAt DateTime @default(now())

  // RSVP fields (prepared for Phase 5, nullable for now)
  rsvpStatus   RsvpStatus?
  rsvpAt       DateTime?
  plusOneCount Int?
  plusOneName  String?
  mealChoice   String?
  dietaryNotes String?

  @@unique([eventId, guestId])
  @@index([eventId])
  @@index([guestId])
}

model GiftItem {
  id          String   @id @default(cuid())
  weddingId   String
  wedding     Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  name        String
  description String?
  targetAmount Decimal  @db.Decimal(10, 2)
  imageUrl    String?
  order       Int      @default(0)

  // Claiming
  isClaimed   Boolean  @default(false)
  claimedBy   String?
  claimedAt   DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([weddingId])
  @@index([weddingId, isClaimed])
}

model ExternalRegistry {
  id          String   @id @default(cuid())
  weddingId   String
  wedding     Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  name        String
  url         String
  description String?
  order       Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([weddingId])
}

model GuestPhoto {
  id          String      @id @default(cuid())
  weddingId   String
  wedding     Wedding     @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  url         String              // Vercel Blob URL
  caption     String?             // Optional caption from guest
  uploadedBy  String?             // Guest name (optional)

  // Moderation
  status      PhotoStatus @default(PENDING)
  reviewedAt  DateTime?

  // Metadata
  uploadedAt  DateTime    @default(now())

  @@index([weddingId])
  @@index([weddingId, status])
}

model BroadcastMessage {
  id           String        @id @default(cuid())
  weddingId    String
  wedding      Wedding       @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  subject      String
  content      String        @db.Text     // HTML content from textarea

  // Scheduling
  scheduledFor DateTime?                  // null = sent immediately
  sentAt       DateTime?                  // When actually sent/delivered to Resend
  status       MessageStatus @default(PENDING)

  // Resend tracking - store email IDs for cancellation
  resendEmailIds String[]                 // Array of Resend email IDs
  recipientCount Int

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([weddingId])
  @@index([weddingId, status])
}

// ============================================
// Seating Chart models
// ============================================

model Table {
  id        String   @id @default(cuid())
  weddingId String
  wedding   Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  name      String   // "Table 1", "Head Table", etc.
  capacity  Int      // Maximum seats (headcount including plus-ones)

  order     Int      @default(0)  // Display ordering

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  seatAssignments SeatAssignment[]

  @@index([weddingId])
}

model SeatAssignment {
  id        String   @id @default(cuid())
  tableId   String
  table     Table    @relation(fields: [tableId], references: [id], onDelete: Cascade)
  guestId   String   @unique  // Guest can only be at one table
  guest     Guest    @relation(fields: [guestId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@unique([tableId, guestId])
  @@index([tableId])
  @@index([guestId])
}
