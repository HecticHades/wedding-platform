---
phase: 04-event-guest-management
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - src/app/(platform)/dashboard/events/[id]/guests/page.tsx
  - src/app/(platform)/dashboard/events/actions.ts
  - src/components/events/EventGuestManager.tsx
  - src/app/[domain]/page.tsx
  - src/lib/events/event-utils.ts
  - src/app/(platform)/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Couple can assign guests to specific events"
    - "Couple can see which guests are invited to each event"
    - "Guest visiting wedding site sees only events they have access to"
    - "Public events are visible to all guests"
    - "Private (invite-only) events are only visible to invited guests"
  artifacts:
    - path: "src/app/(platform)/dashboard/events/[id]/guests/page.tsx"
      provides: "Event guest assignment page"
      min_lines: 30
    - path: "src/components/events/EventGuestManager.tsx"
      provides: "Guest invitation checkbox list component"
      min_lines: 60
    - path: "src/lib/events/event-utils.ts"
      provides: "getVisibleEvents utility for filtering by guest access"
      exports: ["getVisibleEvents"]
  key_links:
    - from: "src/app/(platform)/dashboard/events/[id]/guests/page.tsx"
      to: "src/app/(platform)/dashboard/events/actions.ts"
      via: "updateEventInvitations server action"
      pattern: "updateEventInvitations"
    - from: "src/app/[domain]/page.tsx"
      to: "src/lib/events/event-utils.ts"
      via: "getVisibleEvents filter"
      pattern: "getVisibleEvents"
---

<objective>
Build the event-guest invitation assignment system and public site event visibility.

Purpose: Enable couples to control which guests see which events, completing the core event management workflow.
Output: Event guest manager UI, invitation server actions, public site event filtering.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/04-event-guest-management/04-RESEARCH.md

@wedding-platform/src/app/(platform)/dashboard/events/actions.ts
@wedding-platform/src/app/[domain]/page.tsx
@wedding-platform/src/lib/db/prisma.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create invitation server actions and event utilities</name>
  <files>
    src/app/(platform)/dashboard/events/actions.ts
    src/lib/events/event-utils.ts
  </files>
  <action>
**Add to events/actions.ts** (append to existing file from Plan 02):

**updateEventInvitations(eventId: string, guestIds: string[])**
- Auth check with session.user.tenantId
- Validate eventId is non-empty, guestIds is an array of strings
- Use withTenantContext to verify event belongs to tenant
- Use $transaction for atomicity:
  1. Delete all existing EventGuest records for this eventId
  2. Create new EventGuest records for each guestId
- revalidatePath for event guests page
- Return { success: true } or { success: false, error }

**inviteGuestToEvent(eventId: string, guestId: string)**
- Auth check
- Use upsert to add invitation if not exists
- revalidatePath

**removeGuestFromEvent(eventId: string, guestId: string)**
- Auth check
- Delete the EventGuest record
- revalidatePath

**Create src/lib/events/event-utils.ts**:

**getVisibleEvents({ weddingId, guestId? })**
- Fetch all events for the wedding ordered by dateTime
- If guestId is provided:
  - Include guestInvitations where guestId matches
  - Filter to events where isPublic=true OR guest has invitation
- If no guestId (anonymous visitor):
  - Filter to events where isPublic=true only
- Return filtered event array with all event fields

This utility will be used by both dashboard (showing invitation status) and public site (filtering visible events).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Invitation actions and getVisibleEvents utility implemented with proper tenant isolation</done>
</task>

<task type="auto">
  <name>Task 2: Create EventGuestManager component and assignment page</name>
  <files>
    src/components/events/EventGuestManager.tsx
    src/app/(platform)/dashboard/events/[id]/guests/page.tsx
  </files>
  <action>
**EventGuestManager.tsx** (client component):
- Props: eventId, eventName, allGuests array, invitedGuestIds array
- State: selected Set<string> initialized from invitedGuestIds
- State: hasChanges boolean to track unsaved changes
- Display:
  - Header: "Manage Invitations for [Event Name]"
  - Summary: "X of Y guests invited"
  - Quick actions: "Select All", "Select None" buttons
  - Scrollable list of guests with checkboxes
  - Each row shows guest name, email, check/X icon for invited status
- On checkbox change: toggle guest in selected set, set hasChanges=true
- Save button (only visible when hasChanges):
  - Call updateEventInvitations with Array.from(selected)
  - Show loading state with useTransition
  - Reset hasChanges on success

**events/[id]/guests/page.tsx** (server component):
- Auth check, redirect if no session/tenantId
- Fetch event by id with withTenantContext
- If event not found, redirect to /dashboard/events
- Fetch all guests for the wedding
- Fetch current invitations for this event (EventGuest where eventId)
- Extract invited guest IDs into array
- Render EventGuestManager with props
- Breadcrumb: Dashboard > Events > [Event Name] > Manage Guests
- Back link to event detail page

Style consistently with existing components.
  </action>
  <verify>Navigate to /dashboard/events/[id]/guests - page renders with guest checkboxes</verify>
  <done>Event guest manager page allows assigning guests to events with bulk save</done>
</task>

<task type="auto">
  <name>Task 3: Update public site and dashboard with event visibility</name>
  <files>
    src/app/[domain]/page.tsx
    src/app/(platform)/dashboard/page.tsx
  </files>
  <action>
**Update src/app/[domain]/page.tsx** (public wedding site):
- Import getVisibleEvents from @/lib/events/event-utils
- After fetching wedding, call getVisibleEvents({ weddingId: wedding.id })
  - Note: No guestId yet (guest identification comes in Phase 5 with RSVP code)
  - This returns only public events for now
- Pass events to the page rendering
- In the Event Details content section (if visible), display the events:
  - Each event: name, formatted date/time, location, address, dressCode if set
  - If no public events, show "Event details coming soon" or similar
- Style events consistently with the theme

**Update src/app/(platform)/dashboard/page.tsx**:
- Replace the placeholder "Manage Guests (Coming in Phase 4)" span with a real Link:
  ```tsx
  <Link
    href="/dashboard/guests"
    className="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors"
  >
    Manage Guests
  </Link>
  ```
- Add "Manage Events" link:
  ```tsx
  <Link
    href="/dashboard/events"
    className="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors"
  >
    Manage Events
  </Link>
  ```
- Update the stats cards to show more useful information:
  - Guests card: show total attendees (sum of partySize) in addition to guest count
  - Events card: show next upcoming event date if exists

The dashboard quick actions should now have: Templates, Theme, Content, Events, Guests, and placeholder for RSVPs.
  </action>
  <verify>
1. Public site shows public events in Event Details section
2. Dashboard has working links to /dashboard/events and /dashboard/guests
3. TypeScript compiles without errors
  </verify>
  <done>Public site filters events by visibility, dashboard links to event/guest management</done>
</task>

</tasks>

<verification>
1. Navigate to /dashboard/events/[id] - see "Manage Guest Invitations" link
2. Click to go to /dashboard/events/[id]/guests - see all guests with checkboxes
3. Check some guests, click Save - invitations saved
4. Navigate back - invited count updates
5. Visit public site (subdomain) - see only public events
6. Mark an event as private - it disappears from public site
7. Dashboard quick actions include Events and Guests links
8. TypeScript compiles without errors
</verification>

<success_criteria>
- Event guest manager shows all wedding guests with checkboxes
- Selecting/deselecting guests and saving updates EventGuest records
- Bulk operations (select all, select none) work
- Public wedding site shows only public events (guest-specific visibility in Phase 5)
- Private events hidden from anonymous visitors
- Dashboard has working navigation to events and guests management
- Changes are atomic (transaction ensures all-or-nothing saves)
</success_criteria>

<output>
After completion, create `.planning/phases/04-event-guest-management/04-04-SUMMARY.md`
</output>
