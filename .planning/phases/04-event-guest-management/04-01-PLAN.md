---
phase: 04-event-guest-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/db/prisma.ts
  - src/types/prisma-json.d.ts
autonomous: true

must_haves:
  truths:
    - "Guest and Event models exist with proper relations"
    - "EventGuest join table links guests to events with RSVP metadata fields"
    - "Database queries for Guest, Event, EventGuest are automatically tenant-scoped"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Guest, Event, EventGuest models with relations"
      contains: "model EventGuest"
    - path: "src/lib/db/prisma.ts"
      provides: "Tenant isolation for new models"
      contains: "eventGuest:"
  key_links:
    - from: "prisma/schema.prisma"
      to: "src/lib/db/prisma.ts"
      via: "Prisma client extension uses models defined in schema"
      pattern: "eventGuest:"
---

<objective>
Extend the database schema with complete Guest, Event, and EventGuest models for multi-event guest management.

Purpose: Enable couples to manage multiple events with per-event guest invitations - the data foundation for RSVP in Phase 5.
Output: Updated Prisma schema with migrations applied, Prisma client extension with tenant isolation for new models.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/04-event-guest-management/04-RESEARCH.md

@wedding-platform/prisma/schema.prisma
@wedding-platform/src/lib/db/prisma.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Prisma schema with complete Guest, Event, and EventGuest models</name>
  <files>prisma/schema.prisma</files>
  <action>
Update the existing Guest and Event models and add the EventGuest join table:

**Update Guest model** (currently basic, needs enhancement):
- Add partyName (String?, for household grouping like "The Smith Family")
- Add partySize (Int, default 1)
- Add allowPlusOne (Boolean, default false)
- Add eventInvitations relation to EventGuest[]
- Add index on [weddingId, email] for lookups

**Update Event model** (currently basic, needs enhancement):
- Add description (String?)
- Add endTime (DateTime?)
- Add address (String?, separate from location/venue name)
- Add dressCode (String?)
- Add order (Int, default 0, for custom display ordering)
- Add guestInvitations relation to EventGuest[]
- Add index on [weddingId, dateTime] for chronological queries

**Add EventGuest join table** (new model):
- id (String @id @default(cuid()))
- eventId, guestId with relations (onDelete: Cascade)
- invitedAt (DateTime @default(now()))
- RSVP fields (prepared for Phase 5, nullable for now):
  - rsvpStatus (RsvpStatus? enum)
  - rsvpAt (DateTime?)
  - plusOneCount (Int?)
  - plusOneName (String?)
  - mealChoice (String?)
  - dietaryNotes (String?)
- @@unique([eventId, guestId]) to prevent duplicate invitations
- @@index([eventId]) and @@index([guestId]) for efficient lookups

**Add RsvpStatus enum**:
- PENDING, ATTENDING, DECLINED, MAYBE

Ensure all models have proper cascade deletes and foreign key constraints.
  </action>
  <verify>Run `npx prisma validate` in wedding-platform directory - should exit with no errors</verify>
  <done>Schema validates successfully with all models, relations, and indexes defined</done>
</task>

<task type="auto">
  <name>Task 2: Apply database migration</name>
  <files>prisma/migrations/*</files>
  <action>
Generate and apply the Prisma migration for the schema changes:

1. Run `npx prisma migrate dev --name event_guest_management` to:
   - Generate migration SQL
   - Apply to development database
   - Regenerate Prisma client

2. The migration should:
   - Add new columns to Guest (partyName, partySize, allowPlusOne)
   - Add new columns to Event (description, endTime, address, dressCode, order)
   - Create EventGuest table with all columns and constraints
   - Create RsvpStatus enum

3. Verify the migration applied successfully by checking Prisma client types are updated.

Note: Existing Guest and Event records will remain intact. New columns have defaults or are nullable.
  </action>
  <verify>Run `npx prisma migrate status` - should show "Database schema is up to date"</verify>
  <done>Migration applied, Prisma client regenerated, existing data preserved</done>
</task>

<task type="auto">
  <name>Task 3: Extend Prisma client with tenant isolation for new models</name>
  <files>src/lib/db/prisma.ts</files>
  <action>
Add tenant isolation to the Prisma client extension for the EventGuest model:

Add `eventGuest` to the query extensions object:

```typescript
eventGuest: {
  async findMany({ args, query }) {
    const tenantId = getTenantContext();
    if (tenantId) {
      args.where = {
        ...args.where,
        event: { wedding: { tenantId } },
      };
    }
    return query(args);
  },
  async findFirst({ args, query }) {
    const tenantId = getTenantContext();
    if (tenantId) {
      args.where = {
        ...args.where,
        event: { wedding: { tenantId } },
      };
    }
    return query(args);
  },
  async delete({ args, query }) {
    // Tenant validation happens via the foreign key to event
    // The event model's tenant isolation ensures cross-tenant access is prevented
    return query(args);
  },
  async deleteMany({ args, query }) {
    const tenantId = getTenantContext();
    if (tenantId) {
      args.where = {
        ...args.where,
        event: { wedding: { tenantId } },
      };
    }
    return query(args);
  },
},
```

Also update the existing `guest` and `event` extensions to include `findFirst`, `update`, `delete`, and `deleteMany` operations with tenant scoping (similar patterns as wedding model).

This ensures ALL queries against these models are automatically filtered by tenant.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit` in wedding-platform directory</verify>
  <done>Prisma client extension includes tenant isolation for guest, event, and eventGuest operations</done>
</task>

</tasks>

<verification>
1. Schema validation: `npx prisma validate` passes
2. Migration status: `npx prisma migrate status` shows up to date
3. TypeScript: `npx tsc --noEmit` passes
4. Prisma Studio: `npx prisma studio` shows Guest, Event, EventGuest tables with correct columns
</verification>

<success_criteria>
- Guest model has partyName, partySize, allowPlusOne, eventInvitations relation
- Event model has description, endTime, address, dressCode, order, guestInvitations relation
- EventGuest join table exists with RSVP fields (nullable), unique constraint on [eventId, guestId]
- RsvpStatus enum defined with PENDING, ATTENDING, DECLINED, MAYBE
- All tenant-scoped queries work through Prisma client extension
- Existing wedding data is preserved after migration
</success_criteria>

<output>
After completion, create `.planning/phases/04-event-guest-management/04-01-SUMMARY.md`
</output>
