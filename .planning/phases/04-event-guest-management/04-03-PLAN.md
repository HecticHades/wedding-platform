---
phase: 04-event-guest-management
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/(platform)/dashboard/guests/page.tsx
  - src/app/(platform)/dashboard/guests/new/page.tsx
  - src/app/(platform)/dashboard/guests/[id]/page.tsx
  - src/app/(platform)/dashboard/guests/actions.ts
  - src/components/guests/GuestList.tsx
  - src/components/guests/GuestForm.tsx
  - src/components/guests/GuestCard.tsx
autonomous: true

must_haves:
  truths:
    - "Couple can view list of all guests for their wedding"
    - "Couple can add a new guest with name, email, phone, party info"
    - "Couple can edit existing guest details"
    - "Couple can delete a guest"
    - "Guest list is searchable by name or email"
  artifacts:
    - path: "src/app/(platform)/dashboard/guests/page.tsx"
      provides: "Guest list page with add button and search"
      min_lines: 30
    - path: "src/app/(platform)/dashboard/guests/actions.ts"
      provides: "createGuest, updateGuest, deleteGuest server actions"
      exports: ["createGuest", "updateGuest", "deleteGuest"]
    - path: "src/components/guests/GuestForm.tsx"
      provides: "Guest creation/editing form component"
      min_lines: 60
  key_links:
    - from: "src/app/(platform)/dashboard/guests/page.tsx"
      to: "prisma.guest.findMany"
      via: "withTenantContext query"
      pattern: "prisma\\.guest\\."
    - from: "src/components/guests/GuestForm.tsx"
      to: "src/app/(platform)/dashboard/guests/actions.ts"
      via: "form action submission"
      pattern: "createGuest|updateGuest"
---

<objective>
Build the guest management UI for couples to create and manage their guest list.

Purpose: Enable couples to build their guest list with contact info and party groupings.
Output: Guest list page, guest form, server actions for guest CRUD.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/04-event-guest-management/04-RESEARCH.md

@wedding-platform/src/app/(platform)/dashboard/content/actions.ts
@wedding-platform/src/app/(platform)/dashboard/content/page.tsx
@wedding-platform/src/lib/auth/auth.ts
@wedding-platform/src/lib/db/prisma.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create guest server actions</name>
  <files>src/app/(platform)/dashboard/guests/actions.ts</files>
  <action>
Create server actions for guest CRUD operations:

**createGuest(formData: FormData)**
- Auth check with session.user.tenantId
- Zod validation schema:
  - name: string (required, min 1 char)
  - email: string (optional, valid email format or empty)
  - phone: string (optional)
  - partyName: string (optional, e.g., "The Smith Family")
  - partySize: number (int, min 1, default 1)
  - allowPlusOne: boolean (default false)
- Use withTenantContext to get wedding.id
- Create guest with prisma.guest.create
- revalidatePath("/dashboard/guests")
- Return { success: true, guestId } or { success: false, error }

**updateGuest(guestId: string, formData: FormData)**
- Same validation as createGuest
- Use withTenantContext
- Verify guest belongs to tenant's wedding before updating
- Update guest with prisma.guest.update
- revalidatePath for both list and detail page

**deleteGuest(guestId: string)**
- Auth check
- withTenantContext
- Delete with prisma.guest.delete (cascades to EventGuest records)
- revalidatePath

Handle the email field carefully: if empty string, store as null. Validate email format only if provided.

Use "use server" directive. Handle errors gracefully with try/catch.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` in wedding-platform directory</verify>
  <done>All three guest server actions implemented with proper tenant isolation and validation</done>
</task>

<task type="auto">
  <name>Task 2: Create guest components</name>
  <files>
    src/components/guests/GuestList.tsx
    src/components/guests/GuestCard.tsx
    src/components/guests/GuestForm.tsx
  </files>
  <action>
Create three components for guest management:

**GuestCard.tsx** (client component):
- Props: guest object, onEdit callback, onDelete callback
- Display: guest name, email (if present), phone (if present)
- Show party info: partyName, partySize indicator, plus-one badge if allowed
- Actions: Edit button, Delete button with confirmation
- Use lucide-react icons (User, Mail, Phone, Users)

**GuestList.tsx** (client component):
- Props: guests array
- Search input for filtering by name or email (client-side)
- Display total guest count and party size sum
- Empty state: "No guests yet. Add your first guest to get started."
- Link to add new guest
- Map over guests to render GuestCards
- Sort alphabetically by name

**GuestForm.tsx** (client component):
- Props: optional guest object (for editing), optional onSuccess callback
- Fields:
  - Guest Name (required input)
  - Email (optional, type=email)
  - Phone (optional, type=tel)
  - Party Name (optional, for households like "The Smith Family")
  - Party Size (number input, min 1, default 1)
  - Allow Plus-One (checkbox)
- Submit button: "Add Guest" or "Save Changes"
- Cancel button that navigates back
- Use useTransition for pending state
- Clear form on successful create (if not editing)

Follow the styling patterns from existing components (Tailwind classes from content builder).
  </action>
  <verify>Components render without errors</verify>
  <done>GuestCard, GuestList, and GuestForm components created with consistent styling</done>
</task>

<task type="auto">
  <name>Task 3: Create guest management pages</name>
  <files>
    src/app/(platform)/dashboard/guests/page.tsx
    src/app/(platform)/dashboard/guests/new/page.tsx
    src/app/(platform)/dashboard/guests/[id]/page.tsx
  </files>
  <action>
Create the guest management pages:

**guests/page.tsx** (server component):
- Auth check, redirect if no session or tenantId
- Fetch guests with withTenantContext and prisma.guest.findMany
- Order by name ascending (alphabetical)
- Include eventInvitations count for each guest (for future display)
- Calculate total party size (sum of all partySize values)
- Render GuestList component with fetched guests
- Include "Add Guest" button linking to /dashboard/guests/new
- Show summary: "X guests (Y total attendees)" where Y accounts for party sizes

**guests/new/page.tsx** (server component):
- Auth check
- Render GuestForm component in create mode (no guest prop)
- Page title: "Add Guest"
- Breadcrumb: Dashboard > Guests > Add

**guests/[id]/page.tsx** (server component):
- Auth check
- Fetch single guest with withTenantContext and prisma.guest.findFirst({ where: { id: params.id } })
- Include eventInvitations with event names (for display, prep for Plan 04)
- If not found, redirect to /dashboard/guests or show 404
- Render GuestForm component with guest prop for editing
- Page title: "Edit Guest"
- Breadcrumb: Dashboard > Guests > [Guest Name]
- Show which events this guest is invited to (read-only, managed in Plan 04)

Follow the page structure patterns from events pages.
  </action>
  <verify>Pages load without errors: navigate to /dashboard/guests in browser</verify>
  <done>Guest list, create, and edit pages render correctly with proper routing</done>
</task>

</tasks>

<verification>
1. Navigate to /dashboard/guests - see empty state or guest list
2. Click "Add Guest" - form renders with all fields
3. Submit form - guest created, redirected to list, guest appears
4. Search for guest by name - list filters correctly
5. Click edit on guest - form pre-filled with guest data
6. Save changes - guest updated in list
7. Delete guest - confirmation, guest removed from list
8. Guest count shows party sizes correctly
9. TypeScript compiles without errors
</verification>

<success_criteria>
- Guests page shows all guests for the couple's wedding
- Create guest form captures all fields (name, email, phone, partyName, partySize, allowPlusOne)
- Edit guest pre-populates form with existing values
- Delete guest removes it and cascades to EventGuest records
- Guest list is searchable by name or email
- Total attendee count reflects party sizes
- Tenant isolation prevents accessing other couples' guests
- UI follows established Tailwind styling patterns
</success_criteria>

<output>
After completion, create `.planning/phases/04-event-guest-management/04-03-SUMMARY.md`
</output>
