---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - tailwind.config.ts
  - src/app/layout.tsx
  - src/app/page.tsx
  - src/app/globals.css
  - src/lib/utils.ts
  - prisma/schema.prisma
  - src/middleware.ts
  - src/app/[domain]/page.tsx
  - src/app/[domain]/layout.tsx
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Next.js application starts and serves pages without errors"
    - "Wedding data persists correctly with tenant relationships"
    - "Subdomain requests display tenant-specific content"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies"
      contains: "next"
    - path: "prisma/schema.prisma"
      provides: "Database schema with tenant model"
      contains: "model Tenant"
    - path: "src/middleware.ts"
      provides: "Subdomain routing logic"
      contains: "middleware"
    - path: "src/app/[domain]/page.tsx"
      provides: "Dynamic tenant route"
      contains: "domain"
  key_links:
    - from: "src/middleware.ts"
      to: "src/app/[domain]/page.tsx"
      via: "URL rewrite to dynamic route"
      pattern: "NextResponse.rewrite"
---

<objective>
Set up the foundational Next.js application with multi-tenant database schema and subdomain routing middleware.

Purpose: Establish the core infrastructure that all subsequent features will build upon - the project structure, database models, and tenant routing mechanism.
Output: Running Next.js app with Prisma schema and middleware that routes subdomain requests to tenant-specific pages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js project with dependencies</name>
  <files>
    package.json
    tsconfig.json
    tailwind.config.ts
    src/app/layout.tsx
    src/app/page.tsx
    src/app/globals.css
    src/lib/utils.ts
    .env.example
  </files>
  <action>
Create a new Next.js 15 project in the repository root (not a subdirectory - this IS the wedding platform project):

```bash
npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --no-turbo --import-alias "@/*"
```

If prompted about existing files, allow overwriting (the repo is currently empty except for .planning/).

After creation, install additional dependencies:
```bash
npm install @prisma/client @neondatabase/serverless clsx tailwind-merge
npm install -D prisma
```

Create `src/lib/utils.ts` with the `cn()` utility function for Tailwind class merging:
```typescript
import { type ClassValue, clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
```

Create `.env.example` with required environment variables (no actual secrets):
```
DATABASE_URL=postgresql://user:password@host/database?sslmode=require
NEXT_PUBLIC_ROOT_DOMAIN=localhost:3000
```

Verify the app starts: `npm run dev`
  </action>
  <verify>
- `npm run dev` starts without errors
- Visit http://localhost:3000 shows Next.js default page
- `src/lib/utils.ts` exists with cn function
  </verify>
  <done>Next.js 15 project running with all required dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Create Prisma schema with multi-tenant models</name>
  <files>
    prisma/schema.prisma
  </files>
  <action>
Initialize Prisma:
```bash
npx prisma init
```

Replace the generated `prisma/schema.prisma` with the multi-tenant schema:

```prisma
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model Tenant {
  id           String    @id @default(cuid())
  subdomain    String    @unique
  customDomain String?   @unique
  name         String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  wedding      Wedding?
}

model Wedding {
  id           String    @id @default(cuid())
  tenantId     String    @unique
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  partner1Name String
  partner2Name String
  weddingDate  DateTime?
  rsvpCode     String?   @unique

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  guests       Guest[]
  events       Event[]

  @@index([tenantId])
}

model Guest {
  id        String   @id @default(cuid())
  weddingId String
  wedding   Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  name      String
  email     String?
  phone     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([weddingId])
}

model Event {
  id        String   @id @default(cuid())
  weddingId String
  wedding   Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  name      String
  dateTime  DateTime
  location  String?
  isPublic  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([weddingId])
}
```

Generate the Prisma client:
```bash
npx prisma generate
```

Note: Database push/migration will be done once DATABASE_URL is configured. For now, schema is ready.
  </action>
  <verify>
- `prisma/schema.prisma` contains Tenant, Wedding, Guest, Event models
- `npx prisma generate` completes without errors
- `npx prisma validate` shows schema is valid
  </verify>
  <done>Prisma schema defines multi-tenant data model with tenant isolation via foreign keys</done>
</task>

<task type="auto">
  <name>Task 3: Implement subdomain routing middleware</name>
  <files>
    src/middleware.ts
    src/app/[domain]/page.tsx
    src/app/[domain]/layout.tsx
  </files>
  <action>
Create `src/middleware.ts` to extract subdomain and rewrite requests:

```typescript
import { NextRequest, NextResponse } from 'next/server';

export const config = {
  matcher: [
    // Match all paths except static files, api routes, and Next.js internals
    '/((?!api|_next/static|_next/image|favicon.ico|robots.txt|sitemap.xml).*)',
  ],
};

export default function middleware(req: NextRequest) {
  const url = req.nextUrl;
  const hostname = req.headers.get('host') || '';

  // Define root domain (supports localhost for development)
  const rootDomain = process.env.NEXT_PUBLIC_ROOT_DOMAIN || 'localhost:3000';

  // Extract subdomain
  let subdomain: string | null = null;

  // Production: alice-bob.weddingplatform.com -> alice-bob
  if (hostname.endsWith(`.${rootDomain}`) && !hostname.startsWith('www.')) {
    subdomain = hostname.replace(`.${rootDomain}`, '');
  }

  // Development: alice-bob.localhost:3000 -> alice-bob
  if (hostname.includes('localhost') && hostname !== 'localhost:3000' && hostname !== 'localhost') {
    subdomain = hostname.split('.')[0];
  }

  // No subdomain = main platform site
  if (!subdomain) {
    return NextResponse.next();
  }

  // Rewrite to dynamic [domain] route
  const newUrl = new URL(`/${subdomain}${url.pathname}`, req.url);
  return NextResponse.rewrite(newUrl);
}
```

Create `src/app/[domain]/layout.tsx`:

```typescript
export default function TenantLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return children;
}
```

Create `src/app/[domain]/page.tsx`:

```typescript
interface PageProps {
  params: Promise<{ domain: string }>;
}

export default async function TenantHomePage({ params }: PageProps) {
  const { domain } = await params;

  return (
    <main className="min-h-screen flex flex-col items-center justify-center p-4">
      <h1 className="text-2xl font-bold md:text-4xl mb-4">
        Wedding Site: {domain}
      </h1>
      <p className="text-gray-600">
        This is a placeholder for the wedding site with subdomain: {domain}
      </p>
      <p className="text-sm text-gray-400 mt-4">
        (Tenant lookup will be implemented in Plan 02)
      </p>
    </main>
  );
}
```

Update `src/app/page.tsx` to be the main platform landing page:

```typescript
export default function Home() {
  return (
    <main className="min-h-screen flex flex-col items-center justify-center p-4">
      <h1 className="text-3xl font-bold md:text-5xl mb-4">
        Wedding Website Platform
      </h1>
      <p className="text-gray-600 text-center max-w-md">
        Create beautiful wedding websites for your special day.
      </p>
      <p className="text-sm text-gray-400 mt-8">
        (Platform dashboard will be built in Phase 2)
      </p>
    </main>
  );
}
```
  </action>
  <verify>
To test subdomain routing locally, add to hosts file:
- Windows: `C:\Windows\System32\drivers\etc\hosts`
- macOS/Linux: `/etc/hosts`

Add line: `127.0.0.1 test-wedding.localhost`

Then:
- `npm run dev`
- Visit http://localhost:3000 - see "Wedding Website Platform"
- Visit http://test-wedding.localhost:3000 - see "Wedding Site: test-wedding"
  </verify>
  <done>Subdomain routing middleware extracts tenant from hostname and rewrites to dynamic route</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run dev` starts without errors
2. http://localhost:3000 shows main platform page
3. http://test-wedding.localhost:3000 shows tenant-specific page with subdomain displayed
4. `npx prisma validate` confirms schema is valid
5. All files exist in expected locations
</verification>

<success_criteria>
- Next.js 15 application running with TypeScript and Tailwind CSS
- Prisma schema defines Tenant, Wedding, Guest, Event models with proper relationships
- Middleware correctly extracts subdomain and routes to [domain] dynamic route
- Main platform and tenant sites render at correct URLs
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
