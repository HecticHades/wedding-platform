---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/components/layout/ResponsiveContainer.tsx
  - src/components/layout/Header.tsx
  - src/components/layout/Footer.tsx
  - src/app/layout.tsx
  - src/app/[domain]/layout.tsx
  - tests/load/wedding-site.js
  - package.json
autonomous: false

must_haves:
  truths:
    - "Mobile viewport renders correctly on phone, tablet, and desktop"
    - "Static assets load via CDN with cache headers"
    - "Load test demonstrates handling 100 concurrent users"
  artifacts:
    - path: "src/components/layout/ResponsiveContainer.tsx"
      provides: "Mobile-first responsive wrapper"
      contains: "className"
    - path: "tests/load/wedding-site.js"
      provides: "k6 load test script"
      contains: "http.get"
  key_links:
    - from: "src/app/[domain]/layout.tsx"
      to: "src/components/layout/ResponsiveContainer.tsx"
      via: "component import and usage"
      pattern: "ResponsiveContainer"
---

<objective>
Complete the foundation phase with responsive layout components, and verify the infrastructure meets performance requirements.

Purpose: Ensure the platform works on all devices (mobile-first design) and can handle wedding-day traffic spikes (100 concurrent users per site).
Output: Responsive layout components, k6 load test script, and verification that all Phase 1 success criteria are met.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create responsive layout components</name>
  <files>
    src/components/layout/ResponsiveContainer.tsx
    src/components/layout/Header.tsx
    src/components/layout/Footer.tsx
  </files>
  <action>
Create `src/components/layout/ResponsiveContainer.tsx`:

```typescript
import { cn } from '@/lib/utils';

interface ResponsiveContainerProps {
  children: React.ReactNode;
  className?: string;
  /** Use narrow width for content-focused pages */
  narrow?: boolean;
}

export function ResponsiveContainer({
  children,
  className,
  narrow = false
}: ResponsiveContainerProps) {
  return (
    <div
      className={cn(
        // Mobile-first: full width with padding
        'w-full px-4',
        // Tablet: slightly more padding
        'sm:px-6',
        // Desktop: centered with max-width
        'md:px-8',
        narrow
          ? 'lg:max-w-2xl lg:mx-auto'
          : 'lg:max-w-4xl lg:mx-auto',
        // Large desktop: wider max-width
        !narrow && 'xl:max-w-5xl',
        className
      )}
    >
      {children}
    </div>
  );
}
```

Create `src/components/layout/Header.tsx`:

```typescript
import { cn } from '@/lib/utils';
import Link from 'next/link';

interface HeaderProps {
  /** Title to display in header */
  title?: string;
  /** Navigation items */
  navItems?: Array<{ href: string; label: string }>;
  className?: string;
}

export function Header({ title, navItems = [], className }: HeaderProps) {
  return (
    <header
      className={cn(
        'w-full border-b border-gray-200',
        'bg-white/80 backdrop-blur-sm',
        'sticky top-0 z-50',
        className
      )}
    >
      <div className={cn(
        // Mobile: stacked layout
        'flex flex-col gap-2 px-4 py-3',
        // Tablet+: horizontal layout
        'sm:flex-row sm:items-center sm:justify-between sm:px-6',
        'md:px-8',
        'lg:max-w-4xl lg:mx-auto xl:max-w-5xl'
      )}>
        {title && (
          <h1 className="text-lg font-semibold sm:text-xl">
            {title}
          </h1>
        )}
        {navItems.length > 0 && (
          <nav className={cn(
            // Mobile: wrap navigation
            'flex flex-wrap gap-2',
            // Desktop: horizontal with more spacing
            'sm:gap-4 md:gap-6'
          )}>
            {navItems.map((item) => (
              <Link
                key={item.href}
                href={item.href}
                className={cn(
                  'text-sm text-gray-600 hover:text-gray-900',
                  'transition-colors',
                  'sm:text-base'
                )}
              >
                {item.label}
              </Link>
            ))}
          </nav>
        )}
      </div>
    </header>
  );
}
```

Create `src/components/layout/Footer.tsx`:

```typescript
import { cn } from '@/lib/utils';

interface FooterProps {
  /** Couple names to display */
  coupleNames?: string;
  className?: string;
}

export function Footer({ coupleNames, className }: FooterProps) {
  return (
    <footer
      className={cn(
        'w-full border-t border-gray-200',
        'mt-auto',
        className
      )}
    >
      <div className={cn(
        'px-4 py-6 text-center',
        'sm:px-6 md:px-8',
        'lg:max-w-4xl lg:mx-auto xl:max-w-5xl'
      )}>
        {coupleNames && (
          <p className="text-sm text-gray-500">
            {coupleNames}
          </p>
        )}
        <p className="text-xs text-gray-400 mt-2">
          Powered by Wedding Platform
        </p>
      </div>
    </footer>
  );
}
```

Create barrel export `src/components/layout/index.ts`:

```typescript
export { ResponsiveContainer } from './ResponsiveContainer';
export { Header } from './Header';
export { Footer } from './Footer';
```
  </action>
  <verify>
- Files exist in src/components/layout/
- TypeScript compiles: `npx tsc --noEmit`
- Components use Tailwind mobile-first pattern (unprefixed = mobile, sm:/md:/lg: = larger)
  </verify>
  <done>Responsive layout components created with mobile-first Tailwind classes</done>
</task>

<task type="auto">
  <name>Task 2: Update layouts to use responsive components and verify viewport</name>
  <files>
    src/app/layout.tsx
    src/app/[domain]/layout.tsx
  </files>
  <action>
Update `src/app/layout.tsx` to ensure proper viewport meta tag (Next.js 15 pattern):

```typescript
import type { Metadata, Viewport } from 'next';
import { Inter } from 'next/font/google';
import './globals.css';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'Wedding Website Platform',
  description: 'Create beautiful wedding websites for your special day',
};

export const viewport: Viewport = {
  width: 'device-width',
  initialScale: 1,
  maximumScale: 5,
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        {children}
      </body>
    </html>
  );
}
```

Update `src/app/[domain]/layout.tsx` to use the layout components:

```typescript
import { Header, Footer } from '@/components/layout';

export default function TenantLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="min-h-screen flex flex-col">
      <Header
        navItems={[
          { href: '/', label: 'Home' },
          { href: '/story', label: 'Our Story' },
          { href: '/rsvp', label: 'RSVP' },
        ]}
      />
      <main className="flex-1">
        {children}
      </main>
      <Footer />
    </div>
  );
}
```
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Viewport export exists in src/app/layout.tsx
- TenantLayout uses Header and Footer components
  </verify>
  <done>Layouts updated with viewport configuration and responsive components</done>
</task>

<task type="auto">
  <name>Task 3: Create k6 load test script</name>
  <files>
    tests/load/wedding-site.js
    package.json
  </files>
  <action>
Create directory and file `tests/load/wedding-site.js`:

```javascript
// k6 load test for wedding site
// Run with: k6 run tests/load/wedding-site.js
// Or with environment variable: k6 run -e BASE_URL=https://test.example.com tests/load/wedding-site.js

import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate, Trend } from 'k6/metrics';

// Custom metrics
const errorRate = new Rate('errors');
const homePageDuration = new Trend('home_page_duration');

export const options = {
  stages: [
    { duration: '30s', target: 25 },   // Ramp up to 25 users
    { duration: '30s', target: 50 },   // Ramp to 50 users
    { duration: '1m', target: 100 },   // Ramp to 100 users (target)
    { duration: '2m', target: 100 },   // Stay at 100 users
    { duration: '30s', target: 0 },    // Ramp down
  ],
  thresholds: {
    // 95% of requests should complete under 500ms
    http_req_duration: ['p(95)<500'],
    // Error rate should be under 1%
    'errors': ['rate<0.01'],
    // Home page specifically should be fast
    'home_page_duration': ['p(95)<400'],
  },
};

// Base URL - defaults to localhost for development testing
const BASE_URL = __ENV.BASE_URL || 'http://localhost:3000';

export default function () {
  // Simulate guest visiting wedding site home page
  const homeResponse = http.get(BASE_URL);

  const homeSuccess = check(homeResponse, {
    'home page status is 200': (r) => r.status === 200,
    'home page has content': (r) => r.body && r.body.length > 0,
    'home page loads under 500ms': (r) => r.timings.duration < 500,
  });

  errorRate.add(!homeSuccess);
  homePageDuration.add(homeResponse.timings.duration);

  // Simulate think time (user reading the page)
  sleep(Math.random() * 2 + 1); // 1-3 seconds

  // Simulate navigating to another page (if it exists)
  const storyResponse = http.get(`${BASE_URL}/story`);

  const storySuccess = check(storyResponse, {
    'story page responds': (r) => r.status === 200 || r.status === 404,
    'story page under 500ms': (r) => r.timings.duration < 500,
  });

  errorRate.add(!storySuccess);

  // Another think time
  sleep(Math.random() * 3 + 2); // 2-5 seconds
}

export function handleSummary(data) {
  return {
    'stdout': textSummary(data, { indent: ' ', enableColors: true }),
  };
}

// Text summary helper
function textSummary(data, opts = {}) {
  const { indent = '', enableColors = false } = opts;

  const lines = [];
  lines.push(`${indent}Load Test Summary`);
  lines.push(`${indent}================`);

  if (data.metrics.http_req_duration) {
    const dur = data.metrics.http_req_duration;
    lines.push(`${indent}Request Duration (p95): ${dur.values['p(95)'].toFixed(2)}ms`);
    lines.push(`${indent}Request Duration (avg): ${dur.values.avg.toFixed(2)}ms`);
  }

  if (data.metrics.errors) {
    const err = data.metrics.errors;
    lines.push(`${indent}Error Rate: ${(err.values.rate * 100).toFixed(2)}%`);
  }

  if (data.metrics.http_reqs) {
    lines.push(`${indent}Total Requests: ${data.metrics.http_reqs.values.count}`);
    lines.push(`${indent}Requests/sec: ${data.metrics.http_reqs.values.rate.toFixed(2)}`);
  }

  // Check thresholds
  lines.push(`${indent}`);
  lines.push(`${indent}Thresholds:`);
  for (const [name, threshold] of Object.entries(data.thresholds || {})) {
    const status = threshold.ok ? 'PASS' : 'FAIL';
    lines.push(`${indent}  ${name}: ${status}`);
  }

  return lines.join('\n');
}
```

Add npm script to package.json for running load tests. Update package.json scripts section to include:

```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "test:load": "k6 run tests/load/wedding-site.js",
    "test:load:ci": "k6 run --out json=load-test-results.json tests/load/wedding-site.js"
  }
}
```
  </action>
  <verify>
- `tests/load/wedding-site.js` exists
- File contains k6 test configuration with 100 user target
- package.json has test:load script
  </verify>
  <done>k6 load test script created targeting 100 concurrent users with p95 < 500ms threshold</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify Phase 1 Success Criteria</name>
  <what-built>
Complete Phase 1 Foundation infrastructure:
1. Multi-tenant Next.js application with subdomain routing
2. Prisma schema with tenant isolation models
3. Tenant context using AsyncLocalStorage
4. Application-level tenant isolation via Prisma extensions
5. Mobile-first responsive layout components
6. k6 load test script
  </what-built>
  <how-to-verify>
**Subdomain Routing (Success Criteria 1):**
1. Ensure hosts file has entry: `127.0.0.1 test-wedding.localhost`
2. Run `npm run dev`
3. Visit http://localhost:3000 - should see "Wedding Website Platform"
4. Visit http://test-wedding.localhost:3000 - should see tenant page (404 is OK if no DB, or shows "test-wedding" subdomain)

**Mobile Responsive (Success Criteria 5):**
1. Open Chrome DevTools (F12)
2. Toggle device toolbar (Ctrl+Shift+M)
3. Select "iPhone 12 Pro" or similar mobile preset
4. Verify layout adapts - no horizontal scroll, readable text
5. Select "iPad" - verify tablet layout
6. Return to desktop - verify full-width layout

**CDN Cache Headers (Success Criteria 3):**
Note: Full CDN verification requires deployment. For local verification:
1. Run `npm run build && npm run start`
2. Open DevTools Network tab
3. Load any page and check static assets (_next/static/*)
4. Verify Cache-Control headers are present (Next.js defaults: `public, max-age=31536000, immutable` for static assets)
5. After Vercel deployment, verify same headers via: `curl -I https://your-site.vercel.app/_next/static/[hash]/page.js`

**Code Structure:**
1. Check `src/lib/db/prisma.ts` exists with tenant extension
2. Check `src/components/layout/` has Header, Footer, ResponsiveContainer
3. Check `tests/load/wedding-site.js` exists

**Note:** Full load testing (Success Criteria 4) requires deployment. The k6 script is ready to run against deployed endpoint.
  </how-to-verify>
  <resume-signal>Type "approved" if verification passes, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 1 Success Criteria checklist:
1. [Code Complete] Application serves requests from multiple subdomains - middleware routes correctly
2. [Code Complete] Database queries scoped to tenant - Prisma extension implemented
3. [Verify at Checkpoint] Static assets via CDN with cache headers - check in production build
4. [Requires Deployment] Load test 100 concurrent users - k6 script ready, needs deployed endpoint
5. [Manually Verified] Mobile viewport renders correctly - responsive components implemented
</verification>

<success_criteria>
- Responsive layout components use mobile-first Tailwind patterns
- Viewport meta tag configured in root layout
- k6 load test script targets 100 concurrent users with p95 < 500ms threshold
- Human verification confirms subdomain routing, mobile responsiveness, and cache headers work
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
