---
phase: 08-guest-messaging
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/app/(platform)/dashboard/messaging/page.tsx
  - src/app/(platform)/dashboard/messaging/compose/page.tsx
  - src/app/(platform)/dashboard/messaging/[id]/page.tsx
  - src/app/(platform)/dashboard/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Couple can view list of sent and scheduled messages"
    - "Couple can compose a new message with subject and content"
    - "Couple can send immediately or schedule for future delivery"
    - "Couple can cancel a pending scheduled message"
    - "Couple can view details of a specific message"
  artifacts:
    - path: "src/app/(platform)/dashboard/messaging/page.tsx"
      provides: "Message history list page"
      min_lines: 50
    - path: "src/app/(platform)/dashboard/messaging/compose/page.tsx"
      provides: "Compose new message page"
      min_lines: 80
    - path: "src/app/(platform)/dashboard/messaging/[id]/page.tsx"
      provides: "Single message detail page"
      min_lines: 40
  key_links:
    - from: "src/app/(platform)/dashboard/messaging/page.tsx"
      to: "src/app/(platform)/dashboard/messaging/actions.ts"
      via: "getBroadcastMessages import"
      pattern: "import.*getBroadcastMessages.*from.*actions"
    - from: "src/app/(platform)/dashboard/messaging/compose/page.tsx"
      to: "src/app/(platform)/dashboard/messaging/actions.ts"
      via: "sendBroadcast, scheduleBroadcast imports"
      pattern: "import.*(sendBroadcast|scheduleBroadcast).*from.*actions"
    - from: "src/app/(platform)/dashboard/messaging/[id]/page.tsx"
      to: "src/app/(platform)/dashboard/messaging/actions.ts"
      via: "getBroadcastMessage, cancelBroadcast imports"
      pattern: "import.*(getBroadcastMessage|cancelBroadcast).*from.*actions"
---

<objective>
Build the Guest Messaging UI pages for Phase 8.

Purpose: Provide couples with a dashboard interface to compose broadcasts, view message history, and manage scheduled messages. This completes the Guest Messaging feature.

Output: Messaging dashboard with list, compose, and detail pages integrated with server actions from Plan 01.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/08-guest-messaging/08-RESEARCH.md
@wedding-platform/.planning/phases/08-guest-messaging/08-01-SUMMARY.md

# Existing UI patterns to follow
@wedding-platform/src/app/(platform)/dashboard/rsvp/reminders/page.tsx
@wedding-platform/src/app/(platform)/dashboard/photos/page.tsx
@wedding-platform/src/app/(platform)/dashboard/guests/page.tsx
@wedding-platform/src/app/(platform)/dashboard/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create messaging list and compose pages</name>
  <files>
    src/app/(platform)/dashboard/messaging/page.tsx
    src/app/(platform)/dashboard/messaging/compose/page.tsx
  </files>
  <action>
**Create messaging/page.tsx** - Message history list:

- Server component that calls `getBroadcastMessages(tenantId)`
- Get session and tenantId from auth()
- Display messages in a list/table with columns:
  - Subject (link to detail page)
  - Status (badge with color: PENDING=yellow, SENT=green, CANCELLED=gray, FAILED=red)
  - Recipients count
  - Scheduled/Sent date
- "Compose New Message" button linking to /dashboard/messaging/compose
- Empty state if no messages: "No messages sent yet. Compose your first broadcast!"
- Follow existing page patterns (guests/page.tsx, photos/page.tsx)

**Create messaging/compose/page.tsx** - Compose form:

- Form with:
  - Subject input (required, max 200 chars)
  - Content textarea (required, plain text)
  - Schedule toggle: "Send Now" vs "Schedule for Later"
  - If scheduled: datetime-local input for scheduledFor
    - Default to tomorrow at 10:00 AM
    - Add note: "Messages can be scheduled up to 30 days in advance"
- Preview section showing recipient count: "Will be sent to X guests with email addresses"
- Submit button: "Send Now" or "Schedule Message"
- Use form action with sendBroadcast or scheduleBroadcast based on toggle
- Client component for interactivity (toggle, datetime picker)
- Show loading state during submission
- Redirect to /dashboard/messaging on success
- Show error toast on failure

Use lucide-react icons (Mail, Send, Clock, Calendar).
Follow Tailwind patterns from existing dashboard pages.
  </action>
  <verify>
Navigate to /dashboard/messaging - page renders message list.
Click "Compose New Message" - compose form appears.
Toggle between Send Now and Schedule - appropriate inputs show.
  </verify>
  <done>Message list page displays history. Compose page has form with send/schedule options.</done>
</task>

<task type="auto">
  <name>Task 2: Create message detail page and add nav link</name>
  <files>
    src/app/(platform)/dashboard/messaging/[id]/page.tsx
    src/app/(platform)/dashboard/layout.tsx
  </files>
  <action>
**Create messaging/[id]/page.tsx** - Message detail:

- Server component that fetches single message via `getBroadcastMessage(params.id)`
- Verify message belongs to current tenant (handled by action)
- Display:
  - Subject (heading)
  - Status badge
  - Content (whitespace-pre-wrap for formatting)
  - Recipient count
  - Created at, Scheduled for (if applicable), Sent at (if applicable)
- If status is PENDING: Show "Cancel Message" button
  - On click, call cancelBroadcast(id)
  - Show confirmation dialog first
  - Redirect to /dashboard/messaging on success
- Back link to /dashboard/messaging

**Update dashboard/layout.tsx**:

Add "Messaging" link to the dashboard navigation, between "Photos" and before any other links.
Use Mail or MessageSquare icon from lucide-react.
Link to /dashboard/messaging.
  </action>
  <verify>
Click on a message in the list - detail page shows message info.
For PENDING message, cancel button appears and works.
Dashboard nav shows "Messaging" link.
  </verify>
  <done>Message detail page shows full message info with cancel option for pending. Nav includes Messaging link.</done>
</task>

<task type="auto">
  <name>Task 3: End-to-end verification</name>
  <files></files>
  <action>
Verify the complete flow works:

1. Navigate to /dashboard/messaging - empty state shown
2. Click "Compose New Message"
3. Fill in subject and content
4. Select "Send Now" and submit
   - (Will fail gracefully if RESEND_API_KEY not configured, but action should execute)
5. Check message appears in list with appropriate status
6. Create another message with "Schedule for Later"
   - Set date/time within 30 days
7. View the scheduled message detail
8. Cancel the scheduled message
9. Verify status changes to CANCELLED

Run `npm run build` to verify no TypeScript errors.
  </action>
  <verify>
Full flow from compose to send/schedule to cancel works.
`npm run build` passes without errors.
  </verify>
  <done>Complete Guest Messaging feature functional. Couples can compose, send, schedule, and cancel broadcasts.</done>
</task>

</tasks>

<verification>
1. /dashboard/messaging shows message history
2. /dashboard/messaging/compose allows composing with send/schedule toggle
3. /dashboard/messaging/[id] shows message details
4. Cancel button works for PENDING messages
5. Dashboard navigation includes Messaging link
6. `npm run build` passes
</verification>

<success_criteria>
- Couple can compose and send a broadcast email to all guests with email addresses
- Couple can schedule a message for future delivery
- Couple can cancel scheduled messages before they send
- Message history shows all broadcasts with status
</success_criteria>

<output>
After completion, create `.planning/phases/08-guest-messaging/08-02-SUMMARY.md`
</output>
