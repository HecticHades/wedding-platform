---
phase: 06-gift-registry
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - src/app/[domain]/registry/page.tsx
  - src/app/[domain]/registry/[giftId]/page.tsx
  - src/app/[domain]/registry/actions.ts
  - src/components/registry/GiftList.tsx
  - src/components/registry/PaymentQRCode.tsx
  - src/components/registry/PaymentModal.tsx
  - src/lib/registry/payment-utils.ts
autonomous: true

must_haves:
  truths:
    - "Guest can browse available gifts on public registry page"
    - "Guest can see which gifts are still available vs claimed"
    - "Guest can select a gift and see payment QR code"
    - "QR code is generated for configured payment method"
    - "Gift is marked as claimed when guest confirms selection"
  artifacts:
    - path: "src/app/[domain]/registry/page.tsx"
      provides: "Public registry page for guests"
      min_lines: 50
    - path: "src/components/registry/PaymentQRCode.tsx"
      provides: "QR code rendering component"
      min_lines: 40
    - path: "src/lib/registry/payment-utils.ts"
      provides: "QR code data generation utilities"
      exports: ["generateQRCodeData"]
  key_links:
    - from: "src/components/registry/PaymentQRCode.tsx"
      to: "src/lib/registry/payment-utils.ts"
      via: "import generateQRCodeData"
      pattern: "generateQRCodeData"
    - from: "src/components/registry/PaymentQRCode.tsx"
      to: "qrcode.react"
      via: "QRCodeSVG import"
      pattern: "QRCodeSVG"
    - from: "src/lib/registry/payment-utils.ts"
      to: "sepa-payment-qr-code"
      via: "generateSepaQrCode import"
      pattern: "sepa-payment-qr-code"
---

<objective>
Implement public gift registry page where guests can browse gifts and receive payment QR codes.

Purpose: Guests need to view the gift registry, see what's available, and get payment instructions when they select a gift (GIFT-03, GIFT-04, GIFT-05).

Output: Public registry page with gift browsing, QR code generation for payments, and gift claiming functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/06-gift-registry/06-RESEARCH.md
@wedding-platform/.planning/phases/06-gift-registry/06-02-SUMMARY.md
@wedding-platform/.planning/phases/06-gift-registry/06-03-SUMMARY.md

# Pattern references
@wedding-platform/src/app/[domain]/page.tsx
@wedding-platform/src/app/[domain]/rsvp/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payment utilities and QR code component</name>
  <files>src/lib/registry/payment-utils.ts, src/components/registry/PaymentQRCode.tsx</files>
  <action>
    1. Create `src/lib/registry/payment-utils.ts`:
       ```typescript
       import generateSepaQrCode from 'sepa-payment-qr-code';

       export function generateQRCodeData(
         paymentSettings: PrismaJson.PaymentSettings,
         amount: number,
         reference: string
       ): string | null {
         if (!paymentSettings.enabled || !paymentSettings.method) {
           return null;
         }

         switch (paymentSettings.method) {
           case 'bank_transfer':
             if (!paymentSettings.bankTransfer) return null;
             // EPC QR only works for EUR
             if (paymentSettings.bankTransfer.currency === 'EUR') {
               return generateSepaQrCode({
                 name: paymentSettings.bankTransfer.accountName,
                 iban: paymentSettings.bankTransfer.iban.replace(/\s/g, ''),
                 amount: amount,
                 unstructuredReference: reference,
               });
             }
             // For CHF, return formatted text (no EPC support)
             return formatSwissBankTransfer(paymentSettings.bankTransfer, amount, reference);

           case 'paypal':
             if (!paymentSettings.paypal) return null;
             const currency = paymentSettings.paypal.currency || 'USD';
             return `https://paypal.me/${paymentSettings.paypal.username}/${amount}${currency}`;

           case 'twint':
             // Twint doesn't support QR for personal use
             return null;

           default:
             return null;
         }
       }

       function formatSwissBankTransfer(
         config: NonNullable<PrismaJson.PaymentSettings['bankTransfer']>,
         amount: number,
         reference: string
       ): string {
         return `Bank: ${config.accountName}\nIBAN: ${config.iban}\nAmount: ${amount} CHF\nRef: ${reference}`;
       }

       export function getPaymentMethodLabel(method: string | null): string {
         switch (method) {
           case 'bank_transfer': return 'Bank Transfer';
           case 'paypal': return 'PayPal';
           case 'twint': return 'Twint';
           default: return 'Not configured';
         }
       }
       ```

    2. Create `src/components/registry/PaymentQRCode.tsx`:
       ```typescript
       "use client";

       import { QRCodeSVG } from 'qrcode.react';
       import { generateQRCodeData } from '@/lib/registry/payment-utils';

       interface PaymentQRCodeProps {
         paymentSettings: PrismaJson.PaymentSettings;
         amount: number;
         giftName: string;
       }

       export function PaymentQRCode({ paymentSettings, amount, giftName }: PaymentQRCodeProps) {
         const reference = `Gift: ${giftName}`;
         const qrData = generateQRCodeData(paymentSettings, amount, reference);

         // Twint: show instructions instead of QR
         if (paymentSettings.method === 'twint') {
           return (
             <div className="text-center p-6 bg-gray-50 rounded-lg">
               <h3 className="font-semibold text-lg mb-4">Pay with Twint</h3>
               <p className="text-gray-600 mb-4">
                 {paymentSettings.twint?.displayText || 'Open Twint and send payment'}
               </p>
               {paymentSettings.twint?.phoneNumber && (
                 <p className="font-mono text-xl">{paymentSettings.twint.phoneNumber}</p>
               )}
               <p className="mt-4 text-sm text-gray-500">
                 Amount: {amount} CHF | Reference: {reference}
               </p>
             </div>
           );
         }

         if (!qrData) {
           return (
             <div className="text-center p-6 bg-gray-50 rounded-lg">
               <p className="text-gray-600">Payment not configured</p>
             </div>
           );
         }

         const isPayPal = paymentSettings.method === 'paypal';

         return (
           <div className="text-center">
             <QRCodeSVG
               value={qrData}
               size={256}
               level="M"
               includeMargin
               className="mx-auto"
             />
             <p className="mt-4 text-sm text-gray-600">
               Scan with your {isPayPal ? 'phone camera or PayPal app' : 'banking app'}
             </p>
             {isPayPal && (
               <a
                 href={qrData}
                 target="_blank"
                 rel="noopener noreferrer"
                 className="mt-2 inline-block text-blue-600 hover:underline"
               >
                 Or click here to pay with PayPal
               </a>
             )}
           </div>
         );
       }
       ```
  </action>
  <verify>
    - payment-utils.ts exports generateQRCodeData and getPaymentMethodLabel
    - PaymentQRCode component renders QR for bank/PayPal
    - PaymentQRCode shows instructions for Twint
    - `npx tsc --noEmit` passes
  </verify>
  <done>Payment utilities and QR code component implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create public registry page and gift list</name>
  <files>src/app/[domain]/registry/page.tsx, src/components/registry/GiftList.tsx, src/app/[domain]/registry/actions.ts</files>
  <action>
    1. Create `src/app/[domain]/registry/actions.ts`:
       ```typescript
       "use server";

       import { prisma } from "@/lib/db/prisma";
       import { revalidatePath } from "next/cache";

       // Atomic claim to prevent race conditions
       export async function claimGift(giftId: string, guestName?: string) {
         try {
           // Use updateMany with condition for atomicity
           const result = await prisma.giftItem.updateMany({
             where: {
               id: giftId,
               isClaimed: false, // Only update if not already claimed
             },
             data: {
               isClaimed: true,
               claimedBy: guestName || 'Anonymous',
               claimedAt: new Date(),
             },
           });

           if (result.count === 0) {
             return { success: false, error: 'This gift has already been claimed' };
           }

           revalidatePath('/[domain]/registry');
           return { success: true };
         } catch (error) {
           console.error('Failed to claim gift:', error);
           return { success: false, error: 'Failed to claim gift' };
         }
       }
       ```

    2. Create `src/components/registry/GiftList.tsx`:
       - Client component displaying gift items in a grid
       - Each gift card shows: name, description, amount, image (if present)
       - Claimed gifts show as "Claimed" with strikethrough or dimmed
       - Available gifts have "Select This Gift" button
       - Clicking button opens PaymentModal

    3. Create `src/app/[domain]/registry/page.tsx`:
       - Server component for public registry view
       - Resolve tenant from domain parameter
       - Fetch wedding with giftItems, externalRegistries, paymentSettings
       - Display gift list using GiftList component
       - Display external registries as cards with links
       - Handle case where registry is empty
       - Do NOT expose raw paymentSettings to client (pass only to QR component)
  </action>
  <verify>
    - Public registry page renders at /[domain]/registry
    - Available and claimed gifts display correctly
    - External registry links display
    - `npx tsc --noEmit` passes
  </verify>
  <done>Public registry page and gift list implemented</done>
</task>

<task type="auto">
  <name>Task 3: Create payment modal and gift detail page</name>
  <files>src/components/registry/PaymentModal.tsx, src/app/[domain]/registry/[giftId]/page.tsx</files>
  <action>
    1. Create `src/components/registry/PaymentModal.tsx`:
       - Client component modal that appears when guest selects a gift
       - Props: gift (name, amount), paymentSettings, isOpen, onClose, onConfirm
       - Shows gift name and amount
       - Renders PaymentQRCode component
       - "I've made the payment" button that claims the gift
       - Optional: Ask for guest name before claiming
       - Close button to cancel
       - Use appropriate modal styling (overlay, centered, responsive)

    2. Create `src/app/[domain]/registry/[giftId]/page.tsx`:
       - Server component for direct gift link (alternative to modal)
       - Resolve tenant and fetch specific gift
       - Show gift details (name, description, amount, image)
       - If available: show PaymentQRCode and claim button
       - If claimed: show "Already claimed" message
       - Back link to registry list

    3. Update GiftList to integrate PaymentModal:
       - Use useState for selected gift
       - Open modal when "Select" is clicked
       - Handle claim confirmation
       - Refresh list after claiming (optimistic or full refresh)
  </action>
  <verify>
    - PaymentModal opens when guest selects a gift
    - QR code displays correctly in modal
    - Claim button marks gift as claimed
    - Gift detail page works at /[domain]/registry/[giftId]
    - Already claimed gifts show appropriate message
    - `npx tsc --noEmit` passes
  </verify>
  <done>Payment modal and gift claiming flow implemented</done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes
- [ ] Public registry page renders at /[domain]/registry
- [ ] Available gifts show with "Select" option
- [ ] Claimed gifts show as claimed
- [ ] Selecting gift shows payment QR code
- [ ] Bank transfer generates EPC QR (EUR) or text (CHF)
- [ ] PayPal generates PayPal.me link QR with clickable link
- [ ] Twint shows instructions text (no QR)
- [ ] Gift claiming works atomically (race condition prevented)
- [ ] External registry links display and work
</verification>

<success_criteria>
1. Guest can browse available gifts on public registry page
2. Guest can see claimed vs available gift status
3. Guest selecting a gift sees appropriate payment instructions:
   - Bank transfer (EUR): EPC QR code scannable by banking apps
   - Bank transfer (CHF): Text-based transfer instructions
   - PayPal: QR code and clickable PayPal.me link
   - Twint: Display text with phone number
4. Gift is marked as claimed after guest confirms payment
5. External registry links are displayed and functional
</success_criteria>

<output>
After completion, create `wedding-platform/.planning/phases/06-gift-registry/06-04-SUMMARY.md`
</output>
