---
phase: 06-gift-registry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/types/prisma-json.d.ts
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "GiftItem model exists with name, description, targetAmount, isClaimed fields"
    - "ExternalRegistry model exists with name, url, description fields"
    - "PaymentSettings JSON field exists on Wedding model"
    - "qrcode.react and sepa-payment-qr-code packages are installed"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "GiftItem, ExternalRegistry models and Wedding.paymentSettings"
      contains: "model GiftItem"
    - path: "src/types/prisma-json.d.ts"
      provides: "PaymentSettings TypeScript type"
      contains: "PaymentSettings"
    - path: "package.json"
      provides: "QR code dependencies"
      contains: "qrcode.react"
  key_links:
    - from: "src/types/prisma-json.d.ts"
      to: "prisma-json-types-generator"
      via: "PrismaJson namespace"
      pattern: "PaymentSettings"
---

<objective>
Add GiftItem, ExternalRegistry models and PaymentSettings JSON field to database schema, plus install QR code packages.

Purpose: The gift registry needs database models to store gift items couples create and external registry links. Payment configuration is stored separately from public content for security. QR code packages enable payment code generation.

Output: Updated Prisma schema with new models, typed PaymentSettings interface, qrcode.react and sepa-payment-qr-code installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/06-gift-registry/06-RESEARCH.md

# Existing schema for reference
@wedding-platform/prisma/schema.prisma
@wedding-platform/src/types/prisma-json.d.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GiftItem and ExternalRegistry models to schema</name>
  <files>prisma/schema.prisma</files>
  <action>
    1. Add paymentSettings JSON field to Wedding model (after contentSections):
       ```prisma
       /// [PaymentSettings]
       paymentSettings Json @default("{}")
       ```

    2. Add relation arrays to Wedding model (after events relation):
       ```prisma
       giftItems         GiftItem[]
       externalRegistries ExternalRegistry[]
       ```

    3. Add GiftItem model after EventGuest:
       ```prisma
       model GiftItem {
         id          String   @id @default(cuid())
         weddingId   String
         wedding     Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)

         name        String
         description String?
         targetAmount Decimal  @db.Decimal(10, 2)
         imageUrl    String?
         order       Int      @default(0)

         // Claiming
         isClaimed   Boolean  @default(false)
         claimedBy   String?
         claimedAt   DateTime?

         createdAt   DateTime @default(now())
         updatedAt   DateTime @updatedAt

         @@index([weddingId])
         @@index([weddingId, isClaimed])
       }
       ```

    4. Add ExternalRegistry model after GiftItem:
       ```prisma
       model ExternalRegistry {
         id          String   @id @default(cuid())
         weddingId   String
         wedding     Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)

         name        String
         url         String
         description String?
         order       Int      @default(0)

         createdAt   DateTime @default(now())
         updatedAt   DateTime @updatedAt

         @@index([weddingId])
       }
       ```

    5. Run `npx prisma validate` to check syntax.
  </action>
  <verify>
    - `npx prisma validate` passes
    - GiftItem model has all required fields
    - ExternalRegistry model has all required fields
    - Wedding model has paymentSettings and relations
  </verify>
  <done>GiftItem and ExternalRegistry models added with proper relations and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Add PaymentSettings TypeScript type and push schema</name>
  <files>src/types/prisma-json.d.ts</files>
  <action>
    1. Add PaymentSettings interface to PrismaJson namespace in prisma-json.d.ts:
       ```typescript
       /**
        * Payment settings for gift registry stored in Wedding.paymentSettings
        */
       interface PaymentSettings {
         enabled: boolean;
         method: 'bank_transfer' | 'paypal' | 'twint' | null;

         // Bank transfer (EPC QR code for EUR, text display for CHF)
         bankTransfer?: {
           accountName: string;
           iban: string;
           bic?: string;
           currency: 'EUR' | 'CHF';
         };

         // PayPal.me link
         paypal?: {
           username: string;
           currency?: string;
         };

         // Twint (Swiss - display instructions only)
         twint?: {
           displayText: string;
           phoneNumber?: string;
         };
       }
       ```

    2. Run `npx prisma generate` to regenerate client with typed JSON.

    3. Run `npx prisma db push` to sync schema to database.

    4. Run `npx tsc --noEmit` to verify types.
  </action>
  <verify>
    - `npx prisma db push` completes without error
    - `npx tsc --noEmit` passes
    - PaymentSettings type is available in PrismaJson namespace
  </verify>
  <done>PaymentSettings type defined and database schema synced</done>
</task>

<task type="auto">
  <name>Task 3: Install QR code packages</name>
  <files>package.json, package-lock.json</files>
  <action>
    1. Install QR code packages:
       ```bash
       cd wedding-platform && npm install qrcode.react@^4.2.0 sepa-payment-qr-code@^2.0.0
       ```

    2. Verify installation:
       ```bash
       npm ls qrcode.react
       npm ls sepa-payment-qr-code
       ```

    3. Run `npx tsc --noEmit` to verify no type conflicts.
  </action>
  <verify>
    - `npm ls qrcode.react` shows version 4.x
    - `npm ls sepa-payment-qr-code` shows version 2.x
    - `npx tsc --noEmit` passes
  </verify>
  <done>qrcode.react and sepa-payment-qr-code packages installed</done>
</task>

</tasks>

<verification>
- [ ] `npx prisma validate` passes
- [ ] `npx prisma db push` completes without error
- [ ] `npx tsc --noEmit` passes (all types correct)
- [ ] GiftItem model exists with name, description, targetAmount, isClaimed, claimedBy, claimedAt
- [ ] ExternalRegistry model exists with name, url, description, order
- [ ] Wedding.paymentSettings JSON field exists
- [ ] PaymentSettings type available in PrismaJson namespace
- [ ] qrcode.react and sepa-payment-qr-code in package.json dependencies
</verification>

<success_criteria>
1. GiftItem and ExternalRegistry models exist in database
2. Wedding.paymentSettings JSON field exists with PaymentSettings typing
3. qrcode.react (4.x) and sepa-payment-qr-code (2.x) packages installed
4. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `wedding-platform/.planning/phases/06-gift-registry/06-01-SUMMARY.md`
</output>
