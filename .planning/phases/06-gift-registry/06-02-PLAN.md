---
phase: 06-gift-registry
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/app/(platform)/dashboard/registry/page.tsx
  - src/app/(platform)/dashboard/registry/actions.ts
  - src/app/(platform)/dashboard/registry/new/page.tsx
  - src/app/(platform)/dashboard/registry/[id]/page.tsx
  - src/components/registry/GiftForm.tsx
  - src/components/registry/GiftCard.tsx
autonomous: true

must_haves:
  truths:
    - "Couple can see list of their gift items on dashboard"
    - "Couple can create a new gift item with name, description, amount"
    - "Couple can edit an existing gift item"
    - "Couple can delete a gift item"
    - "Couple can see which gifts have been claimed"
  artifacts:
    - path: "src/app/(platform)/dashboard/registry/page.tsx"
      provides: "Gift list dashboard page"
      min_lines: 50
    - path: "src/app/(platform)/dashboard/registry/actions.ts"
      provides: "Gift CRUD server actions"
      exports: ["createGift", "updateGift", "deleteGift"]
    - path: "src/components/registry/GiftForm.tsx"
      provides: "Gift add/edit form component"
      min_lines: 80
  key_links:
    - from: "src/app/(platform)/dashboard/registry/page.tsx"
      to: "src/app/(platform)/dashboard/registry/actions.ts"
      via: "server action import"
      pattern: "from.*actions"
    - from: "src/app/(platform)/dashboard/registry/actions.ts"
      to: "prisma.giftItem"
      via: "database query"
      pattern: "prisma\\.giftItem\\.(create|update|delete)"
---

<objective>
Implement gift item CRUD for the couple dashboard - list, create, edit, delete gift items.

Purpose: Couples need to manage their gift registry by creating items with descriptions and target amounts. This is the core gift management functionality (GIFT-01).

Output: Dashboard pages for gift management with server actions for CRUD operations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/06-gift-registry/06-RESEARCH.md
@wedding-platform/.planning/phases/06-gift-registry/06-01-SUMMARY.md

# Pattern references
@wedding-platform/src/app/(platform)/dashboard/events/actions.ts
@wedding-platform/src/app/(platform)/dashboard/guests/actions.ts
@wedding-platform/src/app/(platform)/dashboard/events/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gift CRUD server actions</name>
  <files>src/app/(platform)/dashboard/registry/actions.ts</files>
  <action>
    Create `src/app/(platform)/dashboard/registry/actions.ts` following the events/actions.ts pattern:

    ```typescript
    "use server";

    import { auth } from "@/lib/auth/auth";
    import { prisma, withTenantContext } from "@/lib/db/prisma";
    import { revalidatePath } from "next/cache";
    import { z } from "zod";

    // Validation schema for gift data
    const giftSchema = z.object({
      name: z.string().min(1, "Gift name is required").max(100),
      description: z.string().max(500).optional(),
      targetAmount: z.coerce.number().positive("Amount must be positive"),
      imageUrl: z.string().url().optional().or(z.literal("")),
    });
    ```

    Implement these actions:

    1. `createGift(formData: FormData)` - Create new gift item
       - Auth check with tenantId
       - Parse and validate form data
       - withTenantContext to get wedding
       - Calculate next order value (max + 1)
       - prisma.giftItem.create with weddingId
       - revalidatePath("/dashboard/registry")

    2. `updateGift(giftId: string, formData: FormData)` - Update existing gift
       - Auth check with tenantId
       - Parse and validate form data
       - withTenantContext to verify gift belongs to tenant
       - prisma.giftItem.update
       - revalidatePath for list and detail

    3. `deleteGift(giftId: string)` - Delete gift item
       - Auth check with tenantId
       - withTenantContext to verify gift belongs to tenant
       - prisma.giftItem.delete
       - revalidatePath("/dashboard/registry")

    4. `reorderGifts(orderedGifts: { id: string; order: number }[])` - Reorder gift items
       - Similar to reorderEvents pattern

    Use Decimal handling: `targetAmount: new Prisma.Decimal(data.targetAmount)`
  </action>
  <verify>
    - File exists at src/app/(platform)/dashboard/registry/actions.ts
    - Exports createGift, updateGift, deleteGift, reorderGifts
    - Uses withTenantContext for tenant isolation
    - `npx tsc --noEmit` passes
  </verify>
  <done>Gift CRUD server actions implemented with tenant isolation</done>
</task>

<task type="auto">
  <name>Task 2: Create gift list dashboard page and GiftCard component</name>
  <files>src/app/(platform)/dashboard/registry/page.tsx, src/components/registry/GiftCard.tsx</files>
  <action>
    1. Create `src/components/registry/GiftCard.tsx`:
       - Display gift name, description, target amount
       - Show claimed status with visual indicator (badge or checkmark)
       - Show claimedBy name if claimed
       - Edit and Delete buttons (link to edit page, delete action)
       - Use delete confirmation modal pattern from events

    2. Create `src/app/(platform)/dashboard/registry/page.tsx`:
       - Server component that fetches gifts for the wedding
       - Auth check with session.user.tenantId
       - withTenantContext to get wedding and gifts
       - Display gifts using GiftCard component in a grid
       - "Add Gift" button linking to /dashboard/registry/new
       - Empty state when no gifts exist
       - Show summary stats: total items, claimed count, total value

    Follow the events/page.tsx pattern for layout and structure.
  </action>
  <verify>
    - Dashboard page renders at /dashboard/registry
    - GiftCard displays gift info with claimed status
    - Add Gift button links to new page
    - Delete works with confirmation
    - `npx tsc --noEmit` passes
  </verify>
  <done>Gift list dashboard and GiftCard component implemented</done>
</task>

<task type="auto">
  <name>Task 3: Create gift form and add/edit pages</name>
  <files>src/components/registry/GiftForm.tsx, src/app/(platform)/dashboard/registry/new/page.tsx, src/app/(platform)/dashboard/registry/[id]/page.tsx</files>
  <action>
    1. Create `src/components/registry/GiftForm.tsx`:
       - Client component with form for gift creation/editing
       - Fields: name (text), description (textarea), targetAmount (number), imageUrl (text, optional)
       - Accept optional `gift` prop for edit mode
       - Accept `action` prop for the server action to call
       - Submit button with loading state using useFormStatus
       - Cancel button linking back to /dashboard/registry

    2. Create `src/app/(platform)/dashboard/registry/new/page.tsx`:
       - Server component wrapping GiftForm
       - Auth check
       - Pass createGift action to form

    3. Create `src/app/(platform)/dashboard/registry/[id]/page.tsx`:
       - Server component for editing existing gift
       - Auth check and tenant context
       - Fetch gift by ID (404 if not found)
       - Pass gift data and updateGift action to form

    Use existing event form patterns for styling and layout.
  </action>
  <verify>
    - New gift page renders at /dashboard/registry/new
    - Edit gift page renders at /dashboard/registry/[id]
    - Form validation works (required fields, positive amount)
    - Create and update work correctly
    - `npx tsc --noEmit` passes
  </verify>
  <done>Gift form component and add/edit pages implemented</done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes
- [ ] Gift list displays at /dashboard/registry
- [ ] Create gift works via /dashboard/registry/new
- [ ] Edit gift works via /dashboard/registry/[id]
- [ ] Delete gift works with confirmation modal
- [ ] Claimed status displays on gift cards
- [ ] Server actions use withTenantContext for isolation
</verification>

<success_criteria>
1. Couple can view list of gift items on dashboard
2. Couple can create gift items with name, description, target amount
3. Couple can edit existing gift items
4. Couple can delete gift items with confirmation
5. Gift cards show claimed status when applicable
</success_criteria>

<output>
After completion, create `wedding-platform/.planning/phases/06-gift-registry/06-02-SUMMARY.md`
</output>
