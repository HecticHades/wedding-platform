---
phase: 06-gift-registry
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/app/(platform)/dashboard/registry/external/page.tsx
  - src/app/(platform)/dashboard/registry/external/actions.ts
  - src/app/(platform)/dashboard/registry/settings/page.tsx
  - src/app/(platform)/dashboard/registry/settings/actions.ts
  - src/components/registry/ExternalRegistryForm.tsx
  - src/components/registry/ExternalRegistryCard.tsx
  - src/components/registry/PaymentSettingsForm.tsx
autonomous: true

must_haves:
  truths:
    - "Couple can add links to external registries (Amazon, etc.)"
    - "Couple can edit and delete external registry links"
    - "Couple can configure payment method (bank transfer, PayPal, Twint)"
    - "Payment settings are stored securely on wedding model"
  artifacts:
    - path: "src/app/(platform)/dashboard/registry/external/page.tsx"
      provides: "External registry management page"
      min_lines: 40
    - path: "src/app/(platform)/dashboard/registry/settings/page.tsx"
      provides: "Payment settings configuration page"
      min_lines: 60
    - path: "src/app/(platform)/dashboard/registry/settings/actions.ts"
      provides: "Payment settings server action"
      exports: ["updatePaymentSettings"]
  key_links:
    - from: "src/app/(platform)/dashboard/registry/settings/actions.ts"
      to: "prisma.wedding.update"
      via: "database update"
      pattern: "prisma\\.wedding\\.update"
    - from: "src/components/registry/PaymentSettingsForm.tsx"
      to: "src/app/(platform)/dashboard/registry/settings/actions.ts"
      via: "server action"
      pattern: "updatePaymentSettings"
---

<objective>
Implement external registry management and payment settings configuration for the couple dashboard.

Purpose: Couples need to add links to external registries like Amazon (GIFT-06) and configure their preferred payment method for cash gifts (GIFT-02).

Output: External registry CRUD pages and payment settings configuration form.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/06-gift-registry/06-RESEARCH.md
@wedding-platform/.planning/phases/06-gift-registry/06-01-SUMMARY.md

# Pattern references
@wedding-platform/src/app/(platform)/dashboard/events/actions.ts
@wedding-platform/src/types/prisma-json.d.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create external registry CRUD</name>
  <files>src/app/(platform)/dashboard/registry/external/page.tsx, src/app/(platform)/dashboard/registry/external/actions.ts, src/components/registry/ExternalRegistryCard.tsx, src/components/registry/ExternalRegistryForm.tsx</files>
  <action>
    1. Create `src/app/(platform)/dashboard/registry/external/actions.ts`:
       ```typescript
       "use server";

       import { auth } from "@/lib/auth/auth";
       import { prisma, withTenantContext } from "@/lib/db/prisma";
       import { revalidatePath } from "next/cache";
       import { z } from "zod";

       const externalRegistrySchema = z.object({
         name: z.string().min(1, "Name is required").max(50),
         url: z.string().url("Must be a valid URL"),
         description: z.string().max(200).optional(),
       });
       ```

       Implement:
       - `createExternalRegistry(formData: FormData)`
       - `updateExternalRegistry(id: string, formData: FormData)`
       - `deleteExternalRegistry(id: string)`
       - `reorderExternalRegistries(ordered: { id: string; order: number }[])`

       Follow same patterns as gift actions with withTenantContext.

    2. Create `src/components/registry/ExternalRegistryCard.tsx`:
       - Display registry name, URL (as link), description
       - Edit and Delete buttons
       - Use delete confirmation modal pattern

    3. Create `src/components/registry/ExternalRegistryForm.tsx`:
       - Client component with form fields: name, url, description
       - Accept optional `registry` prop for edit mode
       - Submit with useFormStatus loading state

    4. Create `src/app/(platform)/dashboard/registry/external/page.tsx`:
       - List external registries with add/edit/delete
       - "Add Registry" form or modal
       - Empty state for no registries
       - Common registries suggestions (Amazon, Target, Williams Sonoma)
  </action>
  <verify>
    - External registry page renders at /dashboard/registry/external
    - CRUD operations work correctly
    - Links are validated as URLs
    - `npx tsc --noEmit` passes
  </verify>
  <done>External registry CRUD implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create payment settings configuration</name>
  <files>src/app/(platform)/dashboard/registry/settings/page.tsx, src/app/(platform)/dashboard/registry/settings/actions.ts, src/components/registry/PaymentSettingsForm.tsx</files>
  <action>
    1. Create `src/app/(platform)/dashboard/registry/settings/actions.ts`:
       ```typescript
       "use server";

       import { auth } from "@/lib/auth/auth";
       import { prisma, withTenantContext } from "@/lib/db/prisma";
       import { revalidatePath } from "next/cache";
       import { z } from "zod";

       // IBAN validation regex (basic format check)
       const ibanSchema = z.string()
         .min(15, "IBAN too short")
         .max(34, "IBAN too long")
         .regex(/^[A-Z]{2}[0-9]{2}[A-Z0-9]+$/, "Invalid IBAN format")
         .transform(val => val.replace(/\s/g, '').toUpperCase());

       const paymentSettingsSchema = z.object({
         enabled: z.boolean(),
         method: z.enum(['bank_transfer', 'paypal', 'twint']).nullable(),
         // Bank transfer fields
         bankAccountName: z.string().max(70).optional(),
         bankIban: ibanSchema.optional().or(z.literal("")),
         bankBic: z.string().max(11).optional(),
         bankCurrency: z.enum(['EUR', 'CHF']).optional(),
         // PayPal fields
         paypalUsername: z.string().max(50).optional(),
         paypalCurrency: z.string().length(3).optional(),
         // Twint fields
         twintDisplayText: z.string().max(200).optional(),
         twintPhoneNumber: z.string().max(20).optional(),
       });

       export async function updatePaymentSettings(formData: FormData) {
         // Auth check
         // Parse and structure into PaymentSettings shape
         // withTenantContext to update wedding.paymentSettings
         // revalidatePath
       }
       ```

    2. Create `src/components/registry/PaymentSettingsForm.tsx`:
       - Client component with payment method selection
       - Radio buttons for method: bank_transfer, paypal, twint
       - Conditional fields based on selected method:
         - Bank transfer: accountName, iban, bic (optional), currency (EUR/CHF)
         - PayPal: username, currency (optional)
         - Twint: displayText, phoneNumber
       - Enable/disable toggle for payments
       - Form validation with error display
       - Security note about payment info storage

    3. Create `src/app/(platform)/dashboard/registry/settings/page.tsx`:
       - Server component loading current payment settings
       - Render PaymentSettingsForm with current values
       - Info callout explaining each payment method
       - Link back to main registry page
  </action>
  <verify>
    - Payment settings page renders at /dashboard/registry/settings
    - Method selection shows appropriate fields
    - IBAN validation works (format check)
    - Settings save correctly to wedding.paymentSettings
    - `npx tsc --noEmit` passes
  </verify>
  <done>Payment settings configuration implemented</done>
</task>

<task type="auto">
  <name>Task 3: Add navigation between registry pages</name>
  <files>src/app/(platform)/dashboard/registry/page.tsx</files>
  <action>
    1. Update the main registry page (src/app/(platform)/dashboard/registry/page.tsx) to include navigation tabs or links:
       - "Gifts" (current page)
       - "External Registries" (/dashboard/registry/external)
       - "Payment Settings" (/dashboard/registry/settings)

    2. Add a consistent subnavigation component or tab bar at the top of all registry pages.

    3. Show payment method status on main page:
       - If configured: "Payments enabled via [method]"
       - If not configured: "Set up payment method" with link to settings

    4. Show external registry count on main page with link.
  </action>
  <verify>
    - Navigation tabs appear on all registry pages
    - Links work correctly between pages
    - Payment status indicator shows on main page
    - External registry count shows on main page
  </verify>
  <done>Registry page navigation and status indicators added</done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes
- [ ] External registries page renders at /dashboard/registry/external
- [ ] External registry CRUD operations work
- [ ] Payment settings page renders at /dashboard/registry/settings
- [ ] Payment method selection shows correct fields
- [ ] IBAN validation catches invalid formats
- [ ] Settings persist to database correctly
- [ ] Navigation between registry pages works
</verification>

<success_criteria>
1. Couple can add, edit, delete external registry links
2. Couple can configure bank transfer with IBAN and account name
3. Couple can configure PayPal with username
4. Couple can configure Twint with display text and phone
5. Payment settings are saved to Wedding.paymentSettings
6. Navigation between registry pages is intuitive
</success_criteria>

<output>
After completion, create `wedding-platform/.planning/phases/06-gift-registry/06-03-SUMMARY.md`
</output>
