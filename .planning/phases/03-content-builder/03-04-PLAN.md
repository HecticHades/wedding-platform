---
phase: 03-content-builder
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/(platform)/dashboard/content/page.tsx
  - src/app/(platform)/dashboard/content/actions.ts
  - src/components/content-builder/SortableSectionList.tsx
  - src/components/content-builder/SortableSection.tsx
  - src/components/content-builder/AddSectionDialog.tsx
autonomous: true

must_haves:
  truths:
    - "Couple can see list of their content sections"
    - "Couple can add new sections from available types"
    - "Couple can reorder sections via drag-and-drop"
    - "Couple can toggle section visibility"
    - "Couple can delete sections"
  artifacts:
    - path: "src/app/(platform)/dashboard/content/page.tsx"
      provides: "Content management page"
      min_lines: 50
    - path: "src/components/content-builder/SortableSectionList.tsx"
      provides: "Drag-and-drop section list with dnd-kit"
      min_lines: 50
    - path: "src/components/content-builder/SortableSection.tsx"
      provides: "Individual draggable section item"
      min_lines: 40
    - path: "src/app/(platform)/dashboard/content/actions.ts"
      provides: "Server actions for section CRUD"
      exports: ["addSection", "updateSectionOrder", "toggleSectionVisibility", "deleteSection"]
  key_links:
    - from: "src/components/content-builder/SortableSectionList.tsx"
      to: "@dnd-kit/sortable"
      via: "library import"
      pattern: "import.*@dnd-kit/sortable"
    - from: "src/app/(platform)/dashboard/content/page.tsx"
      to: "src/app/(platform)/dashboard/content/actions.ts"
      via: "server action"
      pattern: "import.*actions"
---

<objective>
Create the content section management system where couples can add, remove, reorder, and toggle visibility of content sections using drag-and-drop.

Purpose: Content sections are the building blocks of the wedding site. This plan handles the structural management (what sections exist and their order). The actual content editing for each section type is handled in Plan 05.

Output: Content management page with drag-and-drop reordering, add section dialog, visibility toggles, and delete functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/phases/03-content-builder/03-RESEARCH.md

# From Plan 01
@wedding-platform/src/lib/content/section-types.ts
@wedding-platform/src/types/prisma-json.d.ts

# Existing patterns
@wedding-platform/src/app/(platform)/dashboard/page.tsx
@wedding-platform/src/lib/db/prisma.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server actions for content section management</name>
  <files>
    - src/app/(platform)/dashboard/content/actions.ts
  </files>
  <action>
Create src/app/(platform)/dashboard/content/actions.ts with "use server" directive.

Import: auth, prisma, withTenantContext, revalidatePath, z, section-types utilities

Server actions:

1. **addSection(type: SectionType)**
   - Validates session and tenant context
   - Validates type is valid SectionType
   - Gets current wedding's contentSections
   - Creates new section object: { id: cuid(), type, order: sections.length, isVisible: true, content: createEmptyContent(type) }
   - Appends to contentSections array
   - Updates wedding with new array
   - revalidatePath("/dashboard/content")
   - Returns { success: true, sectionId: string }

2. **updateSectionOrder(sections: { id: string; order: number }[])**
   - Validates session and tenant context
   - Gets current contentSections
   - Updates order field for each section based on input
   - Sorts array by order
   - Updates wedding
   - revalidatePath("/dashboard/content")

3. **toggleSectionVisibility(sectionId: string)**
   - Finds section by id in contentSections
   - Toggles isVisible flag
   - Updates wedding
   - revalidatePath("/dashboard/content")

4. **deleteSection(sectionId: string)**
   - Filters out section with matching id
   - Re-numbers remaining sections' order to be sequential
   - Updates wedding
   - revalidatePath("/dashboard/content")

Helper function createEmptyContent(type: SectionType) returns appropriate empty content object:
- "event-details": { type: "event-details", events: [] }
- "our-story": { type: "our-story", title: "Our Story", story: "" }
- "travel": { type: "travel", hotels: [] }
- "gallery": { type: "gallery", title: "Gallery", photos: [] }
- "timeline": { type: "timeline", title: "Timeline", events: [] }
- "contact": { type: "contact", title: "Contact", contacts: [] }
  </action>
  <verify>
- File exports all 4 server actions
- Actions have proper session/tenant validation
- `npx tsc --noEmit` passes
  </verify>
  <done>Server actions exist for add, reorder, toggle visibility, and delete operations on content sections</done>
</task>

<task type="auto">
  <name>Task 2: Create drag-and-drop section list components</name>
  <files>
    - src/components/content-builder/SortableSectionList.tsx
    - src/components/content-builder/SortableSection.tsx
  </files>
  <action>
Create src/components/content-builder/SortableSection.tsx:
- "use client" directive
- Props: id, type, isVisible, onToggleVisibility, onDelete
- Uses useSortable hook from @dnd-kit/sortable
- Renders a card with:
  - Drag handle (GripVertical icon) with {...attributes} {...listeners}
  - Section type label (from SECTION_TYPES)
  - Visibility status text ("Visible to guests" / "Hidden")
  - Action buttons:
    - Eye/EyeOff toggle for visibility
    - Edit link to /dashboard/content/[type]
    - Trash button for delete (with confirmation)
- Apply transform and transition from useSortable for smooth animation
- Reduced opacity when isDragging

Create src/components/content-builder/SortableSectionList.tsx:
- "use client" directive
- Props: initialSections (ContentSection[])
- Local state: sections (useState initialized from props)
- Configure sensors: PointerSensor, KeyboardSensor with sortableKeyboardCoordinates
- DndContext with closestCenter collision detection
- SortableContext with verticalListSortingStrategy
- handleDragEnd: arrayMove sections, update state, call updateSectionOrder server action
- Map sections to SortableSection components
- Handle empty state: "No sections yet. Add one to get started."

Install lucide-react if not present for icons (GripVertical, Eye, EyeOff, Pencil, Trash2)
  </action>
  <verify>
- Components render without hydration errors
- Drag handle is visible and cursor shows grab on hover
- Dragging a section shows smooth animation
  </verify>
  <done>Drag-and-drop section list with dnd-kit, supporting reorder, visibility toggle, and delete</done>
</task>

<task type="auto">
  <name>Task 3: Create content management page with add section dialog</name>
  <files>
    - src/app/(platform)/dashboard/content/page.tsx
    - src/components/content-builder/AddSectionDialog.tsx
  </files>
  <action>
Create src/components/content-builder/AddSectionDialog.tsx:
- "use client" directive
- Props: existingSectionTypes (string[]), onAdd (type: SectionType) => void
- Modal/dialog pattern (can use simple state-controlled div overlay)
- Shows grid of available section types
- For each type in SECTION_TYPES:
  - If already exists in existingSectionTypes, show disabled/grayed
  - Otherwise, clickable card with icon, name, description
- Clicking available type calls onAdd(type) and closes dialog
- Close button and click-outside-to-close

Create src/app/(platform)/dashboard/content/page.tsx:
- Server component wrapper that fetches wedding.contentSections
- Uses withTenantContext pattern
- Client component (ContentManager) for interactive parts
- Layout:
  - Header: "Content Sections" title
  - Add Section button (opens AddSectionDialog)
  - SortableSectionList with current sections
  - If no sections: prompt to add first section
- Handle loading states with useTransition for actions
- Show toast/feedback on successful actions (optional, can use simple state message)

Ensure sections are sorted by order field before passing to SortableSectionList.
  </action>
  <verify>
- /dashboard/content page loads showing current sections (may be empty initially)
- "Add Section" button opens dialog
- Dialog shows 6 section types
- Adding a section: appears in list, dialog closes
- Reordering: drag section, drop in new position, order persists on refresh
- Toggle visibility: icon changes, text updates
- Delete: confirmation, section removed
  </verify>
  <done>Content management page with add section dialog, drag-and-drop list, all CRUD operations functional</done>
</task>

</tasks>

<verification>
1. /dashboard/content page loads for logged-in couple
2. Add section flow:
   - Click "Add Section"
   - Dialog shows 6 section types
   - Click "Event Details"
   - Section appears in list
   - Refresh page - section persists
3. Reorder flow:
   - Add 3 sections (Event Details, Our Story, Gallery)
   - Drag "Gallery" to top
   - Release - order updates
   - Refresh page - new order persists
4. Visibility toggle:
   - Click eye icon on a section
   - Changes to hidden state
   - Refresh - visibility persists
5. Delete flow:
   - Click trash icon
   - Confirm deletion
   - Section removed from list
   - Refresh - section stays deleted
6. Database verification: wedding.contentSections JSON reflects all changes
</verification>

<success_criteria>
- Couple can view list of content sections on /dashboard/content
- Couple can add sections from available types (each type once)
- Drag-and-drop reordering works smoothly on desktop and mobile
- Section order persists to database
- Visibility toggle updates database
- Delete removes section from database
- All operations show appropriate feedback (loading state, success)
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-builder/03-04-SUMMARY.md`
</output>
