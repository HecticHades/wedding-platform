---
phase: 02-admin-couple-auth
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(platform)/admin/layout.tsx
  - src/app/(platform)/admin/page.tsx
  - src/app/(platform)/admin/weddings/page.tsx
  - src/app/(platform)/admin/weddings/new/page.tsx
  - src/app/(platform)/admin/weddings/new/actions.ts
  - src/app/(platform)/admin/weddings/[id]/page.tsx
  - src/app/(platform)/admin/weddings/[id]/actions.ts
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/layout.tsx
  - prisma/seed.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Admin can log in with email/password"
    - "Admin sees list of all wedding sites on platform"
    - "Admin can create new wedding site with couple account"
    - "Admin can view and edit existing wedding's content and settings"
    - "Non-admin users are redirected away from /admin routes"
  artifacts:
    - path: "src/app/(platform)/admin/page.tsx"
      provides: "Admin dashboard with wedding count"
      min_lines: 20
    - path: "src/app/(platform)/admin/weddings/page.tsx"
      provides: "Wedding list table"
      contains: "findMany"
    - path: "src/app/(platform)/admin/weddings/new/page.tsx"
      provides: "Create wedding form"
      contains: "form"
    - path: "src/app/(platform)/admin/weddings/[id]/page.tsx"
      provides: "View/edit wedding details"
      contains: "findUnique"
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login form with server action"
      contains: "signIn"
    - path: "prisma/seed.ts"
      provides: "Admin user seeding"
      contains: "role.*admin"
  key_links:
    - from: "src/app/(platform)/admin/page.tsx"
      to: "src/lib/auth/auth.ts"
      via: "auth() call"
      pattern: "import.*auth.*from.*auth"
    - from: "src/app/(platform)/admin/weddings/new/actions.ts"
      to: "prisma"
      via: "$transaction"
      pattern: "prisma\\.\\$transaction"
    - from: "src/app/(platform)/admin/weddings/[id]/page.tsx"
      to: "prisma"
      via: "findUnique query"
      pattern: "prisma\\.wedding\\.findUnique"

deferred:
  - requirement: "ADMIN-03"
    reason: "RSVP data infrastructure does not exist until Phase 5. Admin role is established in Phase 2; admin RSVP viewing capability will be added in Phase 5 when RSVP system is built."
---

<objective>
Build admin authentication and management dashboard

Purpose: Enable platform administrators to log in and manage all wedding sites. This includes viewing all weddings, creating new wedding sites, viewing/editing existing wedding details, and assigning couple accounts. The admin dashboard bypasses tenant context to access all platform data.

Output: Working admin login flow, admin dashboard showing all weddings, ability to create new wedding sites with associated couple accounts, and ability to view/edit any wedding's details.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/02-admin-couple-auth/02-RESEARCH.md

# From Plan 01 (will be available at execution time)
@wedding-platform/src/lib/auth/auth.ts
@wedding-platform/src/lib/auth/password.ts
@wedding-platform/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create login page and auth layout</name>
  <files>
    - src/app/(auth)/layout.tsx
    - src/app/(auth)/login/page.tsx
  </files>
  <action>
Create src/app/(auth)/layout.tsx - minimal centered layout for auth pages:
```typescript
export default function AuthLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
      <div className="w-full max-w-md">
        {children}
      </div>
    </div>
  )
}
```

Create src/app/(auth)/login/page.tsx with server action login:
- Import signIn from @/lib/auth/auth
- Import redirect from next/navigation
- Create server action `login(formData: FormData)`:
  1. Extract email and password from formData
  2. Call signIn("credentials", { email, password, redirect: false })
  3. If error, return (will handle error state in later phase)
  4. Check result, redirect to /dashboard or /admin based on role
- Form with email input (type="email", required), password input (type="password", required, minLength=8)
- Submit button "Sign In"
- Style with Tailwind: card with shadow, labels, inputs with border/rounded

NOTE: For the redirect after login, we need to fetch the session after successful signIn to check role. Use a two-step approach:
1. signIn with redirect: false
2. If no error, redirect to /dashboard (couple dashboard handles redirect to admin if needed)

Alternative cleaner approach: Use a client component with useRouter and signIn from next-auth/react for better UX. But for simplicity, use server action with redirect to /dashboard, and dashboard page checks role and redirects admin to /admin.
  </action>
  <verify>
- File src/app/(auth)/login/page.tsx exists with form and server action
- `npx tsc --noEmit` passes
- Form has accessible labels and inputs
  </verify>
  <done>Login page created with email/password form and server action that calls signIn</done>
</task>

<task type="auto">
  <name>Task 2: Create admin layout and dashboard page</name>
  <files>
    - src/app/(platform)/layout.tsx
    - src/app/(platform)/admin/layout.tsx
    - src/app/(platform)/admin/page.tsx
  </files>
  <action>
Create src/app/(platform)/layout.tsx - shared authenticated layout:
```typescript
import { auth } from "@/lib/auth/auth"
import { redirect } from "next/navigation"

export default async function PlatformLayout({ children }: { children: React.ReactNode }) {
  const session = await auth()
  if (!session) {
    redirect("/login")
  }
  return <>{children}</>
}
```

Create src/app/(platform)/admin/layout.tsx - admin-specific layout with role check and sign-out:
```typescript
import { auth, signOut } from "@/lib/auth/auth"
import { redirect } from "next/navigation"
import Link from "next/link"

export default async function AdminLayout({ children }: { children: React.ReactNode }) {
  const session = await auth()

  // Defense-in-depth: middleware checks, but verify here too (CVE-2025-29927)
  if (!session || session.user.role !== "admin") {
    redirect("/dashboard")
  }

  return (
    <div className="min-h-screen bg-gray-100">
      <nav className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16 items-center">
            <div className="flex space-x-8">
              <Link href="/admin" className="font-semibold text-gray-900">Admin</Link>
              <Link href="/admin/weddings" className="text-gray-600 hover:text-gray-900">Weddings</Link>
            </div>
            <div className="flex items-center space-x-4">
              <span className="text-sm text-gray-600">{session.user.email}</span>
              <form action={async () => {
                "use server"
                await signOut({ redirectTo: "/login" })
              }}>
                <button type="submit" className="text-sm text-gray-600 hover:text-gray-900">
                  Sign Out
                </button>
              </form>
            </div>
          </div>
        </div>
      </nav>
      <main className="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        {children}
      </main>
    </div>
  )
}
```

Create src/app/(platform)/admin/page.tsx - admin dashboard:
- Import auth from @/lib/auth/auth
- Import prisma from @/lib/db/prisma (NOT within tenant context - admin sees all)
- Fetch wedding count: prisma.wedding.count()
- Fetch user count: prisma.user.count()
- Display stats cards: Total Weddings, Total Users
- Link to /admin/weddings

IMPORTANT: Admin operations do NOT use withTenantContext(). The Prisma extension only adds tenant filter when getTenantContext() returns a value. For admin operations, no tenant context is set, so queries return all data.
  </action>
  <verify>
- All layout files created
- `npx tsc --noEmit` passes
- Admin layout checks role === "admin"
- Admin layout includes sign-out form action
  </verify>
  <done>Admin layout with sign-out and dashboard page created showing wedding/user counts</done>
</task>

<task type="auto">
  <name>Task 3: Create wedding list and create wedding pages</name>
  <files>
    - src/app/(platform)/admin/weddings/page.tsx
    - src/app/(platform)/admin/weddings/new/page.tsx
    - src/app/(platform)/admin/weddings/new/actions.ts
  </files>
  <action>
Create src/app/(platform)/admin/weddings/page.tsx - wedding list:
- Fetch all weddings with tenant: prisma.wedding.findMany({ include: { tenant: true }, orderBy: { createdAt: "desc" } })
- Display table with columns: Subdomain, Couple Names, Created, Actions
- Link to create new: /admin/weddings/new
- Each row links to edit: /admin/weddings/[id]

Create src/app/(platform)/admin/weddings/new/page.tsx - create wedding form:
- Form with fields: subdomain, partner1Name, partner2Name, coupleEmail, couplePassword
- Import createWeddingSite action
- Subdomain validation hint: lowercase letters, numbers, hyphens only
- Password hint: minimum 8 characters

Create src/app/(platform)/admin/weddings/new/actions.ts - server action:
```typescript
"use server"

import { auth } from "@/lib/auth/auth"
import { prisma } from "@/lib/db/prisma"
import { hashPassword } from "@/lib/auth/password"
import { redirect } from "next/navigation"
import { z } from "zod"

const createWeddingSchema = z.object({
  subdomain: z.string().min(3).max(63).regex(/^[a-z0-9-]+$/, "Lowercase letters, numbers, and hyphens only"),
  partner1Name: z.string().min(1, "Partner 1 name is required"),
  partner2Name: z.string().min(1, "Partner 2 name is required"),
  coupleEmail: z.string().email("Valid email required"),
  couplePassword: z.string().min(8, "Password must be at least 8 characters"),
})

export async function createWeddingSite(formData: FormData) {
  const session = await auth()

  if (!session || session.user.role !== "admin") {
    throw new Error("Unauthorized")
  }

  const parsed = createWeddingSchema.safeParse({
    subdomain: formData.get("subdomain"),
    partner1Name: formData.get("partner1Name"),
    partner2Name: formData.get("partner2Name"),
    coupleEmail: formData.get("coupleEmail"),
    couplePassword: formData.get("couplePassword"),
  })

  if (!parsed.success) {
    // In production, would return error state. For now, throw.
    throw new Error(parsed.error.errors.map(e => e.message).join(", "))
  }

  const data = parsed.data

  // Create tenant, wedding, and user in transaction
  await prisma.$transaction(async (tx) => {
    const tenant = await tx.tenant.create({
      data: {
        subdomain: data.subdomain,
        name: `${data.partner1Name} & ${data.partner2Name}`,
      },
    })

    await tx.wedding.create({
      data: {
        tenantId: tenant.id,
        partner1Name: data.partner1Name,
        partner2Name: data.partner2Name,
      },
    })

    await tx.user.create({
      data: {
        email: data.coupleEmail,
        hashedPassword: await hashPassword(data.couplePassword),
        name: `${data.partner1Name} & ${data.partner2Name}`,
        role: "couple",
        tenantId: tenant.id,
      },
    })
  })

  redirect("/admin/weddings")
}
```
  </action>
  <verify>
- All files created in src/app/(platform)/admin/weddings/
- `npx tsc --noEmit` passes
- createWeddingSite uses $transaction for atomicity
- Wedding list page links to /admin/weddings/[id] for each row
  </verify>
  <done>Wedding list page shows all weddings with edit links, create wedding form with atomic transaction</done>
</task>

<task type="auto">
  <name>Task 4: Create wedding detail/edit page for admin</name>
  <files>
    - src/app/(platform)/admin/weddings/[id]/page.tsx
    - src/app/(platform)/admin/weddings/[id]/actions.ts
  </files>
  <action>
Create src/app/(platform)/admin/weddings/[id]/page.tsx - view/edit wedding details:
```typescript
import { auth } from "@/lib/auth/auth"
import { prisma } from "@/lib/db/prisma"
import { redirect, notFound } from "next/navigation"
import Link from "next/link"
import { updateWeddingDetails } from "./actions"

interface Props {
  params: { id: string }
}

export default async function AdminWeddingDetailPage({ params }: Props) {
  const session = await auth()

  if (!session || session.user.role !== "admin") {
    redirect("/login")
  }

  const wedding = await prisma.wedding.findUnique({
    where: { id: params.id },
    include: {
      tenant: true,
    },
  })

  if (!wedding) {
    notFound()
  }

  // Find the couple user for this wedding
  const coupleUser = await prisma.user.findFirst({
    where: { tenantId: wedding.tenantId, role: "couple" },
  })

  return (
    <div>
      <div className="mb-6 flex items-center justify-between">
        <div>
          <Link href="/admin/weddings" className="text-blue-600 hover:text-blue-800 text-sm">
            ‚Üê Back to Weddings
          </Link>
          <h1 className="text-2xl font-bold text-gray-900 mt-2">
            {wedding.partner1Name} & {wedding.partner2Name}
          </h1>
          <p className="text-gray-600">Subdomain: {wedding.tenant.subdomain}</p>
        </div>
      </div>

      <div className="bg-white shadow rounded-lg p-6">
        <h2 className="text-lg font-semibold mb-4">Wedding Details</h2>

        <form action={updateWeddingDetails}>
          <input type="hidden" name="weddingId" value={wedding.id} />

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label htmlFor="partner1Name" className="block text-sm font-medium text-gray-700">
                Partner 1 Name
              </label>
              <input
                type="text"
                id="partner1Name"
                name="partner1Name"
                defaultValue={wedding.partner1Name}
                className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                required
              />
            </div>

            <div>
              <label htmlFor="partner2Name" className="block text-sm font-medium text-gray-700">
                Partner 2 Name
              </label>
              <input
                type="text"
                id="partner2Name"
                name="partner2Name"
                defaultValue={wedding.partner2Name}
                className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                required
              />
            </div>

            <div>
              <label htmlFor="weddingDate" className="block text-sm font-medium text-gray-700">
                Wedding Date
              </label>
              <input
                type="date"
                id="weddingDate"
                name="weddingDate"
                defaultValue={wedding.weddingDate ? new Date(wedding.weddingDate).toISOString().split('T')[0] : ''}
                className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>

            <div>
              <label htmlFor="subdomain" className="block text-sm font-medium text-gray-700">
                Subdomain
              </label>
              <input
                type="text"
                id="subdomain"
                name="subdomain"
                defaultValue={wedding.tenant.subdomain}
                pattern="^[a-z0-9-]+$"
                className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                required
              />
              <p className="mt-1 text-xs text-gray-500">Lowercase letters, numbers, and hyphens only</p>
            </div>
          </div>

          <div className="mt-6 border-t pt-6">
            <h3 className="text-md font-medium text-gray-900 mb-4">Couple Account</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-medium text-gray-700">
                  Couple Email
                </label>
                <p className="mt-1 text-gray-900">{coupleUser?.email || 'No account linked'}</p>
              </div>
            </div>
          </div>

          <div className="mt-6 flex justify-end">
            <button
              type="submit"
              className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  )
}
```

Create src/app/(platform)/admin/weddings/[id]/actions.ts - update action:
```typescript
"use server"

import { auth } from "@/lib/auth/auth"
import { prisma } from "@/lib/db/prisma"
import { redirect } from "next/navigation"
import { revalidatePath } from "next/cache"
import { z } from "zod"

const updateWeddingSchema = z.object({
  weddingId: z.string().min(1),
  partner1Name: z.string().min(1, "Partner 1 name is required"),
  partner2Name: z.string().min(1, "Partner 2 name is required"),
  subdomain: z.string().min(3).max(63).regex(/^[a-z0-9-]+$/, "Lowercase letters, numbers, and hyphens only"),
  weddingDate: z.string().optional(),
})

export async function updateWeddingDetails(formData: FormData) {
  const session = await auth()

  if (!session || session.user.role !== "admin") {
    throw new Error("Unauthorized")
  }

  const parsed = updateWeddingSchema.safeParse({
    weddingId: formData.get("weddingId"),
    partner1Name: formData.get("partner1Name"),
    partner2Name: formData.get("partner2Name"),
    subdomain: formData.get("subdomain"),
    weddingDate: formData.get("weddingDate") || undefined,
  })

  if (!parsed.success) {
    throw new Error(parsed.error.errors.map(e => e.message).join(", "))
  }

  const data = parsed.data

  // Get wedding to find tenantId
  const wedding = await prisma.wedding.findUnique({
    where: { id: data.weddingId },
  })

  if (!wedding) {
    throw new Error("Wedding not found")
  }

  // Update wedding and tenant in transaction
  await prisma.$transaction(async (tx) => {
    await tx.wedding.update({
      where: { id: data.weddingId },
      data: {
        partner1Name: data.partner1Name,
        partner2Name: data.partner2Name,
        weddingDate: data.weddingDate ? new Date(data.weddingDate) : null,
      },
    })

    await tx.tenant.update({
      where: { id: wedding.tenantId },
      data: {
        subdomain: data.subdomain,
        name: `${data.partner1Name} & ${data.partner2Name}`,
      },
    })
  })

  revalidatePath(`/admin/weddings/${data.weddingId}`)
  revalidatePath("/admin/weddings")
}
```

This task satisfies Success Criteria #3: "Admin can view and edit any couple's site content and settings"
  </action>
  <verify>
- src/app/(platform)/admin/weddings/[id]/page.tsx exists with edit form
- src/app/(platform)/admin/weddings/[id]/actions.ts exists with updateWeddingDetails
- `npx tsc --noEmit` passes
- Form allows editing partner names, wedding date, and subdomain
- Update uses $transaction for atomicity
  </verify>
  <done>Admin can view and edit any wedding's details including partner names, wedding date, and subdomain</done>
</task>

<task type="auto">
  <name>Task 5: Create seed script for initial admin user</name>
  <files>
    - prisma/seed.ts
    - package.json
  </files>
  <action>
Create prisma/seed.ts:
```typescript
import { PrismaClient } from "@prisma/client"
import bcrypt from "bcryptjs"

const prisma = new PrismaClient()

async function main() {
  // Create admin user if doesn't exist
  const adminEmail = process.env.ADMIN_EMAIL || "admin@wedding-platform.local"
  const adminPassword = process.env.ADMIN_PASSWORD || "admin123456"

  const existingAdmin = await prisma.user.findUnique({
    where: { email: adminEmail },
  })

  if (!existingAdmin) {
    const hashedPassword = await bcrypt.hash(adminPassword, 12)

    await prisma.user.create({
      data: {
        email: adminEmail,
        hashedPassword,
        name: "Platform Admin",
        role: "admin",
        // Admin has no tenantId - they access all tenants
      },
    })

    console.log(`Created admin user: ${adminEmail}`)
  } else {
    console.log(`Admin user already exists: ${adminEmail}`)
  }

  // Optionally create a test wedding
  const testSubdomain = "demo"
  const existingTenant = await prisma.tenant.findUnique({
    where: { subdomain: testSubdomain },
  })

  if (!existingTenant) {
    const tenant = await prisma.tenant.create({
      data: {
        subdomain: testSubdomain,
        name: "Demo Wedding",
      },
    })

    await prisma.wedding.create({
      data: {
        tenantId: tenant.id,
        partner1Name: "Alice",
        partner2Name: "Bob",
      },
    })

    const couplePassword = await bcrypt.hash("demo123456", 12)
    await prisma.user.create({
      data: {
        email: "demo@wedding-platform.local",
        hashedPassword: couplePassword,
        name: "Alice & Bob",
        role: "couple",
        tenantId: tenant.id,
      },
    })

    console.log("Created demo wedding: demo.localhost:3000")
    console.log("Demo couple login: demo@wedding-platform.local / demo123456")
  }
}

main()
  .then(async () => {
    await prisma.$disconnect()
  })
  .catch(async (e) => {
    console.error(e)
    await prisma.$disconnect()
    process.exit(1)
  })
```

Update package.json to add seed script in prisma config:
```json
{
  "prisma": {
    "seed": "npx tsx prisma/seed.ts"
  }
}
```

Also ensure tsx is available (may already be from Next.js):
```bash
npm install -D tsx
```
  </action>
  <verify>
- prisma/seed.ts exists with admin user creation
- package.json has prisma.seed configured
- `npx tsc --noEmit` passes (seed.ts compiles)
  </verify>
  <done>Seed script creates admin user and optional demo wedding, can be run with `npx prisma db seed`</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes
2. Login page renders at /login
3. Admin layout protects /admin/* routes with role check
4. Admin layout includes sign-out button
5. Admin dashboard page shows wedding/user counts
6. Wedding list page displays all weddings with links to detail pages
7. Create wedding form submits and creates tenant/wedding/user atomically
8. Wedding detail page allows viewing and editing wedding settings
9. Seed script compiles and can create admin user

NOTE: ADMIN-03 (view RSVP data) is deferred to Phase 5 when RSVP infrastructure exists. The admin role established here will be used for RSVP viewing in Phase 5.
</verification>

<success_criteria>
- Admin can access /login and submit credentials
- Admin role check in layout (defense-in-depth beyond middleware)
- Admin layout has sign-out button (parity with couple dashboard)
- Admin dashboard at /admin shows total weddings and users
- Admin can view list of all weddings at /admin/weddings
- Admin can create new wedding site at /admin/weddings/new
- Admin can view/edit wedding details at /admin/weddings/[id] (Success Criteria #3)
- Creating wedding atomically creates Tenant, Wedding, and User (couple)
- Updating wedding atomically updates Wedding and Tenant
- Seed script available to bootstrap admin account
- Non-admin users redirected away from /admin routes
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-couple-auth/02-02-SUMMARY.md`
</output>
