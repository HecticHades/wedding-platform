---
phase: 02-admin-couple-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/auth/auth.ts
  - src/lib/auth/auth.config.ts
  - src/lib/auth/password.ts
  - src/types/next-auth.d.ts
  - src/app/api/auth/[...nextauth]/route.ts
autonomous: true

must_haves:
  truths:
    - "Auth.js v5 is configured with credentials provider"
    - "JWT session strategy is used (Edge compatible)"
    - "User model stores role and tenantId in session"
    - "Password hashing uses bcryptjs with 12 rounds"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "User, Account, Session, VerificationToken models"
      contains: "model User"
    - path: "src/lib/auth/auth.ts"
      provides: "Auth.js configuration with callbacks"
      exports: ["auth", "signIn", "signOut", "handlers"]
    - path: "src/lib/auth/password.ts"
      provides: "Password hashing utilities"
      exports: ["hashPassword", "verifyPassword"]
    - path: "src/types/next-auth.d.ts"
      provides: "TypeScript augmentation for role and tenantId"
      contains: "declare module"
  key_links:
    - from: "src/lib/auth/auth.ts"
      to: "prisma/schema.prisma"
      via: "PrismaAdapter"
      pattern: "PrismaAdapter.*prisma"
    - from: "src/lib/auth/auth.ts"
      to: "src/lib/auth/password.ts"
      via: "verifyPassword import"
      pattern: "import.*verifyPassword.*password"
---

<objective>
Set up Auth.js v5 authentication infrastructure with Prisma adapter

Purpose: Establish the authentication foundation that admin and couple dashboards will use. This includes database schema for users, Auth.js configuration with JWT sessions, password hashing utilities, and TypeScript types.

Output: Working Auth.js v5 configuration that can authenticate users with email/password, store role and tenantId in session, and integrate with existing Prisma database.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/02-admin-couple-auth/02-RESEARCH.md

# Existing infrastructure from Phase 1
@wedding-platform/prisma/schema.prisma
@wedding-platform/src/lib/db/prisma.ts
@wedding-platform/src/lib/db/tenant-context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Auth.js dependencies and update Prisma schema</name>
  <files>
    - package.json
    - prisma/schema.prisma
  </files>
  <action>
Install required packages:
```bash
npm install next-auth@beta @auth/prisma-adapter bcryptjs zod
npm install -D @types/bcryptjs
```

Update prisma/schema.prisma to add User model with auth fields:
- id (cuid), email (unique), hashedPassword (optional for future OAuth), name (optional)
- role (String, default "couple") - values: "admin" or "couple"
- tenantId (optional, unique) - links couple to their tenant
- Add relation to Tenant model (optional, one-to-one for couples)
- Add Auth.js required fields: emailVerified, image
- Add relations: accounts, sessions

Add Account model (required by Auth.js Prisma adapter):
- id, userId, type, provider, providerAccountId, refresh_token, access_token, expires_at, token_type, scope, id_token, session_state
- Relation to User, unique constraint on [provider, providerAccountId]

Add Session model (required by Auth.js):
- id, sessionToken (unique), userId, expires
- Relation to User

Add VerificationToken model (required by Auth.js):
- identifier, token (unique), expires
- Unique constraint on [identifier, token]

Run `npx prisma generate` to update client types. Do NOT run migrate (DATABASE_URL may not be configured).

IMPORTANT: The existing Tenant model has `wedding Wedding?` relation. User.tenantId creates a separate one-to-one User-Tenant relation for couple accounts.
  </action>
  <verify>
- `npm ls next-auth` shows 5.0.0-beta.x installed
- `npm ls bcryptjs` shows 2.4.x installed
- `npx prisma validate` succeeds
- `npx prisma generate` succeeds
  </verify>
  <done>Auth.js packages installed, Prisma schema includes User/Account/Session/VerificationToken models with role and tenantId fields</done>
</task>

<task type="auto">
  <name>Task 2: Create password utilities and TypeScript types</name>
  <files>
    - src/lib/auth/password.ts
    - src/types/next-auth.d.ts
  </files>
  <action>
Create src/lib/auth/password.ts:
```typescript
import bcrypt from "bcryptjs"

const SALT_ROUNDS = 12

export async function hashPassword(password: string): Promise<string> {
  return bcrypt.hash(password, SALT_ROUNDS)
}

export async function verifyPassword(
  password: string,
  hashedPassword: string
): Promise<boolean> {
  return bcrypt.compare(password, hashedPassword)
}
```

Create src/types/next-auth.d.ts to extend Auth.js types:
```typescript
import { DefaultSession, DefaultUser } from "next-auth"
import { JWT, DefaultJWT } from "next-auth/jwt"

declare module "next-auth" {
  interface Session {
    user: {
      id: string
      role: "admin" | "couple"
      tenantId: string | null
    } & DefaultSession["user"]
  }

  interface User extends DefaultUser {
    role: "admin" | "couple"
    tenantId: string | null
  }
}

declare module "next-auth/jwt" {
  interface JWT extends DefaultJWT {
    role: "admin" | "couple"
    tenantId: string | null
  }
}
```

Update tsconfig.json to include the types directory if not already included.
  </action>
  <verify>
- `npx tsc --noEmit` passes without errors
- password.ts exports hashPassword and verifyPassword
- next-auth.d.ts declares role and tenantId on Session.user
  </verify>
  <done>Password hashing utilities created with bcryptjs, Auth.js TypeScript augmentation extends Session with role and tenantId</done>
</task>

<task type="auto">
  <name>Task 3: Create Auth.js configuration and API route</name>
  <files>
    - src/lib/auth/auth.ts
    - src/lib/auth/auth.config.ts
    - src/app/api/auth/[...nextauth]/route.ts
  </files>
  <action>
Create src/lib/auth/auth.config.ts (edge-compatible config without Prisma imports):
```typescript
import type { NextAuthConfig } from "next-auth"

export const authConfig: NextAuthConfig = {
  pages: {
    signIn: "/login",
  },
  callbacks: {
    authorized({ auth, request: { nextUrl } }) {
      const isLoggedIn = !!auth?.user
      const isAdmin = auth?.user?.role === "admin"

      // Admin routes require admin role
      if (nextUrl.pathname.startsWith("/admin")) {
        return isAdmin
      }

      // Dashboard requires login
      if (nextUrl.pathname.startsWith("/dashboard")) {
        return isLoggedIn
      }

      return true
    },
  },
  providers: [], // Providers added in full auth.ts
}
```

Create src/lib/auth/auth.ts with full configuration:
- Import NextAuth, PrismaAdapter, Credentials provider
- Import prisma from @/lib/db/prisma (the existing extended client)
- Import verifyPassword from ./password
- Use zod schema to validate credentials (email: email, password: min 8)
- Configure JWT session strategy
- Credentials provider authorize function:
  1. Parse and validate credentials with zod
  2. Find user by email with prisma.user.findUnique (no tenant context - platform-level)
  3. Verify password with verifyPassword
  4. Return user object with id, email, name, role, tenantId
- JWT callback: Copy role and tenantId from user to token
- Session callback: Copy id, role, tenantId from token to session.user
- Export { handlers, auth, signIn, signOut }

IMPORTANT: For admin operations (finding user by email during login), do NOT use withTenantContext. Admin and login operations are platform-level. The tenant context is only for couple-scoped data access.

Create src/app/api/auth/[...nextauth]/route.ts:
```typescript
import { handlers } from "@/lib/auth/auth"

export const { GET, POST } = handlers
```
  </action>
  <verify>
- `npx tsc --noEmit` passes
- src/lib/auth/auth.ts exports auth, signIn, signOut, handlers
- src/app/api/auth/[...nextauth]/route.ts exports GET and POST handlers
- No Prisma imports in auth.config.ts (edge-compatible)
  </verify>
  <done>Auth.js v5 configured with credentials provider, JWT strategy, role/tenantId in session callbacks, API route handler created</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds (or at least compiles without auth-related errors)
2. Auth.js route handler exists at /api/auth/[...nextauth]
3. TypeScript recognizes session.user.role and session.user.tenantId
4. Prisma schema validates and generates without errors
</verification>

<success_criteria>
- Auth.js v5 beta installed and configured
- Prisma schema extended with User, Account, Session, VerificationToken
- User model has role ("admin"/"couple") and tenantId fields
- Password utilities use bcryptjs with 12 salt rounds
- JWT session strategy configured (Edge runtime compatible)
- Session callbacks populate role and tenantId
- API route handler exports GET and POST
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-couple-auth/02-01-SUMMARY.md`
</output>
