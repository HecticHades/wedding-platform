---
phase: 02-admin-couple-auth
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(platform)/dashboard/layout.tsx
  - src/app/(platform)/dashboard/page.tsx
  - src/proxy.ts
autonomous: false

must_haves:
  truths:
    - "Couple can log in and see their wedding dashboard"
    - "Couple only sees data for their own wedding"
    - "Couple cannot access other tenants' data"
    - "Middleware redirects unauthenticated users to /login"
  artifacts:
    - path: "src/app/(platform)/dashboard/page.tsx"
      provides: "Couple dashboard with tenant-scoped data"
      contains: "withTenantContext"
    - path: "src/app/(platform)/dashboard/layout.tsx"
      provides: "Dashboard layout with tenant check"
      contains: "tenantId"
    - path: "src/proxy.ts"
      provides: "Updated middleware with auth integration"
      contains: "auth"
  key_links:
    - from: "src/app/(platform)/dashboard/page.tsx"
      to: "src/lib/db/tenant-context.ts"
      via: "withTenantContext wrapper"
      pattern: "withTenantContext.*session\\.user\\.tenantId"
    - from: "src/proxy.ts"
      to: "src/lib/auth/auth.ts"
      via: "auth() middleware wrapper"
      pattern: "auth.*middleware"
---

<objective>
Implement couple authentication with tenant-scoped dashboard

Purpose: Enable couples to log in and access only their own wedding data. This integrates authentication with the existing tenant context from Phase 1, ensuring couples can only see and modify their own wedding information while being completely isolated from other tenants.

Output: Working couple login flow, tenant-scoped dashboard, and middleware protection that enforces authentication on protected routes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/02-admin-couple-auth/02-RESEARCH.md

# From Plan 01 (will be available at execution time)
@wedding-platform/src/lib/auth/auth.ts
@wedding-platform/src/lib/auth/auth.config.ts

# Existing Phase 1 infrastructure
@wedding-platform/src/lib/db/tenant-context.ts
@wedding-platform/src/lib/db/prisma.ts
@wedding-platform/src/proxy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create couple dashboard with tenant context</name>
  <files>
    - src/app/(platform)/dashboard/layout.tsx
    - src/app/(platform)/dashboard/page.tsx
    - src/app/(platform)/dashboard/no-tenant/page.tsx
  </files>
  <action>
Create src/app/(platform)/dashboard/layout.tsx - couple dashboard layout:
```typescript
import { auth } from "@/lib/auth/auth"
import { redirect } from "next/navigation"
import Link from "next/link"
import { signOut } from "@/lib/auth/auth"

export default async function DashboardLayout({ children }: { children: React.ReactNode }) {
  const session = await auth()

  if (!session) {
    redirect("/login")
  }

  // If admin tries to access /dashboard, redirect to /admin
  if (session.user.role === "admin") {
    redirect("/admin")
  }

  // Couples must have a tenantId
  if (!session.user.tenantId) {
    redirect("/dashboard/no-tenant")
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <nav className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16 items-center">
            <div className="flex space-x-8">
              <Link href="/dashboard" className="font-semibold text-gray-900">Dashboard</Link>
            </div>
            <div className="flex items-center space-x-4">
              <span className="text-sm text-gray-600">{session.user.email}</span>
              <form action={async () => {
                "use server"
                await signOut({ redirectTo: "/login" })
              }}>
                <button type="submit" className="text-sm text-gray-600 hover:text-gray-900">
                  Sign Out
                </button>
              </form>
            </div>
          </div>
        </div>
      </nav>
      <main className="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        {children}
      </main>
    </div>
  )
}
```

Create src/app/(platform)/dashboard/page.tsx - couple's wedding dashboard:
```typescript
import { auth } from "@/lib/auth/auth"
import { redirect } from "next/navigation"
import { prisma, withTenantContext } from "@/lib/db/prisma"

export default async function CoupleDashboard() {
  const session = await auth()

  if (!session) {
    redirect("/login")
  }

  if (!session.user.tenantId) {
    redirect("/dashboard/no-tenant")
  }

  // Use tenant context to scope all queries to this couple's data
  const data = await withTenantContext(session.user.tenantId, async () => {
    const wedding = await prisma.wedding.findFirst({
      include: {
        tenant: true,
        guests: true,
        events: true,
      },
    })
    return { wedding }
  })

  if (!data.wedding) {
    return (
      <div className="text-center py-12">
        <h1 className="text-2xl font-bold text-gray-900">No Wedding Found</h1>
        <p className="mt-2 text-gray-600">Please contact support.</p>
      </div>
    )
  }

  const { wedding } = data

  return (
    <div>
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">
          {wedding.partner1Name} & {wedding.partner2Name}
        </h1>
        <p className="text-gray-600">
          Your wedding site: {wedding.tenant.subdomain}.localhost:3000
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div className="bg-white rounded-lg shadow p-6">
          <h3 className="text-lg font-medium text-gray-900">Guests</h3>
          <p className="mt-2 text-3xl font-bold text-blue-600">{wedding.guests.length}</p>
          <p className="text-sm text-gray-500">Total guests added</p>
        </div>

        <div className="bg-white rounded-lg shadow p-6">
          <h3 className="text-lg font-medium text-gray-900">Events</h3>
          <p className="mt-2 text-3xl font-bold text-green-600">{wedding.events.length}</p>
          <p className="text-sm text-gray-500">Events planned</p>
        </div>

        <div className="bg-white rounded-lg shadow p-6">
          <h3 className="text-lg font-medium text-gray-900">Wedding Date</h3>
          <p className="mt-2 text-lg font-medium text-gray-700">
            {wedding.weddingDate
              ? new Date(wedding.weddingDate).toLocaleDateString()
              : "Not set"}
          </p>
          <p className="text-sm text-gray-500">Your big day</p>
        </div>
      </div>

      <div className="mt-8">
        <h2 className="text-xl font-semibold text-gray-900 mb-4">Quick Actions</h2>
        <div className="flex flex-wrap gap-4">
          <span className="px-4 py-2 bg-gray-100 text-gray-500 rounded-lg">
            Manage Guests (Coming in Phase 4)
          </span>
          <span className="px-4 py-2 bg-gray-100 text-gray-500 rounded-lg">
            Edit Content (Coming in Phase 3)
          </span>
          <span className="px-4 py-2 bg-gray-100 text-gray-500 rounded-lg">
            View RSVPs (Coming in Phase 5)
          </span>
        </div>
      </div>
    </div>
  )
}
```

Create src/app/(platform)/dashboard/no-tenant/page.tsx - error page for users without tenant:
```typescript
export default function NoTenantPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="text-center">
        <h1 className="text-2xl font-bold text-gray-900">Account Not Configured</h1>
        <p className="mt-2 text-gray-600">
          Your account is not associated with a wedding site.
        </p>
        <p className="mt-1 text-gray-600">
          Please contact the platform administrator.
        </p>
      </div>
    </div>
  )
}
```

IMPORTANT: The key security mechanism is withTenantContext(session.user.tenantId, ...). This ensures:
1. The Prisma extension filters all queries by tenantId
2. Couples can ONLY see data for their assigned tenant
3. Even if they manipulate requests, the tenant context is derived from their authenticated session, not from URL or request params
  </action>
  <verify>
- All dashboard files created
- `npx tsc --noEmit` passes
- Dashboard uses withTenantContext with session.user.tenantId
- Layout checks for tenantId and redirects appropriately
  </verify>
  <done>Couple dashboard created with tenant-scoped data access, showing wedding stats and placeholder quick actions</done>
</task>

<task type="auto">
  <name>Task 2: Update proxy/middleware with authentication</name>
  <files>
    - src/proxy.ts
  </files>
  <action>
Update src/proxy.ts to integrate Auth.js middleware for route protection.

The existing proxy.ts handles subdomain routing. We need to add authentication checks for protected routes (/admin, /dashboard) while preserving subdomain rewriting for tenant sites.

Replace src/proxy.ts with:
```typescript
import { auth } from "@/lib/auth/auth"
import { NextResponse } from "next/server"

export default auth((req) => {
  const { nextUrl, auth: session } = req
  const isLoggedIn = !!session?.user
  const isAdmin = session?.user?.role === "admin"

  // Auth route protection
  if (nextUrl.pathname.startsWith("/admin")) {
    if (!isLoggedIn) {
      return NextResponse.redirect(new URL("/login", nextUrl.origin))
    }
    if (!isAdmin) {
      return NextResponse.redirect(new URL("/dashboard", nextUrl.origin))
    }
  }

  if (nextUrl.pathname.startsWith("/dashboard")) {
    if (!isLoggedIn) {
      return NextResponse.redirect(new URL("/login", nextUrl.origin))
    }
    // Admin trying to access dashboard goes to admin
    if (isAdmin) {
      return NextResponse.redirect(new URL("/admin", nextUrl.origin))
    }
  }

  // Redirect logged-in users away from login page
  if (nextUrl.pathname === "/login" && isLoggedIn) {
    const redirectTo = isAdmin ? "/admin" : "/dashboard"
    return NextResponse.redirect(new URL(redirectTo, nextUrl.origin))
  }

  // Subdomain routing (existing Phase 1 logic)
  const hostname = req.headers.get("host") || ""
  const rootDomain = process.env.NEXT_PUBLIC_ROOT_DOMAIN || "localhost:3000"

  let subdomain: string | null = null

  // Production: alice-bob.weddingplatform.com -> alice-bob
  if (hostname.endsWith(`.${rootDomain}`) && !hostname.startsWith("www.")) {
    subdomain = hostname.replace(`.${rootDomain}`, "")
  }

  // Development: alice-bob.localhost:3000 -> alice-bob
  if (hostname.includes("localhost") && hostname !== "localhost:3000" && hostname !== "localhost") {
    subdomain = hostname.split(".")[0]
  }

  // Subdomain detected - rewrite to tenant route
  if (subdomain) {
    return NextResponse.rewrite(new URL(`/${subdomain}${nextUrl.pathname}`, req.url))
  }

  return NextResponse.next()
})

export const config = {
  matcher: [
    // Match all paths except static files, api/auth, and Next.js internals
    "/((?!api/auth|_next/static|_next/image|favicon.ico|robots.txt|sitemap.xml).*)",
  ],
}
```

Key changes:
1. Wrap middleware with auth() to get session in request
2. Add auth checks BEFORE subdomain routing
3. Preserve subdomain rewriting for tenant sites
4. Add api/auth to matcher exclusions so Auth.js routes work

NOTE: The auth() wrapper from Auth.js v5 provides the session via req.auth. This is edge-compatible because we use JWT strategy (no database calls in middleware).
  </action>
  <verify>
- src/proxy.ts updated with auth() wrapper
- `npx tsc --noEmit` passes
- Matcher excludes api/auth routes
- Admin routes protected with role check
- Dashboard routes protected with login check
  </verify>
  <done>Middleware updated to integrate Auth.js, protects /admin and /dashboard routes, preserves subdomain routing</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete authentication system:
- Login page at /login
- Admin dashboard at /admin with wedding management
- Couple dashboard at /dashboard with tenant-scoped data
- Middleware protection for all protected routes
- Seed script for initial admin and demo couple
  </what-built>
  <how-to-verify>
**Prerequisites:**
1. Ensure DATABASE_URL is set in .env (PostgreSQL connection string)
2. Run migrations: `npx prisma migrate dev --name auth`
3. Run seed: `npx prisma db seed`
4. Start dev server: `npm run dev`

**Test admin flow:**
1. Visit http://localhost:3000/login
2. Log in with: admin@wedding-platform.local / admin123456
3. Verify redirect to /admin dashboard
4. Verify you see "Total Weddings" and "Total Users" counts
5. Click "Weddings" in nav
6. Verify you see the demo wedding (if seeded)
7. Click "Create Wedding" and create a test wedding

**Test couple flow:**
1. Sign out (or open incognito)
2. Visit http://localhost:3000/login
3. Log in with: demo@wedding-platform.local / demo123456
4. Verify redirect to /dashboard
5. Verify you see "Alice & Bob" wedding dashboard
6. Verify you see guest count, event count, wedding date

**Test isolation:**
1. While logged in as demo couple, try visiting /admin
2. Verify redirect back to /dashboard (not allowed)
3. While logged in as admin, try visiting /dashboard
4. Verify redirect to /admin

**Test tenant scoping:**
1. Create a second wedding via admin (e.g., subdomain: "test2")
2. Log in as the new couple
3. Verify they only see their wedding, not the demo wedding
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes
2. Login redirects appropriately based on role
3. Admin sees all weddings, can create new ones
4. Couple sees only their own wedding data
5. Middleware protects routes and handles subdomain routing
6. Tenant isolation verified - couples can't see each other's data
</verification>

<success_criteria>
- Couple can log in via /login with email/password
- Couple is redirected to /dashboard after login
- Couple dashboard shows only their wedding's data (tenant-scoped)
- Couple cannot access /admin routes (redirected to /dashboard)
- Admin cannot access /dashboard (redirected to /admin)
- Unauthenticated users redirected to /login for protected routes
- Subdomain routing still works for public wedding sites
- Middleware integrates auth checks with existing subdomain logic
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-couple-auth/02-03-SUMMARY.md`
</output>
