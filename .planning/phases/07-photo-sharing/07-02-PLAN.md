---
phase: 07-photo-sharing
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/(platform)/dashboard/photos/page.tsx
  - src/app/(platform)/dashboard/photos/actions.ts
  - src/app/(platform)/dashboard/photos/upload/page.tsx
  - src/app/(platform)/dashboard/photos/moderation/page.tsx
  - src/app/(platform)/dashboard/photos/settings/page.tsx
  - src/components/photos/PhotoModerationList.tsx
  - src/components/photos/PhotoModerationCard.tsx
  - src/components/photos/PhotoUploadQRCode.tsx
  - src/lib/photos/photo-utils.ts
autonomous: true

must_haves:
  truths:
    - "Couple can upload their own wedding photos from dashboard"
    - "Couple can see pending guest photos awaiting moderation"
    - "Couple can approve or reject guest photos"
    - "Couple can enable/disable photo sharing"
    - "QR code is displayed for guests to access photo upload"
  artifacts:
    - path: "src/app/(platform)/dashboard/photos/page.tsx"
      provides: "Photo management dashboard overview"
      min_lines: 40
    - path: "src/app/(platform)/dashboard/photos/actions.ts"
      provides: "Server actions for photo operations"
      exports: ["moderatePhoto", "bulkModerate", "updatePhotoSettings", "deletePhoto"]
    - path: "src/app/(platform)/dashboard/photos/moderation/page.tsx"
      provides: "Guest photo moderation queue"
      min_lines: 30
    - path: "src/components/photos/PhotoModerationCard.tsx"
      provides: "Individual photo with approve/reject buttons"
      min_lines: 30
    - path: "src/components/photos/PhotoUploadQRCode.tsx"
      provides: "QR code linking to guest upload page"
      min_lines: 20
  key_links:
    - from: "src/app/(platform)/dashboard/photos/moderation/page.tsx"
      to: "src/app/(platform)/dashboard/photos/actions.ts"
      via: "server action import"
      pattern: "import.*actions"
    - from: "src/components/photos/PhotoModerationCard.tsx"
      to: "src/app/(platform)/dashboard/photos/actions.ts"
      via: "moderatePhoto action"
      pattern: "moderatePhoto"
---

<objective>
Build the couple's photo management dashboard with upload, moderation, and QR code features.

Purpose: Enable couples to upload their own wedding photos, moderate guest submissions, and generate QR codes for guest access.
Output: Dashboard pages for photo management, moderation queue, settings, server actions, and QR code component.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/07-photo-sharing/07-RESEARCH.md
@wedding-platform/.planning/phases/07-photo-sharing/07-01-SUMMARY.md
@wedding-platform/src/app/(platform)/dashboard/registry/page.tsx
@wedding-platform/src/app/(platform)/dashboard/registry/actions.ts
@wedding-platform/src/components/registry/PaymentQRCode.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create photo utility functions and server actions</name>
  <files>src/lib/photos/photo-utils.ts, src/app/(platform)/dashboard/photos/actions.ts</files>
  <action>
1. Create src/lib/photos/photo-utils.ts with helper functions:
```typescript
// Photo status config for display
export const photoStatusConfig = {
  PENDING: { label: "Pending Review", color: "bg-yellow-100 text-yellow-800" },
  APPROVED: { label: "Approved", color: "bg-green-100 text-green-800" },
  REJECTED: { label: "Rejected", color: "bg-red-100 text-red-800" },
} as const;

// Generate photo upload URL for QR code
export function getPhotoUploadUrl(subdomain: string, baseUrl: string): string {
  // Handle localhost vs production
  if (baseUrl.includes("localhost")) {
    return `http://${subdomain}.localhost:3000/photos/upload`;
  }
  // Production: extract domain from baseUrl
  const url = new URL(baseUrl);
  return `https://${subdomain}.${url.host}/photos/upload`;
}
```

2. Create src/app/(platform)/dashboard/photos/actions.ts with server actions:
- `moderatePhoto(photoId: string, action: "approve" | "reject")` - Update single photo status
- `bulkModerate(photoIds: string[], action: "approve" | "reject")` - Update multiple photos
- `updatePhotoSettings(enabled: boolean)` - Toggle photoSharingEnabled on wedding
- `deletePhoto(photoId: string)` - Delete a guest photo (and blob)
- `getCouplePhotos()` - Get couple's own photos from contentSections gallery
- `getPendingPhotosCount()` - Get count of pending guest photos

Each action must:
- Validate session with `auth()`
- Verify tenant context
- Use tenant-scoped prisma queries
- Call `revalidatePath` after mutations
  </action>
  <verify>TypeScript compiles without errors: `cd wedding-platform && npx tsc --noEmit`</verify>
  <done>Photo utils and server actions exist with tenant-scoped queries and proper error handling</done>
</task>

<task type="auto">
  <name>Task 2: Create photo dashboard pages</name>
  <files>src/app/(platform)/dashboard/photos/page.tsx, src/app/(platform)/dashboard/photos/upload/page.tsx, src/app/(platform)/dashboard/photos/settings/page.tsx, src/app/(platform)/dashboard/photos/moderation/page.tsx</files>
  <action>
1. Create src/app/(platform)/dashboard/photos/page.tsx (overview):
- Show stats: total couple photos, pending guest photos, approved guest photos
- Quick links to Upload, Moderation, Settings
- Display most recent guest photos (5 max)
- Show QR code preview for photo uploads

2. Create src/app/(platform)/dashboard/photos/upload/page.tsx:
- Reuse existing upload pattern from GalleryEditor
- Uses /api/upload route (same as existing gallery)
- Shows uploaded couple photos grid
- Note: These photos are stored in contentSections JSON (gallery content)

3. Create src/app/(platform)/dashboard/photos/settings/page.tsx:
- Toggle to enable/disable photo sharing
- Display QR code with download option
- Show guest upload URL for manual sharing
- Explanation of moderation workflow

4. Create src/app/(platform)/dashboard/photos/moderation/page.tsx:
- Fetch pending GuestPhoto records
- Display PhotoModerationList component
- Bulk approve/reject actions
- Filter tabs: Pending | Approved | Rejected

Layout pattern: Follow existing dashboard pages (e.g., registry pages with tabs)
  </action>
  <verify>Navigate to /dashboard/photos in browser shows overview page without errors</verify>
  <done>All four photo dashboard pages render correctly with proper data</done>
</task>

<task type="auto">
  <name>Task 3: Create photo moderation and QR code components</name>
  <files>src/components/photos/PhotoModerationList.tsx, src/components/photos/PhotoModerationCard.tsx, src/components/photos/PhotoUploadQRCode.tsx</files>
  <action>
1. Create src/components/photos/PhotoModerationCard.tsx:
- Display photo thumbnail using Next.js Image
- Show uploadedBy name and uploadedAt timestamp
- Show current status badge (using photoStatusConfig)
- Approve button (green) and Reject button (red)
- Loading state during moderation action
- Checkbox for bulk selection

2. Create src/components/photos/PhotoModerationList.tsx:
- Grid layout (3 cols on desktop, 2 on tablet, 1 on mobile)
- Map over photos to render PhotoModerationCard
- Bulk action bar when photos selected
- Empty state when no photos to review
- Props: photos, onModerate, selectedIds, onSelectionChange

3. Create src/components/photos/PhotoUploadQRCode.tsx:
- Import QRCodeSVG from qrcode.react (already installed)
- Generate URL using getPhotoUploadUrl helper
- Size: 200px with medium error correction (level="M")
- Include margin for print-friendly output
- Add "Scan to share your photos" caption
- Download button to save QR code as PNG
  </action>
  <verify>Components render in moderation page without TypeScript errors</verify>
  <done>Moderation list shows photos with approve/reject buttons, QR code displays and can be downloaded</done>
</task>

</tasks>

<verification>
1. `/dashboard/photos` shows overview with stats and quick links
2. `/dashboard/photos/upload` shows couple photo upload interface
3. `/dashboard/photos/moderation` shows pending guest photos
4. `/dashboard/photos/settings` shows enable toggle and QR code
5. Approve/reject actions update photo status in database
6. QR code encodes correct URL for guest upload page
7. All pages have proper loading states and error handling
</verification>

<success_criteria>
- Couple can access photo dashboard from main dashboard navigation
- Couple can enable/disable photo sharing for their wedding
- Couple can see pending guest photo count at a glance
- Couple can approve or reject individual guest photos
- Couple can bulk approve/reject multiple photos
- QR code displays correct URL and can be downloaded for printing
- Rejected photos no longer appear in pending queue
- Approved photos will appear in public gallery (verified in Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/07-photo-sharing/07-02-SUMMARY.md`
</output>
