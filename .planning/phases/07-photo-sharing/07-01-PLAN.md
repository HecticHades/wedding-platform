---
phase: 07-photo-sharing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/types/prisma-json.d.ts
  - next.config.ts
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "GuestPhoto model exists with moderation status (PENDING, APPROVED, REJECTED)"
    - "Wedding model has photo sharing settings"
    - "Next.js Image can render Vercel Blob URLs"
    - "yet-another-react-lightbox is installed"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "GuestPhoto model and PhotoStatus enum"
      contains: "model GuestPhoto"
    - path: "src/types/prisma-json.d.ts"
      provides: "PhotoSettings type definition"
      contains: "PhotoSettings"
    - path: "next.config.ts"
      provides: "Vercel Blob remote patterns"
      contains: "blob.vercel-storage.com"
    - path: "package.json"
      provides: "yet-another-react-lightbox dependency"
      contains: "yet-another-react-lightbox"
  key_links:
    - from: "prisma/schema.prisma"
      to: "database"
      via: "prisma db push"
      pattern: "model GuestPhoto"
---

<objective>
Set up database schema and dependencies for photo sharing feature.

Purpose: Establish the data model for guest photos with moderation workflow, and configure packages needed for enhanced photo gallery viewing.
Output: GuestPhoto model, PhotoStatus enum, Wedding photo settings, installed lightbox package, Next.js image remote patterns.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/07-photo-sharing/07-RESEARCH.md
@wedding-platform/prisma/schema.prisma
@wedding-platform/src/types/prisma-json.d.ts
@wedding-platform/next.config.ts
@wedding-platform/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install yet-another-react-lightbox package</name>
  <files>package.json, package-lock.json</files>
  <action>
Install the lightbox package for enhanced gallery viewing:
```bash
cd wedding-platform && npm install yet-another-react-lightbox
```

This package provides:
- Full-screen photo viewing
- Swipe navigation on mobile
- Zoom capability
- Thumbnail strip
- Keyboard navigation
  </action>
  <verify>Run `npm ls yet-another-react-lightbox` shows version ^3.x installed</verify>
  <done>yet-another-react-lightbox is in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Add GuestPhoto model and update Wedding schema</name>
  <files>prisma/schema.prisma, src/types/prisma-json.d.ts</files>
  <action>
1. Add PhotoStatus enum to prisma/schema.prisma:
```prisma
enum PhotoStatus {
  PENDING    // Awaiting couple review
  APPROVED   // Visible in gallery
  REJECTED   // Hidden from gallery
}
```

2. Add GuestPhoto model to prisma/schema.prisma:
```prisma
model GuestPhoto {
  id          String      @id @default(cuid())
  weddingId   String
  wedding     Wedding     @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  url         String              // Vercel Blob URL
  caption     String?             // Optional caption from guest
  uploadedBy  String?             // Guest name (optional)

  // Moderation
  status      PhotoStatus @default(PENDING)
  reviewedAt  DateTime?

  // Metadata
  uploadedAt  DateTime    @default(now())

  @@index([weddingId])
  @@index([weddingId, status])
}
```

3. Update Wedding model to add photo sharing settings and relation:
- Add `photoSharingEnabled Boolean @default(false)` field
- Add `guestPhotos GuestPhoto[]` relation

4. Update src/types/prisma-json.d.ts to add PhotoSettings type (even though not using JSON for this, keep types consistent):
```typescript
interface PhotoSettings {
  enabled: boolean;
  allowGuestUploads: boolean;
  requireModeration: boolean;
}
```

5. Run `npx prisma db push` to apply schema changes
6. Run `npx prisma generate` to update Prisma client
  </action>
  <verify>Run `npx prisma db push --accept-data-loss` completes without errors. Check `npx prisma studio` shows GuestPhoto table.</verify>
  <done>GuestPhoto model exists in database with PhotoStatus enum, Wedding has photoSharingEnabled field and guestPhotos relation</done>
</task>

<task type="auto">
  <name>Task 3: Configure Next.js image remote patterns for Vercel Blob</name>
  <files>next.config.ts</files>
  <action>
Update next.config.ts to allow Next.js Image component to render images from Vercel Blob storage:

```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: "https",
        hostname: "*.public.blob.vercel-storage.com",
      },
    ],
  },
};

export default nextConfig;
```

This is required because:
- Vercel Blob stores images at `*.public.blob.vercel-storage.com`
- Next.js Image component blocks remote images not in allowlist
- Without this config, gallery images will fail to load with "hostname not allowed" error
  </action>
  <verify>Run `npm run build` to verify config is valid. No "Invalid next.config.ts" errors.</verify>
  <done>next.config.ts has remotePatterns configured for Vercel Blob hostnames</done>
</task>

</tasks>

<verification>
1. `npm ls yet-another-react-lightbox` shows package installed
2. `npx prisma db push` completed successfully
3. `npx prisma studio` shows GuestPhoto table with id, weddingId, url, caption, uploadedBy, status, reviewedAt, uploadedAt columns
4. Wedding table has photoSharingEnabled column
5. `npm run build` succeeds with new next.config.ts
</verification>

<success_criteria>
- GuestPhoto model exists with PENDING/APPROVED/REJECTED status enum
- Wedding model has photoSharingEnabled boolean field
- guestPhotos relation connects Wedding to GuestPhoto
- yet-another-react-lightbox is installed
- Next.js Image configured to allow Vercel Blob URLs
- Prisma client regenerated with new types
</success_criteria>

<output>
After completion, create `.planning/phases/07-photo-sharing/07-01-SUMMARY.md`
</output>
