---
phase: 07-photo-sharing
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/[domain]/photos/page.tsx
  - src/app/[domain]/photos/upload/page.tsx
  - src/app/[domain]/photos/upload/actions.ts
  - src/app/api/photos/upload/route.ts
  - src/components/photos/PhotoGallery.tsx
  - src/components/photos/PhotoCard.tsx
  - src/components/photos/PhotoLightbox.tsx
  - src/components/photos/GuestUploader.tsx
autonomous: true

must_haves:
  truths:
    - "Guest can view all wedding photos (couple + approved guest photos)"
    - "Guest can click photo to open full-screen lightbox"
    - "Guest can upload their own photos from event"
    - "Guest photos are created with PENDING status"
    - "Guest upload works for photos larger than 4.5MB"
  artifacts:
    - path: "src/app/[domain]/photos/page.tsx"
      provides: "Public photo gallery page"
      min_lines: 40
    - path: "src/app/[domain]/photos/upload/page.tsx"
      provides: "Guest photo upload page (QR code destination)"
      min_lines: 30
    - path: "src/app/api/photos/upload/route.ts"
      provides: "Client upload handler for large files"
      exports: ["POST"]
    - path: "src/components/photos/PhotoGallery.tsx"
      provides: "Combined gallery with couple and guest photos"
      min_lines: 50
    - path: "src/components/photos/GuestUploader.tsx"
      provides: "Client-side upload form for guests"
      min_lines: 40
  key_links:
    - from: "src/components/photos/GuestUploader.tsx"
      to: "src/app/api/photos/upload/route.ts"
      via: "@vercel/blob/client upload"
      pattern: "handleUploadUrl.*api/photos/upload"
    - from: "src/app/api/photos/upload/route.ts"
      to: "prisma.guestPhoto"
      via: "onUploadCompleted callback"
      pattern: "prisma\\.guestPhoto\\.create"
---

<objective>
Build the public photo gallery and guest upload system with client-side large file support.

Purpose: Enable guests to view wedding photos and upload their own photos from the event, using client-side uploads to bypass serverless size limits.
Output: Public gallery page with lightbox viewing, guest upload page with multi-file support, client upload API handler.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/07-photo-sharing/07-RESEARCH.md
@wedding-platform/.planning/phases/07-photo-sharing/07-01-SUMMARY.md
@wedding-platform/src/app/[domain]/registry/page.tsx
@wedding-platform/src/components/content/sections/GallerySection.tsx
@wedding-platform/src/app/api/upload/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create client upload API route for guest photos</name>
  <files>src/app/api/photos/upload/route.ts, src/app/[domain]/photos/upload/actions.ts</files>
  <action>
1. Create src/app/api/photos/upload/route.ts using Vercel Blob client upload pattern:
```typescript
import { handleUpload, type HandleUploadBody } from "@vercel/blob/client";
import { NextResponse } from "next/server";
import { prisma } from "@/lib/db/prisma";

export async function POST(request: Request): Promise<NextResponse> {
  const body = (await request.json()) as HandleUploadBody;

  try {
    const jsonResponse = await handleUpload({
      body,
      request,
      onBeforeGenerateToken: async (pathname, clientPayload) => {
        // Parse client payload (weddingId, guestName)
        const payload = clientPayload ? JSON.parse(clientPayload) : {};

        // Validate wedding exists and photo sharing is enabled
        const wedding = await prisma.wedding.findUnique({
          where: { id: payload.weddingId },
          select: { photoSharingEnabled: true },
        });

        if (!wedding?.photoSharingEnabled) {
          throw new Error("Photo sharing is not enabled for this wedding");
        }

        return {
          allowedContentTypes: ["image/jpeg", "image/png", "image/webp", "image/heic"],
          maximumSizeInBytes: 20 * 1024 * 1024, // 20MB for high-res photos
          addRandomSuffix: true,
          tokenPayload: JSON.stringify(payload),
        };
      },
      onUploadCompleted: async ({ blob, tokenPayload }) => {
        // Create GuestPhoto record after successful upload
        const payload = tokenPayload ? JSON.parse(tokenPayload) : {};

        await prisma.guestPhoto.create({
          data: {
            weddingId: payload.weddingId,
            url: blob.url,
            uploadedBy: payload.guestName || "Anonymous",
            status: "PENDING",
          },
        });
      },
    });

    return NextResponse.json(jsonResponse);
  } catch (error) {
    return NextResponse.json(
      { error: (error as Error).message },
      { status: 400 }
    );
  }
}
```

2. Create src/app/[domain]/photos/upload/actions.ts with fallback action:
- `createGuestPhotoRecord(weddingId, url, guestName)` - Fallback for local dev where onUploadCompleted doesn't fire
- This allows testing without ngrok by creating record after client gets blob URL

Note: onUploadCompleted requires public URL to callback. For local dev, use fallback action.
  </action>
  <verify>TypeScript compiles: `cd wedding-platform && npx tsc --noEmit`</verify>
  <done>Client upload route handles token generation and photo record creation</done>
</task>

<task type="auto">
  <name>Task 2: Create guest upload page and uploader component</name>
  <files>src/app/[domain]/photos/upload/page.tsx, src/components/photos/GuestUploader.tsx</files>
  <action>
1. Create src/components/photos/GuestUploader.tsx (client component):
```typescript
"use client";

import { upload } from "@vercel/blob/client";
import { useState, useRef } from "react";
// Import fallback action for local dev

interface GuestUploaderProps {
  weddingId: string;
}

export function GuestUploader({ weddingId }: GuestUploaderProps) {
  const [guestName, setGuestName] = useState("");
  const [isUploading, setIsUploading] = useState(false);
  const [uploadCount, setUploadCount] = useState(0);
  const [error, setError] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleUpload = async (files: FileList) => {
    setIsUploading(true);
    setError(null);

    for (const file of Array.from(files)) {
      try {
        const blob = await upload(file.name, file, {
          access: "public",
          handleUploadUrl: "/api/photos/upload",
          clientPayload: JSON.stringify({
            weddingId,
            guestName: guestName || "Anonymous",
          }),
        });

        // For local dev: call fallback action if needed
        // await createGuestPhotoRecord(weddingId, blob.url, guestName);

        setUploadCount((c) => c + 1);
      } catch (err) {
        setError(`Failed to upload ${file.name}`);
        console.error("Upload error:", err);
      }
    }

    setIsUploading(false);
    if (fileInputRef.current) {
      fileInputRef.current.value = "";
    }
  };

  return (
    // Form with name input, file input, upload button
    // Progress indicator
    // Success message with upload count
    // Error display
  );
}
```

2. Create src/app/[domain]/photos/upload/page.tsx:
- Fetch wedding by tenant subdomain (from params.domain)
- Check if photoSharingEnabled is true
- If disabled, show "Photo uploads are not available" message
- If enabled, render GuestUploader component
- Show couple names and "Share your photos from our wedding!"
- Mobile-optimized layout (this is the QR code destination)
  </action>
  <verify>Navigate to /photos/upload on a wedding subdomain, page renders without errors</verify>
  <done>Guest can access upload page and upload photos via client-side upload</done>
</task>

<task type="auto">
  <name>Task 3: Create public photo gallery with lightbox</name>
  <files>src/app/[domain]/photos/page.tsx, src/components/photos/PhotoGallery.tsx, src/components/photos/PhotoCard.tsx, src/components/photos/PhotoLightbox.tsx</files>
  <action>
1. Create src/components/photos/PhotoLightbox.tsx:
- Import Lightbox from "yet-another-react-lightbox"
- Import "yet-another-react-lightbox/styles.css"
- Import Zoom and Thumbnails plugins
- Props: photos, initialIndex, open, onClose
- Convert photos to slides format ({ src, alt, title })

2. Create src/components/photos/PhotoCard.tsx:
- Display photo thumbnail with Next.js Image (aspect-square)
- Hover effect (scale-105)
- Caption below image if exists
- Optional badge showing "Guest photo" vs couple photo
- onClick handler to open lightbox

3. Create src/components/photos/PhotoGallery.tsx:
- Combine couple photos (from contentSections gallery) and approved guest photos
- Sort by date (most recent first) or interleave
- Responsive grid (1 col mobile, 2 tablet, 3 desktop)
- State for lightbox open/index
- Map photos to PhotoCard components
- PhotoLightbox component at bottom
- Empty state if no photos

4. Create src/app/[domain]/photos/page.tsx:
- Fetch wedding with tenant context
- Extract gallery content from contentSections
- Fetch approved GuestPhoto records
- Render PhotoGallery component
- Link to upload page if sharing enabled
- Page title: "Photos" or "Our Wedding Photos"
- Back link to main wedding page
  </action>
  <verify>Navigate to /photos on a wedding subdomain, gallery displays with lightbox working</verify>
  <done>Public gallery shows couple + approved guest photos, clicking opens full-screen lightbox with navigation</done>
</task>

</tasks>

<verification>
1. Guest can access `/photos` page and see photo gallery
2. Gallery shows couple photos from existing gallery content section
3. Gallery shows approved guest photos mixed with couple photos
4. Clicking any photo opens full-screen lightbox
5. Lightbox has zoom and swipe navigation on mobile
6. Guest can access `/photos/upload` page via QR code URL
7. Guest can enter their name (optional) and select photos
8. Upload works for photos >4.5MB (test with 5-10MB photo)
9. Uploaded photos appear in couple's moderation queue (Plan 02)
10. Photos have PENDING status until approved
</verification>

<success_criteria>
- PHOTO-02: Guest can view shared wedding photos - Gallery displays all photos
- PHOTO-03: Guest can upload their own photos - Client upload works for large files
- PHOTO-04: QR code destination works - /photos/upload page is mobile-friendly
- Guest photos created with PENDING status by default
- Lightbox provides zoom and navigation for better viewing
- Upload page handles multiple file selection
- Error handling for failed uploads with user feedback
</success_criteria>

<output>
After completion, create `.planning/phases/07-photo-sharing/07-03-SUMMARY.md`
</output>
