---
phase: 09-seating-chart
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - wedding-platform/src/app/(platform)/dashboard/seating/print/page.tsx
  - wedding-platform/src/components/seating/SeatingPrintView.tsx
  - wedding-platform/src/app/api/seating/export/route.ts
  - wedding-platform/src/app/[domain]/seating/page.tsx
  - wedding-platform/src/app/(platform)/dashboard/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Couple can view print-optimized seating chart"
    - "Browser print dialog produces clean PDF"
    - "Couple can download CSV with seating data"
    - "Guest can see their table assignment after RSVP"
    - "Seating appears in dashboard navigation"
  artifacts:
    - path: "wedding-platform/src/app/(platform)/dashboard/seating/print/page.tsx"
      provides: "Print-optimized seating view"
      min_lines: 30
    - path: "wedding-platform/src/app/api/seating/export/route.ts"
      provides: "CSV export endpoint"
      exports: ["GET"]
    - path: "wedding-platform/src/app/[domain]/seating/page.tsx"
      provides: "Guest seating view"
      min_lines: 40
  key_links:
    - from: "print/page.tsx"
      to: "browser print"
      via: "window.print() call"
      pattern: "window\\.print"
    - from: "export/route.ts"
      to: "papaparse"
      via: "CSV generation"
      pattern: "Papa\\.unparse"
---

<objective>
Create export capabilities and guest-facing seating view.

Purpose: Enable couples to print/export seating charts for venue and let guests see their table assignment.
Output: Print view, CSV export endpoint, guest seating page, dashboard navigation update.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/09-seating-chart/09-RESEARCH.md
@wedding-platform/.planning/phases/09-seating-chart/09-01-SUMMARY.md

# Existing export patterns
@wedding-platform/src/app/api/rsvp/export/route.ts
@wedding-platform/src/app/[domain]/rsvp/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create print view page and component</name>
  <files>
wedding-platform/src/app/(platform)/dashboard/seating/print/page.tsx
wedding-platform/src/components/seating/SeatingPrintView.tsx
  </files>
  <action>
**SeatingPrintView.tsx:**
Print-optimized layout component:
- Tables displayed in grid (2-3 columns for print)
- Each table shows: name, guest list with plus-ones, headcount
- Clean typography, no interactive elements
- CSS classes for print: `print:bg-white`, `print:text-black`

**print/page.tsx:**
```typescript
import { auth } from "@/lib/auth/auth";
import { redirect } from "next/navigation";
import { SeatingPrintView } from "@/components/seating/SeatingPrintView";
// ... imports

export default async function SeatingPrintPage() {
  const session = await auth();
  if (!session?.user.tenantId) redirect("/dashboard/no-tenant");

  const tables = await getTablesWithGuests(session.user.tenantId);
  const wedding = await getWeddingInfo(session.user.tenantId);

  return (
    <>
      {/* Screen-only header */}
      <div className="print:hidden p-4 bg-white border-b sticky top-0 flex justify-between items-center">
        <h1 className="text-lg font-semibold">Seating Chart - Print Preview</h1>
        <div className="flex gap-2">
          <button
            onClick={() => window.print()}
            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
          >
            Print / Save as PDF
          </button>
          <Link href="/dashboard/seating" className="px-4 py-2 border rounded hover:bg-gray-50">
            Back to Seating
          </Link>
        </div>
      </div>

      {/* Print content */}
      <div className="p-8 print:p-0">
        <SeatingPrintView tables={tables} weddingName={wedding.partner1Name + " & " + wedding.partner2Name} />
      </div>
    </>
  );
}
```

Add print CSS to global styles or component:
```css
@media print {
  .print\\:hidden { display: none !important; }
  .table-card { page-break-inside: avoid; break-inside: avoid; }
  @page { margin: 0.5in; size: letter portrait; }
}
```

Mark page as client component for window.print() or use a client button component.
  </action>
  <verify>
Page loads at /dashboard/seating/print.
Clicking print button opens browser print dialog.
Print preview shows clean layout without screen-only elements.
  </verify>
  <done>Print view displays all tables with guests. Browser print produces clean output with proper page breaks.</done>
</task>

<task type="auto">
  <name>Task 2: Create CSV export endpoint</name>
  <files>wedding-platform/src/app/api/seating/export/route.ts</files>
  <action>
Create Route Handler following RSVP export pattern:

```typescript
import { NextResponse } from "next/server";
import { auth } from "@/lib/auth/auth";
import { prisma, withTenantContext } from "@/lib/db/prisma";
import Papa from "papaparse";

export async function GET() {
  const session = await auth();
  if (!session?.user.tenantId) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const data = await withTenantContext(session.user.tenantId, async () => {
    const tables = await prisma.table.findMany({
      orderBy: { order: "asc" },
      include: {
        seatAssignments: {
          include: {
            guest: {
              include: {
                eventInvitations: {
                  where: { rsvpStatus: "ATTENDING" },
                  select: {
                    plusOneCount: true,
                    mealChoice: true,
                    dietaryNotes: true,
                  },
                },
              },
            },
          },
        },
      },
    });

    return tables.flatMap((table) =>
      table.seatAssignments.map((sa) => ({
        Table: table.name,
        "Guest Name": sa.guest.name,
        "Party Name": sa.guest.partyName ?? "",
        "Headcount": 1 + (sa.guest.eventInvitations[0]?.plusOneCount ?? 0),
        "Meal Choice": sa.guest.eventInvitations[0]?.mealChoice ?? "",
        "Dietary Notes": sa.guest.eventInvitations[0]?.dietaryNotes ?? "",
      }))
    );
  });

  const csv = Papa.unparse(data);

  return new NextResponse(csv, {
    headers: {
      "Content-Type": "text/csv",
      "Content-Disposition": `attachment; filename="seating-chart.csv"`,
    },
  });
}
```

Add download link to print page or main seating page.
  </action>
  <verify>
GET /api/seating/export returns CSV file download.
CSV includes Table, Guest Name, Party, Headcount, Meal, Dietary columns.
  </verify>
  <done>CSV export endpoint returns seating data with meal information for venue catering.</done>
</task>

<task type="auto">
  <name>Task 3: Create guest seating page and update dashboard nav</name>
  <files>
wedding-platform/src/app/[domain]/seating/page.tsx
wedding-platform/src/app/(platform)/dashboard/layout.tsx
  </files>
  <action>
**Guest seating page ([domain]/seating/page.tsx):**

Follow RSVP page pattern for guest authentication:
```typescript
import { cookies } from "next/headers";
import { notFound } from "next/navigation";

interface PageProps {
  params: Promise<{ domain: string }>;
}

export default async function GuestSeatingPage({ params }: PageProps) {
  const { domain } = await params;

  // Get wedding by subdomain
  const wedding = await getWeddingByDomain(domain);
  if (!wedding) notFound();

  // Check RSVP cookie for guest authentication
  const cookieStore = await cookies();
  const guestId = cookieStore.get(`rsvp_guest_${wedding.id}`)?.value;

  if (!guestId) {
    return (
      <div className="text-center py-12">
        <h2 className="text-xl font-semibold mb-2">View Your Table Assignment</h2>
        <p className="text-gray-600 mb-4">Please RSVP first to see your table assignment.</p>
        <Link href={`/${domain}/rsvp`} className="text-blue-600 hover:underline">
          Go to RSVP
        </Link>
      </div>
    );
  }

  // Get guest's table assignment
  const assignment = await prisma.seatAssignment.findUnique({
    where: { guestId },
    include: { table: true },
  });

  if (!assignment) {
    return (
      <div className="text-center py-12">
        <h2 className="text-xl font-semibold mb-2">Table Assignment Pending</h2>
        <p className="text-gray-600">
          Your table assignment will be available closer to the wedding date.
        </p>
      </div>
    );
  }

  // Show table assignment with wedding theme styling
  return (
    <div className="text-center py-12">
      <p className="text-sm uppercase tracking-wider text-wedding-secondary mb-2">
        Your Table
      </p>
      <h2 className="text-4xl font-wedding-heading text-wedding-primary">
        {assignment.table.name}
      </h2>
    </div>
  );
}
```

Apply wedding theme via ThemeProvider (check [domain]/layout.tsx pattern).

**Dashboard layout update:**
Add Seating to navItems array:
```typescript
import { Grid3X3 } from "lucide-react"; // or Users icon variant

// In navItems array, add after RSVPs:
{ href: "/dashboard/seating", label: "Seating", icon: Grid3X3 },
```
  </action>
  <verify>
/dashboard/seating appears in dashboard navigation.
Guest without RSVP sees prompt to RSVP first.
Guest with RSVP but no assignment sees "pending" message.
Guest with assignment sees their table name styled with wedding theme.
  </verify>
  <done>
Guest seating page shows table assignment for RSVP'd guests.
Dashboard navigation includes Seating link.
Unauthenticated guests directed to RSVP flow.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. /dashboard/seating/print shows print-optimized view
3. Browser print dialog produces clean PDF
4. GET /api/seating/export downloads CSV file
5. Dashboard nav shows Seating link with icon
6. Guest at /{domain}/seating sees their table (if assigned) or pending message
7. Guest without RSVP cookie sees prompt to RSVP
</verification>

<success_criteria>
- Print view renders all tables in clean layout
- window.print() works, PDF output is venue-ready
- CSV export includes table, guest, headcount, meal, dietary info
- Guest seating page respects RSVP authentication
- Dashboard navigation updated with Seating item
</success_criteria>

<output>
After completion, create `.planning/phases/09-seating-chart/09-03-SUMMARY.md`
</output>
