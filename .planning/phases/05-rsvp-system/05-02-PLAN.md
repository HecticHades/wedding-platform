---
phase: 05-rsvp-system
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/[domain]/rsvp/page.tsx
  - src/app/[domain]/rsvp/actions.ts
  - src/components/rsvp/RsvpCodeEntry.tsx
  - src/components/rsvp/GuestLookup.tsx
autonomous: true

must_haves:
  truths:
    - "Guest can enter RSVP code to authenticate"
    - "Guest can search for their name after code validation"
    - "Guest is redirected to their RSVP form after identification"
    - "Invalid RSVP code shows error message"
    - "Weddings without RSVP code go directly to guest lookup"
  artifacts:
    - path: "src/app/[domain]/rsvp/page.tsx"
      provides: "RSVP entry point page"
      min_lines: 30
    - path: "src/app/[domain]/rsvp/actions.ts"
      provides: "RSVP authentication server actions"
      exports: ["validateRsvpCode", "searchGuests"]
    - path: "src/components/rsvp/RsvpCodeEntry.tsx"
      provides: "RSVP code input form"
      min_lines: 40
    - path: "src/components/rsvp/GuestLookup.tsx"
      provides: "Guest name search form"
      min_lines: 50
  key_links:
    - from: "src/app/[domain]/rsvp/page.tsx"
      to: "RsvpCodeEntry or GuestLookup"
      via: "conditional render based on cookie/rsvpCode"
      pattern: "rsvpCode.*RsvpCodeEntry|GuestLookup"
    - from: "src/components/rsvp/RsvpCodeEntry.tsx"
      to: "validateRsvpCode action"
      via: "form action"
      pattern: "validateRsvpCode"
---

<objective>
Build guest RSVP code authentication and name lookup flow.

Purpose: Guests access their RSVP form by entering the wedding's RSVP code (printed on invitation) and searching for their name. This is the entry point for the guest RSVP experience (RSVP-01).

Output: Working /rsvp page with code entry, name search, and redirect to /rsvp/[guestId].
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/05-rsvp-system/05-RESEARCH.md

# Existing tenant domain pattern
@wedding-platform/src/app/[domain]/page.tsx
@wedding-platform/src/app/[domain]/layout.tsx

# Guest model for name lookup
@wedding-platform/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RSVP server actions</name>
  <files>src/app/[domain]/rsvp/actions.ts</files>
  <action>
    Create src/app/[domain]/rsvp/actions.ts with:

    1. **validateRsvpCode(weddingId: string, code: string)**
       - Fetch wedding by id, compare rsvpCode
       - If valid: set httpOnly cookie `rsvp_auth_{weddingId}` with code value
       - Cookie: httpOnly, secure in prod, sameSite: lax, maxAge: 30 days
       - Return { valid: true } or { valid: false, error: "Invalid code" }

    2. **searchGuests(weddingId: string, searchName: string)**
       - Query guests with name containing searchName (case insensitive)
       - Use Prisma `contains` with `mode: "insensitive"`
       - Return array of { id, name, partyName } limited to 10 results
       - Only search guests for this specific wedding

    3. **getWeddingByDomain(domain: string)**
       - Lookup tenant by subdomain
       - Return wedding with rsvpCode for the page to decide which flow

    Use "use server" directive. Use cookies() from next/headers for cookie operations.
    Import prisma directly (not withTenantContext - this is guest-facing, not couple dashboard).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - validateRsvpCode, searchGuests, getWeddingByDomain exported
  </verify>
  <done>Server actions for RSVP code validation and guest search are implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create RSVP code entry and guest lookup components</name>
  <files>src/components/rsvp/RsvpCodeEntry.tsx, src/components/rsvp/GuestLookup.tsx</files>
  <action>
    1. Create src/components/rsvp/RsvpCodeEntry.tsx:
       - Client component with "use client"
       - Props: { weddingId: string; onSuccess: () => void }
       - Form with single text input for RSVP code
       - Submit calls validateRsvpCode server action
       - On success, call onSuccess callback to refresh page
       - On error, show error message
       - Use useTransition for loading state
       - Style with Tailwind: centered card, wedding-themed colors

    2. Create src/components/rsvp/GuestLookup.tsx:
       - Client component with "use client"
       - Props: { weddingId: string }
       - Text input for name search
       - Debounced search (300ms) using useState + useEffect
       - Display matching guests as clickable cards
       - On guest select, redirect to /rsvp/{guestId} using router.push
       - Show "No guests found" message if search has results but no matches
       - Show helpful text: "Enter your name as it appears on your invitation"
       - Style with Tailwind: search input at top, results as cards below
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - RsvpCodeEntry component exists with form
    - GuestLookup component exists with search functionality
  </verify>
  <done>RSVP code entry form and guest name lookup search are implemented</done>
</task>

<task type="auto">
  <name>Task 3: Create RSVP entry page</name>
  <files>src/app/[domain]/rsvp/page.tsx</files>
  <action>
    Create src/app/[domain]/rsvp/page.tsx:

    1. Server component (async)
    2. Get domain from params
    3. Call getWeddingByDomain to fetch wedding
    4. If no wedding found, return notFound()
    5. Check for existing RSVP auth cookie using cookies()
    6. Render logic:
       - If wedding has no rsvpCode: show GuestLookup directly
       - If wedding has rsvpCode AND cookie matches: show GuestLookup
       - If wedding has rsvpCode AND no/wrong cookie: show RsvpCodeEntry
    7. Wrap in RsvpPageClient for state management between code entry and lookup

    Create wrapper client component RsvpPageClient:
    - Manages authenticated state
    - When RsvpCodeEntry succeeds, switch to showing GuestLookup
    - Use router.refresh() to re-run server component after cookie set

    Page layout:
    - Centered container
    - Wedding couple names at top
    - Wedding date if available
    - Form component below
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Page renders at /rsvp on tenant subdomain
    - Page shows code entry when rsvpCode is set and not authenticated
    - Page shows guest lookup when authenticated or no rsvpCode
  </verify>
  <done>RSVP page correctly shows code entry or guest lookup based on authentication state</done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes
- [ ] /rsvp page loads on tenant subdomain
- [ ] Wedding with rsvpCode shows code entry form
- [ ] Valid code sets cookie and shows guest lookup
- [ ] Invalid code shows error message
- [ ] Wedding without rsvpCode goes directly to guest lookup
- [ ] Guest search returns matching guests
- [ ] Clicking guest redirects to /rsvp/[guestId]
</verification>

<success_criteria>
1. Guest can navigate to {subdomain}/rsvp
2. If RSVP code required, guest enters code and is authenticated via cookie
3. Guest searches for their name and sees matching results
4. Guest selects their name and is redirected to /rsvp/[guestId]
</success_criteria>

<output>
After completion, create `.planning/phases/05-rsvp-system/05-02-SUMMARY.md`
</output>
