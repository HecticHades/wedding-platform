---
phase: 05-rsvp-system
plan: 04
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - src/app/(platform)/dashboard/rsvp/page.tsx
  - src/app/(platform)/dashboard/rsvp/actions.ts
  - src/components/rsvp/RsvpDashboard.tsx
  - src/components/rsvp/RsvpGuestList.tsx
  - src/app/(platform)/dashboard/events/[id]/meal-options/page.tsx
  - src/components/rsvp/MealOptionsEditor.tsx
  - src/lib/rsvp/rsvp-utils.ts
autonomous: true

must_haves:
  truths:
    - "Couple can view RSVP dashboard with attendance summary"
    - "Dashboard shows total invited, responded, attending, declined counts"
    - "Dashboard shows meal choice tallies per event"
    - "Couple can see list of guest responses with details"
    - "Couple can set RSVP code for their wedding"
    - "Couple can configure meal options per event"
  artifacts:
    - path: "src/app/(platform)/dashboard/rsvp/page.tsx"
      provides: "RSVP dashboard page"
      min_lines: 40
    - path: "src/lib/rsvp/rsvp-utils.ts"
      provides: "RSVP statistics calculation utilities"
      exports: ["getRsvpStats", "getRsvpStatsPerEvent"]
    - path: "src/components/rsvp/RsvpDashboard.tsx"
      provides: "RSVP statistics display component"
      min_lines: 60
    - path: "src/components/rsvp/RsvpGuestList.tsx"
      provides: "List of guest RSVP responses"
      min_lines: 80
    - path: "src/components/rsvp/MealOptionsEditor.tsx"
      provides: "Meal options configuration UI"
      min_lines: 60
  key_links:
    - from: "src/app/(platform)/dashboard/rsvp/page.tsx"
      to: "getRsvpStats"
      via: "server data fetch"
      pattern: "getRsvpStats"
    - from: "src/components/rsvp/RsvpDashboard.tsx"
      to: "RsvpGuestList"
      via: "child component"
      pattern: "RsvpGuestList"
---

<objective>
Build the couple-facing RSVP dashboard with statistics, guest response list, and meal options configuration.

Purpose: Couples need to see who has responded, track attendance counts, see meal tallies for catering, and configure meal options per event. This implements COUPLE-05, COUPLE-07, and RSVP-06.

Output: Working /dashboard/rsvp page with stats, guest list, and /dashboard/events/[id]/meal-options for meal configuration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/05-rsvp-system/05-RESEARCH.md

# Existing dashboard patterns
@wedding-platform/src/app/(platform)/dashboard/page.tsx
@wedding-platform/src/app/(platform)/dashboard/events/actions.ts
@wedding-platform/src/app/(platform)/dashboard/guests/page.tsx

# Tenant context for couple queries
@wedding-platform/src/lib/db/prisma.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RSVP statistics utilities and server actions</name>
  <files>src/lib/rsvp/rsvp-utils.ts, src/app/(platform)/dashboard/rsvp/actions.ts</files>
  <action>
    1. Create src/lib/rsvp/rsvp-utils.ts:

       **getRsvpStats(tenantId: string): Promise<RsvpStats>**
       - Use withTenantContext for tenant isolation
       - Query all EventGuest records for this wedding's events
       - Calculate and return:
         ```typescript
         interface RsvpStats {
           totalInvited: number;      // Total EventGuest records
           totalResponded: number;    // Where rsvpStatus is not null
           attending: number;         // ATTENDING count
           declined: number;          // DECLINED count
           pending: number;           // No response yet
           totalHeadcount: number;    // Attending guests + their plus-ones
         }
         ```

       **getRsvpStatsPerEvent(tenantId: string): Promise<EventRsvpStats[]>**
       - Returns per-event breakdown with meal tallies:
         ```typescript
         interface EventRsvpStats {
           eventId: string;
           eventName: string;
           eventDate: Date;
           invited: number;
           attending: number;
           declined: number;
           pending: number;
           headcount: number;  // With plus-ones
           mealCounts: Record<string, number>;  // mealChoice -> count
         }
         ```

    2. Create src/app/(platform)/dashboard/rsvp/actions.ts:

       **setRsvpCode(code: string)**
       - Validate code is 4-20 alphanumeric characters
       - Update wedding.rsvpCode using withTenantContext
       - Return { success: true } or { success: false, error: string }

       **getRsvpGuestList()**
       - Fetch all guests with their eventInvitations
       - Return list with: guestName, partyName, email, phone
       - For each event: rsvpStatus, plusOneCount, mealChoice, dietaryNotes
       - Order by guest name

    Use "use server" directive where needed.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - getRsvpStats returns aggregated statistics
    - getRsvpStatsPerEvent returns per-event breakdown
    - setRsvpCode updates wedding record
  </verify>
  <done>RSVP statistics utilities and dashboard server actions are implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create RSVP dashboard page and components</name>
  <files>src/app/(platform)/dashboard/rsvp/page.tsx, src/components/rsvp/RsvpDashboard.tsx, src/components/rsvp/RsvpGuestList.tsx</files>
  <action>
    1. Create src/components/rsvp/RsvpDashboard.tsx:
       - Props: { stats: RsvpStats; perEventStats: EventRsvpStats[]; currentRsvpCode: string | null }
       - Display overall stats in card grid:
         - Total Invited, Responded, Pending
         - Attending count with headcount (e.g., "45 guests + 12 plus-ones = 57 total")
         - Declined count
       - Per-event accordion/tabs showing:
         - Event name and date
         - Attendance breakdown (pie chart or progress bars)
         - Meal tallies table
       - RSVP code section:
         - Show current code or "Not set"
         - Form to set/change code
         - Copy code button
         - RSVP link preview: "{subdomain}.domain.com/rsvp"

    2. Create src/components/rsvp/RsvpGuestList.tsx:
       - Props: { guests: RsvpGuest[] }
       - Filterable/searchable table of guests
       - Columns: Name, Party, Status, Events, Meal, Dietary Notes
       - Status column shows colored badge (green=attending, red=declined, gray=pending)
       - Filter by status (All, Attending, Declined, Pending)
       - Expandable row to show per-event details if guest has multiple events
       - Use client-side search (small guest lists)

    3. Create src/app/(platform)/dashboard/rsvp/page.tsx:
       - Server component with auth check (requireRole "couple")
       - Fetch stats using getRsvpStats and getRsvpStatsPerEvent
       - Fetch guest list using getRsvpGuestList
       - Fetch current RSVP code from wedding
       - Render RsvpDashboard with stats
       - Render RsvpGuestList below
       - Add "Export CSV" button (links to Plan 05 route)
       - Add "Send Reminders" button (links to Plan 05)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - /dashboard/rsvp page loads with auth check
    - Stats cards show correct aggregations
    - Guest list displays all guests with RSVP info
    - RSVP code can be set/updated
  </verify>
  <done>RSVP dashboard with statistics and guest list is implemented</done>
</task>

<task type="auto">
  <name>Task 3: Create meal options configuration page</name>
  <files>src/app/(platform)/dashboard/events/[id]/meal-options/page.tsx, src/components/rsvp/MealOptionsEditor.tsx, src/app/(platform)/dashboard/events/actions.ts</files>
  <action>
    1. Add to src/app/(platform)/dashboard/events/actions.ts:

       **updateMealOptions(eventId: string, mealOptions: MealOption[])**
       - Validate each option has id and name
       - Validate no duplicate ids
       - Update event.mealOptions JSON field
       - Use withTenantContext for security
       - Return { success: true } or { success: false, error: string }

    2. Create src/components/rsvp/MealOptionsEditor.tsx:
       - Client component ("use client")
       - Props: { eventId: string; initialOptions: MealOption[] }
       - List of meal options with:
         - Name input (required)
         - Description input (optional)
         - Delete button per option
         - Drag handle for reordering (or move up/down buttons)
       - "Add Option" button to add new option (generates UUID for id)
       - "Save" button to call updateMealOptions
       - Use useTransition for loading state
       - Show success/error toast after save

    3. Create src/app/(platform)/dashboard/events/[id]/meal-options/page.tsx:
       - Server component with auth check
       - Fetch event by id with tenant context
       - If event not found, notFound()
       - Breadcrumb: Dashboard > Events > [Event Name] > Meal Options
       - Back link to event detail page
       - Render MealOptionsEditor with current options
       - Helper text: "Configure meal choices guests can select when RSVPing to this event"
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - /dashboard/events/[id]/meal-options page loads
    - Meal options can be added, edited, reordered, deleted
    - Saving updates the Event.mealOptions field
    - Options appear in guest RSVP form
  </verify>
  <done>Meal options configuration per event is implemented</done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes
- [ ] /dashboard/rsvp page shows RSVP statistics
- [ ] Stats include total, attending, declined, pending counts
- [ ] Per-event stats show meal tallies
- [ ] Guest list shows all guests with their RSVP status
- [ ] RSVP code can be set and displayed
- [ ] /dashboard/events/[id]/meal-options allows meal configuration
- [ ] Configured meals appear in guest RSVP form
</verification>

<success_criteria>
1. Couple can view RSVP dashboard with attendance summary (COUPLE-07)
2. Dashboard shows per-event breakdown with meal tallies
3. Couple can see and filter list of guest responses
4. Couple can set their wedding's RSVP code (COUPLE-05)
5. Couple can configure meal options per event (RSVP-06)
</success_criteria>

<output>
After completion, create `.planning/phases/05-rsvp-system/05-04-SUMMARY.md`
</output>
