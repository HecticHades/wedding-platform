---
phase: 05-rsvp-system
plan: 06
type: execute
wave: 4
depends_on: ["05-04"]
files_modified:
  - src/app/(platform)/admin/rsvp/page.tsx
  - src/app/(platform)/admin/rsvp/actions.ts
  - src/components/admin/AdminRsvpOverview.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view RSVP data across all weddings"
    - "Admin sees summary per wedding: couple names, guest count, response rate"
    - "Admin can drill down into individual wedding RSVP details"
    - "Admin view does NOT use tenant context (sees all data)"
  artifacts:
    - path: "src/app/(platform)/admin/rsvp/page.tsx"
      provides: "Admin RSVP overview page"
      min_lines: 40
    - path: "src/app/(platform)/admin/rsvp/actions.ts"
      provides: "Admin RSVP data queries"
      exports: ["getAdminRsvpOverview"]
    - path: "src/components/admin/AdminRsvpOverview.tsx"
      provides: "Admin RSVP summary table"
      min_lines: 60
  key_links:
    - from: "src/app/(platform)/admin/rsvp/page.tsx"
      to: "getAdminRsvpOverview"
      via: "server data fetch"
      pattern: "getAdminRsvpOverview"
    - from: "src/app/(platform)/admin/rsvp/actions.ts"
      to: "prisma (no tenant context)"
      via: "direct query"
      pattern: "prisma\\.wedding\\.findMany"
---

<objective>
Build admin cross-wedding RSVP view for platform-wide visibility.

Purpose: Platform admins need to monitor RSVP activity across all weddings to identify issues, track platform usage, and assist couples. This implements ADMIN-03.

Output: Working /admin/rsvp page showing RSVP summary for all weddings.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/05-rsvp-system/05-RESEARCH.md

# Existing admin patterns (no tenant context)
@wedding-platform/src/app/(platform)/admin/page.tsx
@wedding-platform/src/app/(platform)/admin/weddings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin RSVP server actions</name>
  <files>src/app/(platform)/admin/rsvp/actions.ts</files>
  <action>
    Create src/app/(platform)/admin/rsvp/actions.ts:

    **getAdminRsvpOverview()**
    - IMPORTANT: Do NOT use withTenantContext - admin sees all weddings
    - Import prisma directly from @/lib/db/prisma
    - Query all weddings with aggregated RSVP data:
      ```typescript
      const weddings = await prisma.wedding.findMany({
        select: {
          id: true,
          partner1Name: true,
          partner2Name: true,
          weddingDate: true,
          rsvpCode: true,
          tenant: {
            select: { subdomain: true },
          },
          _count: {
            select: { guests: true },
          },
          events: {
            select: {
              id: true,
              name: true,
              _count: {
                select: { guestInvitations: true },
              },
              guestInvitations: {
                select: { rsvpStatus: true },
              },
            },
          },
        },
        orderBy: { createdAt: "desc" },
      });
      ```

    - Transform to summary format:
      ```typescript
      interface AdminWeddingRsvpSummary {
        weddingId: string;
        subdomain: string;
        coupleNames: string;
        weddingDate: Date | null;
        hasRsvpCode: boolean;
        totalGuests: number;
        totalInvitations: number;  // Sum of EventGuest records
        responded: number;         // Non-null rsvpStatus
        attending: number;
        declined: number;
        responseRate: number;      // (responded / totalInvitations) * 100
      }
      ```

    - Return array ordered by wedding date (upcoming first, then by response rate)

    Use "use server" directive. No tenant context needed for admin queries.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - getAdminRsvpOverview returns all weddings with RSVP stats
    - Query does NOT use withTenantContext
  </verify>
  <done>Admin RSVP overview query returns platform-wide data</done>
</task>

<task type="auto">
  <name>Task 2: Create admin RSVP overview component</name>
  <files>src/components/admin/AdminRsvpOverview.tsx</files>
  <action>
    Create src/components/admin/AdminRsvpOverview.tsx:

    1. Props: { weddings: AdminWeddingRsvpSummary[] }

    2. Table with columns:
       - Subdomain (link to couple's site)
       - Couple Names
       - Wedding Date
       - Guests (total count)
       - Invitations (EventGuest count)
       - Responded / Pending
       - Response Rate (progress bar + percentage)
       - RSVP Code Status (Set / Not Set badge)

    3. Features:
       - Sortable columns (click header to sort)
       - Search/filter by couple name or subdomain
       - Color-coded response rate:
         - Green: > 80%
         - Yellow: 50-80%
         - Red: < 50%
       - "View Details" link to /admin/weddings/[id] (existing page)

    4. Summary row at top:
       - Total weddings
       - Total guests across platform
       - Average response rate

    5. Styling:
       - Use existing admin table patterns
       - Consistent with other admin pages
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Component renders table with all required columns
    - Response rate shows visual indicator
  </verify>
  <done>Admin RSVP overview table component is implemented</done>
</task>

<task type="auto">
  <name>Task 3: Create admin RSVP page</name>
  <files>src/app/(platform)/admin/rsvp/page.tsx</files>
  <action>
    Create src/app/(platform)/admin/rsvp/page.tsx:

    1. Server component (async)
    2. Auth check: session.user.role === "admin" (return redirect to /login if not)
    3. Call getAdminRsvpOverview() to fetch data
    4. Render page with:
       - Page title: "RSVP Overview"
       - Breadcrumb: Admin > RSVP Overview
       - Platform-wide summary stats (cards):
         - Total Weddings with RSVPs
         - Total Guests Invited
         - Total Responses
         - Average Response Rate
       - AdminRsvpOverview table below

    5. Add link to admin sidebar/navigation:
       - Add "RSVP Overview" link to admin navigation (if exists)
       - Or add navigation link from admin dashboard

    6. Handle empty state:
       - "No weddings with guests yet"
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - /admin/rsvp page loads for admin users only
    - Page shows all weddings with RSVP stats
    - Non-admin users are redirected
  </verify>
  <done>Admin RSVP overview page with cross-wedding visibility is complete</done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes
- [ ] /admin/rsvp page requires admin role
- [ ] Page shows all weddings (not filtered by tenant)
- [ ] Each wedding shows guest count, response count, rate
- [ ] Response rate has visual indicator
- [ ] Weddings can be sorted and filtered
- [ ] Links work to view individual wedding details
</verification>

<success_criteria>
1. Admin can access /admin/rsvp page (ADMIN-03)
2. Page shows RSVP summary for ALL weddings on platform
3. Each wedding displays: couple names, guest count, response rate
4. Data is NOT filtered by tenant context
5. Admin can identify weddings with low response rates
</success_criteria>

<output>
After completion, create `.planning/phases/05-rsvp-system/05-06-SUMMARY.md`
</output>
