---
phase: 05-rsvp-system
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - src/app/[domain]/rsvp/[guestId]/page.tsx
  - src/app/[domain]/rsvp/[guestId]/actions.ts
  - src/components/rsvp/EventRsvpForm.tsx
  - src/components/rsvp/RsvpConfirmation.tsx
autonomous: true

must_haves:
  truths:
    - "Guest can see all events they are invited to"
    - "Guest can confirm attendance (yes/no) for each event"
    - "Guest can indicate plus-one count and name if allowed"
    - "Guest can select meal preference from event-specific options"
    - "Guest can enter dietary restrictions as free text"
    - "Guest sees confirmation after submitting RSVP"
  artifacts:
    - path: "src/app/[domain]/rsvp/[guestId]/page.tsx"
      provides: "Guest RSVP form page"
      min_lines: 50
    - path: "src/app/[domain]/rsvp/[guestId]/actions.ts"
      provides: "RSVP submission server action"
      exports: ["submitRsvp", "getGuestWithEvents"]
    - path: "src/components/rsvp/EventRsvpForm.tsx"
      provides: "Per-event RSVP form component"
      min_lines: 80
    - path: "src/components/rsvp/RsvpConfirmation.tsx"
      provides: "RSVP success confirmation component"
      min_lines: 30
  key_links:
    - from: "src/components/rsvp/EventRsvpForm.tsx"
      to: "submitRsvp action"
      via: "form action"
      pattern: "submitRsvp"
    - from: "src/app/[domain]/rsvp/[guestId]/page.tsx"
      to: "getGuestWithEvents"
      via: "data fetch"
      pattern: "getGuestWithEvents"
---

<objective>
Build the guest RSVP submission form for per-event attendance, meal selection, and dietary notes.

Purpose: After identifying themselves, guests submit their RSVP for each event they're invited to. This implements RSVP-02 (attendance), RSVP-03 (plus-one), RSVP-04 (meal), and RSVP-05 (dietary restrictions).

Output: Working /rsvp/[guestId] page where guests complete their RSVP for all invited events.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/05-rsvp-system/05-RESEARCH.md

# RSVP flow context
@wedding-platform/.planning/phases/05-rsvp-system/05-02-PLAN.md

# EventGuest model with RSVP fields
@wedding-platform/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RSVP submission server actions</name>
  <files>src/app/[domain]/rsvp/[guestId]/actions.ts</files>
  <action>
    Create src/app/[domain]/rsvp/[guestId]/actions.ts with:

    1. **getGuestWithEvents(guestId: string)**
       - Fetch guest by id with wedding info
       - Include eventInvitations with event details (including mealOptions)
       - Return guest name, wedding couple names, and list of events with:
         - Event info (id, name, dateTime, location, mealOptions)
         - Current RSVP status (if already submitted)
         - Whether guest.allowPlusOne is true
       - Return null if guest not found

    2. **submitRsvp(guestId: string, formData: FormData)**
       - Parse form data with Zod schema:
         ```typescript
         const rsvpSchema = z.object({
           eventId: z.string(),
           rsvpStatus: z.enum(["ATTENDING", "DECLINED"]),
           plusOneCount: z.coerce.number().int().min(0).max(10).optional(),
           plusOneName: z.string().optional().transform(v => v === "" ? null : v),
           mealChoice: z.string().optional().transform(v => v === "" ? null : v),
           dietaryNotes: z.string().max(500).optional().transform(v => v === "" ? null : v),
         });
         ```
       - Update EventGuest record with rsvpStatus, rsvpAt (now), plusOneCount, plusOneName, mealChoice, dietaryNotes
       - Use prisma.eventGuest.update with compound key { eventId_guestId: { eventId, guestId } }
       - Return { success: true } or { success: false, error: string }
       - Validate guest owns this EventGuest record (security)

    Use "use server" directive. Import prisma directly.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - getGuestWithEvents returns guest with events
    - submitRsvp updates EventGuest record
  </verify>
  <done>Server actions for fetching guest events and submitting RSVP are implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create per-event RSVP form component</name>
  <files>src/components/rsvp/EventRsvpForm.tsx</files>
  <action>
    Create src/components/rsvp/EventRsvpForm.tsx:

    1. Client component ("use client")
    2. Props interface:
       ```typescript
       interface EventRsvpFormProps {
         event: {
           id: string;
           name: string;
           dateTime: Date;
           location: string | null;
           mealOptions: MealOption[];
         };
         guestId: string;
         allowPlusOne: boolean;
         currentRsvp?: {
           rsvpStatus: RsvpStatus | null;
           plusOneCount: number | null;
           plusOneName: string | null;
           mealChoice: string | null;
           dietaryNotes: string | null;
         };
         onSubmitted: () => void;
       }
       ```

    3. Form fields:
       - **Attendance:** Radio buttons for "Joyfully Accept" / "Regretfully Decline"
       - **Plus-one section:** (only if allowPlusOne)
         - Number input for count (0-5)
         - Text input for plus-one name(s)
       - **Meal selection:** (only if event has mealOptions.length > 0 AND attending)
         - Radio buttons for each meal option with name and description
       - **Dietary restrictions:** (only if attending)
         - Textarea for free-text dietary notes

    4. Form submission:
       - Use useTransition for loading state
       - Call submitRsvp server action
       - On success, call onSubmitted callback
       - On error, show error message

    5. Styling:
       - Card container for each event
       - Event name and date as header
       - Location below date
       - Fields stacked vertically with clear labels
       - Submit button per event
       - Show "Response saved" checkmark if already submitted

    Pre-populate form with currentRsvp values if guest already responded.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - EventRsvpForm component renders event info
    - Form has attendance, plus-one, meal, and dietary fields
    - Form submits to submitRsvp action
  </verify>
  <done>Per-event RSVP form component with all required fields is implemented</done>
</task>

<task type="auto">
  <name>Task 3: Create RSVP page and confirmation component</name>
  <files>src/app/[domain]/rsvp/[guestId]/page.tsx, src/components/rsvp/RsvpConfirmation.tsx</files>
  <action>
    1. Create src/components/rsvp/RsvpConfirmation.tsx:
       - Props: { guestName: string; coupleNames: string; eventsCount: number }
       - Thank you message with guest name
       - "Your response has been recorded" text
       - Summary: "You have responded to X event(s)"
       - Link back to wedding homepage

    2. Create src/app/[domain]/rsvp/[guestId]/page.tsx:
       - Server component (async)
       - Get guestId from params, domain for wedding info
       - Call getGuestWithEvents(guestId)
       - If guest not found, return notFound()
       - Verify guest belongs to this wedding (security: check wedding.tenant.subdomain === domain)

       Render RsvpFormPage client component with:
       - Guest name greeting ("Hi [Name]!")
       - Wedding couple names
       - List of EventRsvpForm components (one per invited event)
       - State to track completed submissions
       - When all events have been responded to (or were already), show option to review/change

    3. Page layout:
       - Centered container (max-w-2xl)
       - Guest greeting at top
       - "Please respond by [deadline]" if wedding has RSVP deadline (future enhancement)
       - Events listed in chronological order
       - Each event in its own card with EventRsvpForm
       - Progress indicator: "1 of 3 events responded"
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Page loads at /rsvp/[guestId]
    - Page shows all events guest is invited to
    - Each event has its own RSVP form
    - Submitting form updates the event's RSVP status
    - Confirmation shows after all responses
  </verify>
  <done>Guest RSVP page with per-event forms and confirmation is complete</done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes
- [ ] /rsvp/[guestId] page loads with guest's events
- [ ] Each event shows RSVP form with attendance options
- [ ] Attending shows meal selection (if options exist) and dietary field
- [ ] Plus-one fields appear if guest.allowPlusOne is true
- [ ] Form submission updates EventGuest record in database
- [ ] Already-submitted responses show current values
- [ ] Guest can update their response
</verification>

<success_criteria>
1. Guest sees all events they're invited to
2. Guest can confirm attendance (ATTENDING/DECLINED) per event
3. Guest can specify plus-one count and name(s) if allowed
4. Guest can select meal from event-specific options
5. Guest can enter dietary restrictions
6. Responses are saved to EventGuest records with rsvpAt timestamp
</success_criteria>

<output>
After completion, create `.planning/phases/05-rsvp-system/05-03-SUMMARY.md`
</output>
