---
phase: 05-rsvp-system
plan: 05
type: execute
wave: 4
depends_on: ["05-04"]
files_modified:
  - src/app/(platform)/api/export/rsvp/route.ts
  - src/lib/rsvp/export-utils.ts
  - src/components/emails/RsvpReminderEmail.tsx
  - src/app/(platform)/dashboard/rsvp/actions.ts
autonomous: true

must_haves:
  truths:
    - "Couple can download RSVP data as CSV file"
    - "CSV includes guest name, email, phone, event, status, meal, dietary notes"
    - "Couple can send reminder emails to guests who haven't responded"
    - "Reminder email includes RSVP link to wedding site"
    - "Only guests with email addresses receive reminders"
  artifacts:
    - path: "src/app/(platform)/api/export/rsvp/route.ts"
      provides: "CSV export API endpoint"
      exports: ["GET"]
    - path: "src/lib/rsvp/export-utils.ts"
      provides: "CSV generation utilities"
      exports: ["generateRsvpCsv"]
    - path: "src/components/emails/RsvpReminderEmail.tsx"
      provides: "React Email reminder template"
      min_lines: 40
  key_links:
    - from: "src/app/(platform)/api/export/rsvp/route.ts"
      to: "papaparse"
      via: "CSV generation"
      pattern: "Papa.unparse|papaparse"
    - from: "src/app/(platform)/dashboard/rsvp/actions.ts"
      to: "resend.batch.send"
      via: "email sending"
      pattern: "resend.*send"
---

<objective>
Implement CSV export of RSVP data and email reminder functionality for non-responders.

Purpose: Couples need to export RSVP data for catering, seating, and planning (COUPLE-08). They also need to remind guests who haven't responded (RSVP-07).

Output: Working CSV export endpoint and reminder email sending with React Email templates.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@wedding-platform/.planning/PROJECT.md
@wedding-platform/.planning/ROADMAP.md
@wedding-platform/.planning/STATE.md
@wedding-platform/.planning/phases/05-rsvp-system/05-RESEARCH.md

# Resend client from Plan 01
@wedding-platform/src/lib/email/resend.ts

# RSVP dashboard context
@wedding-platform/.planning/phases/05-rsvp-system/05-04-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV export Route Handler</name>
  <files>src/app/(platform)/api/export/rsvp/route.ts, src/lib/rsvp/export-utils.ts</files>
  <action>
    1. Create src/lib/rsvp/export-utils.ts:

       **generateRsvpCsv(guests: RsvpExportData[]): string**
       - Use Papa.unparse() from papaparse
       - Input shape:
         ```typescript
         interface RsvpExportData {
           guestName: string;
           email: string | null;
           phone: string | null;
           partyName: string | null;
           eventName: string;
           rsvpStatus: string;
           plusOneCount: number;
           plusOneName: string | null;
           mealChoice: string | null;
           dietaryNotes: string | null;
           respondedAt: string | null;
         }
         ```
       - Column headers: Guest Name, Email, Phone, Party, Event, Status, Plus Ones, Plus One Name, Meal Choice, Dietary Notes, Responded At

    2. Create src/app/(platform)/api/export/rsvp/route.ts:

       **GET handler:**
       - Auth check: session.user.tenantId required (return 401 if not)
       - Use withTenantContext to query wedding and guests
       - Fetch all guests with their eventInvitations (include event for name)
       - Flatten to rows: one row per guest-event combination
       - Generate CSV using generateRsvpCsv
       - Return NextResponse with:
         - Content-Type: text/csv
         - Content-Disposition: attachment; filename="rsvp-export-YYYY-MM-DD.csv"
       - Handle errors gracefully (return 500 with error message)

    **Important:** Route Handlers are better than Server Actions for file downloads.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - GET /api/export/rsvp returns CSV file
    - CSV has correct headers and data
    - Auth check prevents unauthorized access
  </verify>
  <done>CSV export endpoint returns downloadable RSVP data file</done>
</task>

<task type="auto">
  <name>Task 2: Create reminder email template</name>
  <files>src/components/emails/RsvpReminderEmail.tsx</files>
  <action>
    Create src/components/emails/RsvpReminderEmail.tsx using @react-email/components:

    ```typescript
    import {
      Html,
      Head,
      Body,
      Container,
      Section,
      Heading,
      Text,
      Button,
      Link,
      Preview,
      Hr,
    } from "@react-email/components";

    interface RsvpReminderEmailProps {
      guestName: string;
      coupleNames: string;
      weddingDate: string | null;
      rsvpUrl: string;
      eventNames: string[];
    }

    export function RsvpReminderEmail({ ... }: RsvpReminderEmailProps) {
      return (
        <Html>
          <Head />
          <Preview>Please RSVP for {coupleNames}'s wedding</Preview>
          <Body style={{ fontFamily: "Arial, sans-serif", backgroundColor: "#f4f4f4" }}>
            <Container style={{ maxWidth: "600px", margin: "0 auto", backgroundColor: "#ffffff", padding: "40px" }}>
              <Heading as="h1">RSVP Reminder</Heading>
              <Text>Dear {guestName},</Text>
              <Text>
                We noticed you haven't yet responded to the wedding invitation
                from {coupleNames}{weddingDate ? ` on ${weddingDate}` : ""}.
              </Text>
              <Text>You're invited to:</Text>
              <ul>
                {eventNames.map(name => <li key={name}>{name}</li>)}
              </ul>
              <Text>Please take a moment to let them know if you can attend:</Text>
              <Section style={{ textAlign: "center", margin: "32px 0" }}>
                <Button
                  href={rsvpUrl}
                  style={{
                    backgroundColor: "#22c55e",
                    color: "#ffffff",
                    padding: "12px 24px",
                    borderRadius: "6px",
                    textDecoration: "none",
                  }}
                >
                  RSVP Now
                </Button>
              </Section>
              <Hr />
              <Text style={{ fontSize: "12px", color: "#666" }}>
                If you have any questions, please contact the couple directly.
              </Text>
            </Container>
          </Body>
        </Html>
      );
    }
    ```

    Export as named export for use in reminder action.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - RsvpReminderEmail component renders valid HTML
    - All props are properly typed
  </verify>
  <done>RSVP reminder email template with React Email is created</done>
</task>

<task type="auto">
  <name>Task 3: Implement reminder sending action</name>
  <files>src/app/(platform)/dashboard/rsvp/actions.ts</files>
  <action>
    Add to src/app/(platform)/dashboard/rsvp/actions.ts:

    **sendRsvpReminders()**
    - Auth check: session required with tenantId
    - Use withTenantContext for tenant isolation
    - Fetch wedding with tenant subdomain
    - Find guests who:
      - Have email address (not null)
      - Have at least one EventGuest with rsvpStatus = null (not yet responded)
    - For each guest, get list of events they haven't responded to
    - Build email list:
      ```typescript
      const emails = guests.map(guest => ({
        from: "Wedding Platform <noreply@yourdomain.com>",
        to: guest.email!,
        subject: `RSVP Reminder: ${coupleNames}'s Wedding`,
        react: RsvpReminderEmail({
          guestName: guest.name,
          coupleNames: `${wedding.partner1Name} & ${wedding.partner2Name}`,
          weddingDate: wedding.weddingDate?.toLocaleDateString() ?? null,
          rsvpUrl: `https://${wedding.tenant.subdomain}.your-domain.com/rsvp`,
          eventNames: guest.pendingEvents.map(e => e.name),
        }),
      }));
      ```
    - Use resend.batch.send(emails) for bulk sending
    - Handle Resend API errors gracefully
    - Return { success: true, sent: count } or { success: false, error: string }

    **Important considerations:**
    - Skip guests with no email
    - Only remind about events they haven't responded to yet
    - Don't send if no pending guests (return { success: true, sent: 0 })
    - Log reminder count for couple feedback
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - sendRsvpReminders action exists and is exported
    - Action queries only non-responded guests with email
    - Action uses Resend batch send
  </verify>
  <done>Reminder email sending action is implemented</done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes
- [ ] GET /api/export/rsvp returns CSV file with correct headers
- [ ] CSV includes all guest-event combinations
- [ ] RsvpReminderEmail template renders properly
- [ ] sendRsvpReminders finds guests with pending responses
- [ ] Reminders only sent to guests with email addresses
- [ ] Dashboard has Export and Send Reminders buttons (from Plan 04)
</verification>

<success_criteria>
1. Couple can export RSVP data as CSV (COUPLE-08)
2. CSV includes: guest name, email, phone, party, event, status, meal, dietary notes
3. Couple can send reminder to non-responders (RSVP-07)
4. Reminder email includes RSVP link
5. Only guests with email addresses receive reminders
</success_criteria>

<output>
After completion, create `.planning/phases/05-rsvp-system/05-05-SUMMARY.md`
</output>
